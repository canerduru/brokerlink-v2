<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrokerLink - AgentConnect Style</title>
    <!-- Tailwind CSS (CDN for GitHub Pages) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#1e40af',
                        secondary: '#1e3a8a',
                    }
                }
            }
        }
    </script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="shortcut icon" type="image/png" href="favicon.png">

    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1e40af/ffffff.png?text=BL">
    <style>
        /* Alpine.js x-cloak - Hide elements until Alpine loads */
        [x-cloak] {
            display: none !important;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            /* gray-50 */
            margin: 0;
        }

        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Mobile: hide app-layout flex behavior, stack normally */
        @media (max-width: 767px) {
            .app-layout {
                display: block;
                min-height: auto;
            }

            /* Hide main element padding on mobile since views are siblings */
            .app-layout>main {
                padding-bottom: 0 !important;
            }

            /* Mobile chat fullscreen positioning */
            .mobile-chat-fullscreen {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                z-index: 50 !important;
                width: 100% !important;
                height: 100% !important;
            }
        }

        @media (min-width: 768px) {
            .mobile-nav {
                display: none !important;
            }

            .mobile-header {
                display: none !important;
            }

            /* Desktop Messages View - Two Column Layout */
            .messages-container {
                flex-direction: row !important;
                gap: 1.5rem !important;
                padding: 1.25rem !important;
            }

            .messages-list {
                width: 33.333% !important;
                display: flex !important;
                flex-direction: column !important;
            }

            .messages-chat {
                flex: 1 !important;
                display: flex !important;
                flex-direction: column !important;
                position: static !important;
            }
        }


        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .nav-item-active {
            color: #1e40af;
        }

        .nav-item-inactive {
            color: #9ca3af;
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #f3f4f6;
        }

        .shadow-soft {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .card-shadow {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .fab-shadow {
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.4);
        }
    </style>
</head>

<body class="bg-gray-50" x-data="app()" x-init="init()">
    <div class="app-layout">

        <!-- AUTH MODAL (Blocks everything if not logged in) -->
        <template x-if="!user">
            <div class="fixed inset-0 z-50 bg-gray-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-8 border border-gray-100">
                    <div class="text-center mb-8">
                        <div
                            class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-200">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                                </path>
                            </svg>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-900">BrokerLink'e HoÅŸgeldiniz</h1>
                        <p class="text-gray-500 mt-2">Profesyonel Emlak AÄŸÄ±</p>
                    </div>

                    <form @submit.prevent="handleAuth" class="space-y-4">
                        <div x-show="authMode === 'register'">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ad Soyad</label>
                            <input type="text" x-model="authName"
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 transition-colors"
                                placeholder="Ahmet YÄ±lmaz">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">E-posta</label>
                            <input type="email" x-model="authEmail" required
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 transition-colors"
                                placeholder="ornek@email.com">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Åžifre</label>
                            <input type="password" x-model="authPassword" required
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 transition-colors"
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>

                        <div x-show="authError" class="text-red-500 text-sm bg-red-50 p-3 rounded-lg"
                            x-text="authError"></div>

                        <button type="submit"
                            class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 flex items-center justify-center gap-2"
                            :disabled="authLoading">
                            <span x-show="authLoading"
                                class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></span>
                            <span x-text="authMode === 'login' ? 'GiriÅŸ Yap' : 'KayÄ±t Ol'"></span>
                        </button>
                    </form>

                    <div class="mt-6 text-center">
                        <p class="text-sm text-gray-500">
                            <span
                                x-text="authMode === 'login' ? 'HesabÄ±nÄ±z yok mu?' : 'Zaten hesabÄ±nÄ±z var mÄ±?'"></span>
                            <button @click="authMode = authMode === 'login' ? 'register' : 'login'"
                                class="text-blue-600 font-bold hover:underline ml-1">
                                <span x-text="authMode === 'login' ? 'KayÄ±t Ol' : 'GiriÅŸ Yap'"></span>
                            </button>
                        </p>
                    </div>
                </div>
            </div>
        </template>

        <!-- SIDEBAR (Desktop Only) -->
        <aside
            class="hidden md:flex md:w-[280px] md:fixed md:h-screen md:flex-col bg-white border-r border-gray-100 z-50">
            <div class="p-6 border-b border-gray-100">
                <h1 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                        </path>
                    </svg>
                    BrokerLink
                </h1>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <button @click="currentTab = 'dashboard'"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-colors"
                    :class="currentTab === 'dashboard' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                    </svg>
                    Dashboard
                </button>
                <button @click="currentTab = 'portfolios'"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-colors"
                    :class="currentTab === 'portfolios' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                    </svg>
                    PortfÃ¶yler
                </button>
                <button @click="currentTab = 'demands'"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-colors"
                    :class="currentTab === 'demands' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    Talepler
                </button>
                <button @click="currentTab = 'matches'"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-colors"
                    :class="currentTab === 'matches' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                    </svg>
                    EÅŸleÅŸmeler
                </button>
                <button @click="currentTab = 'messages'"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-colors"
                    :class="currentTab === 'messages' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'">
                    <div class="relative">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                            </path>
                        </svg>
                        <div class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"
                            x-show="conversations.reduce((acc, c) => acc + c.unread, 0) > 0"></div>
                    </div>
                    Mesajlar
                </button>
                <button @click="currentTab = 'network'"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-colors"
                    :class="currentTab === 'network' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                    </svg>
                    AÄŸ
                </button>
                <button @click="currentTab = 'profile'"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-colors"
                    :class="currentTab === 'profile' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                    Profil
                </button>
            </nav>

            <div class="p-4 border-t border-gray-100" x-show="user">
                <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 cursor-pointer mb-2">
                    <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden">
                        <img x-show="userProfile?.avatar_url" :src="userProfile?.avatar_url" alt="Profile"
                            class="w-full h-full object-cover">
                        <div x-show="!userProfile?.avatar_url"
                            class="w-full h-full flex items-center justify-center text-lg font-bold text-white bg-blue-600"
                            x-text="user?.email?.charAt(0).toUpperCase()">
                        </div>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-gray-900"
                            x-text="userProfile?.name || user?.email || 'KullanÄ±cÄ±'"></p>
                        <p class="text-xs text-gray-500" x-text="userProfile?.title || 'Broker'"></p>
                    </div>
                </div>
                <button @click="signOut()"
                    class="w-full px-4 py-3 text-sm bg-red-50 text-red-600 hover:bg-red-100 rounded-xl font-medium transition-colors border border-red-200 flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                    Ã‡Ä±kÄ±ÅŸ Yap
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 w-full bg-gray-50 pb-24 md:pb-0 md:ml-[280px]">

            <!-- Messages View -->
            <div x-show="currentTab === 'messages'"
                class="messages-container h-[calc(100vh-8rem)] md:h-[calc(100vh-2rem)] flex flex-col gap-0 p-0 pb-24 md:pb-0"
                x-cloak>
                <!-- Conversation List -->
                <div class="messages-list w-full bg-white md:rounded-3xl shadow-sm border-0 md:border border-gray-100 flex flex-col overflow-hidden h-full"
                    :class="activeConversation ? 'hidden md:flex' : 'flex'">
                    <div class="p-5 border-b border-gray-50">
                        <h2 class="text-xl font-bold text-gray-900">Mesajlar</h2>
                        <div class="mt-4 relative">
                            <input type="text" placeholder="Arama..."
                                class="w-full bg-gray-50 border border-gray-100 rounded-xl py-2.5 pl-10 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-200 transition-all">
                            <svg class="w-4 h-4 text-gray-400 absolute left-3.5 top-3.5" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto">
                        <template x-for="conv in conversations" :key="conv.id">
                            <div @click="activeConversation = conv; loadMessages(conv.id)"
                                class="p-4 border-b border-gray-50 cursor-pointer hover:bg-gray-50 transition-colors flex gap-3"
                                :class="activeConversation && activeConversation.id === conv.id ? 'bg-blue-50/50' : ''">
                                <div class="relative">
                                    <!-- Avatar with fallback -->
                                    <div class="w-12 h-12 rounded-full overflow-hidden bg-gray-200">
                                        <img x-show="conv.userImage" :src="conv.userImage"
                                            class="w-full h-full object-cover">
                                        <div x-show="!conv.userImage"
                                            class="w-full h-full flex items-center justify-center bg-blue-600 text-white font-bold text-lg"
                                            x-text="conv.userName?.charAt(0).toUpperCase()">
                                        </div>
                                    </div>
                                    <div
                                        class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white">
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start mb-1">
                                        <h3 class="font-bold text-gray-900 text-sm truncate" x-text="conv.userName">
                                        </h3>
                                        <span class="text-xs text-gray-400 whitespace-nowrap" x-text="conv.time"></span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <p class="text-sm text-gray-500 truncate" x-text="conv.lastMessage"
                                            :class="conv.unread > 0 ? 'font-semibold text-gray-800' : ''"></p>
                                        <div x-show="conv.unread > 0"
                                            class="bg-blue-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[18px] text-center"
                                            x-text="conv.unread"></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="messages-chat bg-white md:rounded-3xl shadow-sm border-0 md:border border-gray-100 flex-col overflow-hidden h-full"
                    :class="activeConversation ? 'flex mobile-chat-fullscreen' : 'hidden md:flex'">
                    <template x-if="activeConversation">
                        <div class="flex flex-col h-full">
                            <!-- Chat Header -->
                            <div class="p-4 border-b border-gray-50 flex justify-between items-center bg-white z-10">
                                <div class="flex items-center gap-3">
                                    <!-- Back Button (Mobile Only) -->
                                    <button @click="activeConversation = null"
                                        class="md:hidden p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 19l-7-7 7-7"></path>
                                        </svg>
                                    </button>
                                    <!-- Avatar with fallback -->
                                    <div class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0 bg-gray-200">
                                        <img x-show="activeConversation.userImage" :src="activeConversation.userImage"
                                            class="w-full h-full object-cover">
                                        <div x-show="!activeConversation.userImage"
                                            class="w-full h-full flex items-center justify-center bg-blue-600 text-white font-bold text-sm"
                                            x-text="activeConversation.userName?.charAt(0).toUpperCase()">
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-900" x-text="activeConversation.userName"></h3>
                                        <p class="text-xs text-green-500 font-medium flex items-center gap-1">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            Ã‡evrimiÃ§i
                                        </p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button
                                        @click="showConnectionContact({broker: {phone: activeConversation.receiverId}})"
                                        class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-lg transition-colors"
                                        title="Ara">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
                                            </path>
                                        </svg>
                                    </button>
                                    <!-- 3-dot menu -->
                                    <div class="relative" x-data="{menuOpen: false}">
                                        <button @click="menuOpen = !menuOpen"
                                            class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-lg transition-colors">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z">
                                                </path>
                                            </svg>
                                        </button>
                                        <!-- Dropdown Menu -->
                                        <div x-show="menuOpen" @click.away="menuOpen = false"
                                            class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-100 py-1 z-50">
                                            <button @click="deleteConversation(activeConversation.id); menuOpen = false"
                                                class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                                KonuÅŸmayÄ± Sil
                                            </button>
                                            <!-- Engeli KaldÄ±r butonu (sadece engelliyse gÃ¶rÃ¼nÃ¼r) -->
                                            <button x-show="isBlocked(activeConversation?.receiverId)"
                                                @click="unblockUser(activeConversation.receiverId); menuOpen = false"
                                                class="w-full text-left px-4 py-2 text-sm text-green-600 hover:bg-green-50 flex items-center gap-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                Engeli KaldÄ±r
                                            </button>
                                            <!-- KullanÄ±cÄ±yÄ± Engelle butonu (engelli deÄŸilse gÃ¶rÃ¼nÃ¼r) -->
                                            <button x-show="!isBlocked(activeConversation?.receiverId)"
                                                @click="blockUser(activeConversation.receiverId); menuOpen = false"
                                                class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                                                </svg>
                                                KullanÄ±cÄ±yÄ± Engelle
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Messages -->
                            <div class="flex-1 overflow-y-auto p-5 space-y-4 bg-gray-50/50">
                                <template x-for="msg in messages[activeConversation.id] || []" :key="msg.id">
                                    <div class="flex" :class="msg.sender === 'sent' ? 'justify-end' : 'justify-start'">
                                        <div class="max-w-[70%] rounded-2xl px-4 py-2.5 shadow-sm"
                                            :class="msg.sender === 'sent' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-gray-800 border border-gray-100 rounded-tl-none'">
                                            <p class="text-sm leading-relaxed" x-text="msg.content"></p>
                                            <p class="text-[10px] mt-1 opacity-70 text-right" x-text="msg.time"></p>
                                        </div>
                                    </div>
                                </template>
                                <!-- Empty state -->
                                <div x-show="!messages[activeConversation.id] || messages[activeConversation.id].length === 0"
                                    class="flex items-center justify-center h-full text-gray-400 text-sm">
                                    <div class="text-center">
                                        <svg class="w-16 h-16 mx-auto mb-3 opacity-30" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                                            </path>
                                        </svg>
                                        <p>HenÃ¼z mesaj yok</p>
                                        <p class="text-xs mt-1">Ä°lk mesajÄ± gÃ¶nderin!</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Input -->
                            <div class="p-4 bg-white border-t border-gray-50">
                                <div class="flex gap-2">
                                    <button
                                        class="p-2.5 text-gray-400 hover:text-gray-600 hover:bg-gray-50 rounded-xl transition-colors">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13">
                                            </path>
                                        </svg>
                                    </button>
                                    <input type="text" x-model="newMessageText" @keydown.enter="sendNewMessage()"
                                        placeholder="Bir mesaj yazÄ±n..."
                                        class="flex-1 bg-gray-50 border border-gray-100 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-200 transition-all">
                                    <button @click="sendNewMessage()" :disabled="!newMessageText.trim()"
                                        :class="!newMessageText.trim() ? 'opacity-50 cursor-not-allowed' : ''"
                                        class="p-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                    <template x-if="!activeConversation">
                        <div class="flex-1 flex flex-col items-center justify-center text-gray-400 p-10 text-center">
                            <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                                <svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                                    </path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">MesajlarÄ±nÄ±z</h3>
                            <p class="text-sm max-w-xs">Sol taraftan bir sohbet seÃ§erek mesajlaÅŸmaya baÅŸlayabilirsiniz.
                            </p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- MOBILE HEADER -->
            <div class="mobile-header sticky top-0 z-30 bg-white px-5 py-4 border-b border-gray-100 md:hidden">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-blue-600">BrokerLink</h1>
                    <div class="flex items-center gap-2">
                        <!-- Messages Button -->
                        <button @click="currentTab = 'messages'"
                            class="w-10 h-10 rounded-xl flex items-center justify-center relative"
                            :class="currentTab === 'messages' ? 'bg-blue-100 text-blue-600' : 'bg-gray-50 text-gray-600'">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                </path>
                            </svg>
                            <!-- Unread indicator -->
                            <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"
                                x-show="conversations.some(c => c.unread_count > 0)"></span>
                        </button>
                        <!-- Notifications Button (Hidden - not implemented yet) -->
                        <button
                            class="hidden w-10 h-10 bg-gray-50 rounded-xl flex items-center justify-center text-gray-600 relative">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                                </path>
                            </svg>
                            <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                        </button>
                        <!-- Profile Button -->
                        <button @click="currentTab = 'profile'"
                            class="w-10 h-10 rounded-xl flex items-center justify-center"
                            :class="currentTab === 'profile' ? 'bg-blue-100 text-blue-600' : 'bg-gray-50 text-gray-600'">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Error Toast -->
            <div x-show="errorMessage" x-transition
                class="fixed top-4 right-4 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg shadow-lg z-50 max-w-md">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                            clip-rule="evenodd"></path>
                    </svg>
                    <div class="flex-1">
                        <p class="font-medium text-sm" x-text="errorMessage"></p>
                    </div>
                    <button @click="errorMessage = ''" class="text-red-600 hover:text-red-800">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Success Toast -->
            <div x-show="successMessage" x-transition
                class="fixed top-4 right-4 bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg shadow-lg z-50 max-w-md">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                            clip-rule="evenodd"></path>
                    </svg>
                    <div class="flex-1">
                        <p class="font-medium text-sm" x-text="successMessage"></p>
                    </div>
                    <button @click="successMessage = ''" class="text-green-600 hover:text-green-800">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- DASHBOARD VIEW -->
            <div x-show="currentTab === 'dashboard'" class="pb-24 w-full" x-cloak>
                <!-- Loading State -->
                <!-- Loading Skeleton -->
                <div x-show="isLoading" class="p-5 animate-pulse w-full">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Left Column Skeleton -->
                        <div class="md:col-span-2 space-y-6">
                            <!-- Stats Cards -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <template x-for="(_, idx) in 4" :key="'skeleton-stat-' + idx">
                                    <div class="h-24 bg-gray-100 rounded-2xl border border-gray-200"></div>
                                </template>
                            </div>
                            <!-- Matches Section Skeleton -->
                            <div class="bg-white border border-gray-100 h-96 rounded-3xl p-6 space-y-4">
                                <div class="flex gap-4 mb-6">
                                    <div class="h-10 w-24 bg-gray-100 rounded-full"></div>
                                    <div class="h-10 w-24 bg-gray-100 rounded-full"></div>
                                </div>
                                <div class="space-y-4">
                                    <div class="h-40 bg-gray-50 rounded-2xl border border-gray-100"></div>
                                    <div class="h-40 bg-gray-50 rounded-2xl border border-gray-100"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Right Column Skeleton (News) -->
                        <div class="space-y-6">
                            <div class="bg-white border border-gray-100 h-[500px] rounded-3xl p-6">
                                <div class="h-6 bg-gray-100 rounded w-1/2 mb-6"></div>
                                <div class="space-y-4">
                                    <template x-for="(_, idx) in 5" :key="'skeleton-activity-' + idx">
                                        <div class="flex gap-3">
                                            <div class="w-10 h-10 rounded-full bg-gray-100"></div>
                                            <div class="flex-1 space-y-2">
                                                <div class="h-4 bg-gray-100 rounded w-3/4"></div>
                                                <div class="h-3 bg-gray-50 rounded w-1/2"></div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content (hide while loading) -->
                <div x-show="!isLoading" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 p-5">
                    <!-- Left Column: Stats & Matches -->
                    <div class="md:col-span-2 space-y-6">
                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Aktif PortfÃ¶y -->
                            <div @click="currentTab = 'portfolios'"
                                class="bg-white rounded-2xl p-4 border border-gray-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer group">
                                <div class="flex items-center gap-2 mb-1">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center group-hover:bg-blue-100 transition-colors">
                                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                        </svg>
                                    </div>
                                    <span
                                        class="text-xs text-gray-500 font-medium group-hover:text-blue-600 transition-colors">Aktif
                                        PortfÃ¶y</span>
                                </div>
                                <div class="text-3xl font-bold text-gray-900" x-text="portfolios.length">4</div>
                            </div>
                            <!-- Aktif Talep -->
                            <div @click="currentTab = 'demands'"
                                class="bg-white rounded-2xl p-4 border border-gray-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer group">
                                <div class="flex items-center gap-2 mb-1">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-green-50 flex items-center justify-center group-hover:bg-green-100 transition-colors">
                                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                    <span
                                        class="text-xs text-gray-500 font-medium group-hover:text-green-600 transition-colors">Aktif
                                        Talep</span>
                                </div>
                                <div class="text-3xl font-bold text-gray-900" x-text="demands.length">2</div>
                            </div>
                            <!-- Toplam EÅŸleÅŸme -->
                            <div @click="currentTab = 'matches'"
                                class="bg-white rounded-2xl p-4 border border-gray-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer group">
                                <div class="flex items-center gap-2 mb-1">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-yellow-50 flex items-center justify-center group-hover:bg-yellow-100 transition-colors">
                                        <svg class="w-4 h-4 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path
                                                d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                        </svg>
                                    </div>
                                    <span
                                        class="text-xs text-gray-500 font-medium group-hover:text-yellow-600 transition-colors">Toplam
                                        EÅŸleÅŸme</span>
                                </div>
                                <div class="text-3xl font-bold text-gray-900" x-text="totalMatchCount">
                                    0</div>
                            </div>
                            <!-- Trust Score (GÃ¼ven PuanÄ±) -->
                            <div class="bg-white rounded-2xl p-4 border border-gray-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer group"
                                @click="currentTab = 'profile'">
                                <div class="flex items-center gap-2 mb-1">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-gradient-to-br from-amber-100 to-orange-100 flex items-center justify-center group-hover:from-amber-200 group-hover:to-orange-200 transition-colors">
                                        <span class="text-lg"
                                            x-text="userProfile.trustScore?.levelEmoji || 'ðŸ”°'"></span>
                                    </div>
                                    <span
                                        class="text-xs text-gray-500 font-medium group-hover:text-amber-600 transition-colors">GÃ¼ven
                                        PuanÄ±</span>
                                </div>
                                <div class="text-3xl font-bold text-gray-900"
                                    x-text="userProfile.trustScore?.total || 0">
                                </div>
                                <div class="mt-1 flex items-center gap-2">
                                    <div class="flex-1 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-amber-400 to-orange-500 rounded-full transition-all duration-500"
                                            :style="`width: ${userProfile.trustScore?.total || 0}%`"></div>
                                    </div>
                                    <span class="text-xs font-medium text-amber-600"
                                        x-text="userProfile.trustScore?.levelName || 'HesaplanÄ±yor...'"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Paket Bilgisi / Kota KartÄ± -->
                        <div
                            class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-100 p-4 mb-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-bold text-gray-800">Abonelik Paketiniz</span>
                                    <span class="text-xs font-bold px-2 py-0.5 rounded-full" :class="{
                                            'bg-gray-200 text-gray-700': subscription.tier === 'free',
                                            'bg-blue-600 text-white': subscription.tier === 'pro',
                                            'bg-amber-500 text-white': subscription.tier === 'enterprise'
                                        }"
                                        x-text="subscription.tier === 'free' ? 'Ãœcretsiz' : subscription.tier === 'pro' ? 'Pro' : 'Enterprise'">
                                    </span>
                                </div>
                                <button @click="showLimitModal = true; limitModalType = 'demand'"
                                    class="text-xs text-blue-600 font-semibold hover:underline"
                                    x-show="subscription.tier === 'free'">
                                    â¬† YÃ¼kselt
                                </button>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                                        <span>Talepler</span>
                                        <span
                                            x-text="`${subscription.demands_used}/${subscription.demands_limit}`"></span>
                                    </div>
                                    <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="h-full rounded-full transition-all"
                                            :class="subscription.demands_used >= subscription.demands_limit ? 'bg-red-500' : 'bg-blue-500'"
                                            :style="`width: ${Math.min(100, (subscription.demands_used / Math.max(1, subscription.demands_limit)) * 100)}%`">
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                                        <span>PortfÃ¶yler</span>
                                        <span
                                            x-text="`${subscription.portfolios_used}/${subscription.portfolios_limit}`"></span>
                                    </div>
                                    <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="h-full rounded-full transition-all"
                                            :class="subscription.portfolios_used >= subscription.portfolios_limit ? 'bg-red-500' : 'bg-emerald-500'"
                                            :style="`width: ${Math.min(100, (subscription.portfolios_used / Math.max(1, subscription.portfolios_limit)) * 100)}%`">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Son EÅŸleÅŸmeler -->
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-gray-900">Onay Bekleyen EÅŸleÅŸmeler</h3>
                                <button class="text-sm text-blue-600 font-semibold" @click="generateMatches()">
                                    <span x-show="!isMatching">ðŸ”„ EÅŸleÅŸtirmeleri Yenile</span>
                                    <span x-show="isMatching">â³ AranÄ±yor...</span>
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <template x-for="match in dashboardMatches" :key="match.id">
                                    <div class="bg-white rounded-2xl overflow-hidden border border-gray-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer"
                                        @click="openMatchDetail()">
                                        <div class="h-28 bg-gray-100 relative overflow-hidden">
                                            <img :src="match.image" class="w-full h-full object-cover"
                                                alt="Match property">
                                            <div class="absolute top-2 left-2 flex gap-1">
                                                <div class="bg-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-lg"
                                                    x-text="match.score + '% EÅŸleÅŸme'"></div>
                                                <div class="text-white text-xs font-bold px-2 py-1 rounded-lg"
                                                    :class="match.type === 'KiralÄ±k' ? 'bg-orange-500' : 'bg-emerald-500'"
                                                    x-text="match.type"></div>
                                                <div x-show="match.status === 'approved'"
                                                    class="bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-lg">
                                                    âœ“ OnaylÄ±
                                                </div>
                                                <div x-show="match.status === 'rejected'"
                                                    class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-lg">
                                                    âœ— Reddedildi
                                                </div>
                                            </div>
                                        </div>
                                        <div class="p-3">
                                            <!-- Contextual Badge -->
                                            <div class="flex items-center gap-2 mb-2">
                                                <template x-if="match.clientBudget">
                                                    <span
                                                        class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-medium">ðŸ“‹
                                                        Talebiniz</span>
                                                </template>
                                                <template x-if="!match.clientBudget && match.demandBudget">
                                                    <span
                                                        class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full font-medium">ðŸ¢
                                                        PortfÃ¶yÃ¼nÃ¼ze EÅŸleÅŸen Talep</span>
                                                </template>
                                            </div>
                                            <h3 class="font-bold text-gray-900 text-sm mb-1" x-text="match.name"></h3>
                                            <p class="text-blue-600 font-bold text-xs mb-1"
                                                x-text="match.clientBudget || match.price"></p>
                                            <p class="text-gray-500 text-xs mb-2 flex items-center gap-1">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd"
                                                        d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                                                        clip-rule="evenodd" />
                                                </svg>
                                                <span x-text="match.location"></span>
                                            </p>
                                            <div class="flex items-center gap-2 text-gray-400 text-xs mb-3">
                                                <span x-text="match.specs"></span>
                                            </div>

                                            <!-- Broker Bilgisi -->
                                            <div class="flex items-center gap-2 mb-3 pt-2 border-t border-gray-100">
                                                <div
                                                    class="w-6 h-6 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                                                    <img x-show="match.brokerAvatar" :src="match.brokerAvatar"
                                                        class="w-full h-full object-cover">
                                                    <div x-show="!match.brokerAvatar"
                                                        class="w-full h-full flex items-center justify-center bg-blue-600 text-white text-xs font-bold"
                                                        x-text="match.brokerName?.charAt(0)"></div>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-xs font-semibold text-gray-700 truncate"
                                                        x-text="match.brokerName"></p>
                                                    <p class="text-xs text-gray-500 truncate"
                                                        x-text="match.brokerCompany || match.brokerTitle"></p>
                                                </div>
                                                <!-- âœ… Trust Score Badge -->
                                                <div x-show="match.brokerTrustScore"
                                                    class="flex items-center gap-1 px-2 py-0.5 bg-amber-50 rounded-lg border border-amber-200">
                                                    <span x-text="match.brokerTrustEmoji || 'ðŸ”°'"
                                                        class="text-xs"></span>
                                                    <span x-text="match.brokerTrustScore || '0'"
                                                        class="text-xs font-bold text-amber-700"></span>
                                                </div>
                                                <button @click.stop="showBrokerContact(match)"
                                                    class="text-blue-600 hover:text-blue-700 p-1 transition-colors">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                                    </svg>
                                                </button>
                                            </div>

                                            <div class="flex gap-2">
                                                <!-- Show buttons only if status is pending or not set -->
                                                <template x-if="match.status === 'pending' || !match.status">
                                                    <div class="flex gap-2 w-full">
                                                        <!-- Normal buttons (when not confirming) -->
                                                        <template x-if="confirmingMatchId !== match.id">
                                                            <div class="flex gap-2 w-full">
                                                                <button @click.stop="rejectMatch(match.id)"
                                                                    class="flex-1 py-1.5 border border-red-200 text-red-600 rounded-lg text-xs font-medium hover:bg-red-50 transition-colors">Reddet</button>
                                                                <button @click.stop="approveMatch(match.id)"
                                                                    class="flex-1 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors">Onayla</button>
                                                            </div>
                                                        </template>

                                                        <!-- Confirmation UI for Approve -->
                                                        <template
                                                            x-if="confirmingMatchId === match.id && confirmingAction === 'approve'">
                                                            <div
                                                                class="w-full bg-blue-50 border border-blue-200 rounded-lg p-2">
                                                                <p
                                                                    class="text-xs text-blue-900 font-medium mb-2 text-center">
                                                                    Onaylamak istediÄŸinize emin misiniz?</p>
                                                                <div class="flex gap-2">
                                                                    <button
                                                                        @click.stop="confirmingMatchId = null; confirmingAction = null"
                                                                        class="flex-1 py-1.5 bg-white border border-gray-300 text-gray-700 rounded-lg text-xs font-medium hover:bg-gray-50 transition-colors">HayÄ±r</button>
                                                                    <button @click.stop="approveMatch(match.id)"
                                                                        class="flex-1 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors">Evet</button>
                                                                </div>
                                                            </div>
                                                        </template>

                                                        <!-- Confirmation UI for Reject -->
                                                        <template
                                                            x-if="confirmingMatchId === match.id && confirmingAction === 'reject'">
                                                            <div
                                                                class="w-full bg-red-50 border border-red-200 rounded-lg p-2">
                                                                <p
                                                                    class="text-xs text-red-900 font-medium mb-2 text-center">
                                                                    Reddetmek istediÄŸinize emin misiniz?</p>
                                                                <div class="flex gap-2">
                                                                    <button
                                                                        @click.stop="confirmingMatchId = null; confirmingAction = null"
                                                                        class="flex-1 py-1.5 bg-white border border-gray-300 text-gray-700 rounded-lg text-xs font-medium hover:bg-gray-50 transition-colors">HayÄ±r</button>
                                                                    <button @click.stop="rejectMatch(match.id)"
                                                                        class="flex-1 py-1.5 bg-red-600 text-white rounded-lg text-xs font-medium hover:bg-red-700 transition-colors">Evet</button>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </template>

                                                <!-- Status displays -->
                                                <div x-show="match.status === 'approved'"
                                                    class="w-full py-2 bg-green-50 text-green-700 rounded-lg text-xs font-semibold text-center border border-green-200">
                                                    âœ“ Bu eÅŸleÅŸme onaylandÄ±
                                                </div>
                                                <div x-show="match.status === 'rejected'"
                                                    class="w-full py-2 bg-red-50 text-red-700 rounded-lg text-xs font-semibold text-center border border-red-200">
                                                    âœ— Bu eÅŸleÅŸme reddedildi
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Right Column: Network Activities -->
                <div class="md:col-span-1 space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-900">AÄŸ Hareketleri</h3>
                        <button class="text-sm text-blue-600 font-semibold">TÃ¼mÃ¼</button>
                    </div>
                    <div class="space-y-3">
                        <template x-for="activity in networkActivities" :key="activity.id">
                            <div class="bg-white p-4 rounded-2xl shadow-soft border border-gray-50 flex gap-4">
                                <!-- Avatar with fallback -->
                                <div class="w-12 h-12 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                                    <img x-show="activity.avatar" :src="activity.avatar"
                                        class="w-full h-full object-cover">
                                    <div x-show="!activity.avatar"
                                        class="w-full h-full flex items-center justify-center bg-blue-600 text-white font-bold text-lg"
                                        x-text="activity.user?.charAt(0).toUpperCase()">
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-bold text-gray-900 text-sm" x-text="activity.user"></h4>
                                        <span class="text-gray-400 text-xs" x-text="activity.time"></span>
                                    </div>
                                    <p class="text-gray-600 text-sm mt-1" x-text="activity.action"></p>
                                </div>
                            </div>
                        </template>

                        <!-- Empty State -->
                        <div x-show="!networkActivities || networkActivities.length === 0"
                            class="bg-white p-8 rounded-2xl shadow-soft border border-gray-50 text-center">
                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                </path>
                            </svg>
                            <p class="text-gray-600 font-medium">HenÃ¼z aÄŸ aktivitesi yok</p>
                            <p class="text-sm text-gray-400 mt-2">Brokerlarla baÄŸlantÄ± kurmaya baÅŸlayÄ±n!</p>
                            <button @click="currentTab = 'network'"
                                class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                                AÄŸÄ±ma Git
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- MATCHES VIEW -->
            <div x-show="currentTab === 'matches'" class="pb-24 w-full" x-cloak>
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-900">EÅŸleÅŸmeler</h2>
                    <select x-model="matchSortOrder"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-blue-500">
                        <option value="newest">Yeniden Eskiye</option>
                        <option value="oldest">Eskiden Yeniye</option>
                    </select>
                </div>

                <!-- Tabs -->
                <div class="px-5 pt-4">
                    <div
                        class="bg-purple-50 rounded-2xl p-4 flex items-center justify-between border border-purple-100 mb-4">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-xl bg-white flex items-center justify-center shadow-sm text-purple-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                    </path>
                                </svg>
                            </div>
                            <div>
                                <div class="text-xs text-purple-600 font-bold uppercase tracking-wide">Ortalama Skor
                                </div>
                                <div class="text-2xl font-bold text-gray-900" x-text="averageMatchScore + '%'">0%</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">Son 30 gÃ¼n</div>
                            <div class="text-xs text-emerald-600 font-bold flex items-center justify-end gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                                +2.4%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="px-5 pt-4 mb-4">
                    <div class="flex gap-3 overflow-x-auto hide-scrollbar">
                        <button @click="matchesTab = 'demands'"
                            class="px-4 py-2 rounded-full text-sm font-semibold flex items-center gap-1.5 transition-colors"
                            :class="matchesTab === 'demands' ? 'bg-blue-600 text-white' : 'bg-gray-50 text-gray-600 hover:bg-gray-100'">
                            Taleplerim <span class="px-1.5 py-0.5 rounded-full text-xs"
                                :class="matchesTab === 'demands' ? 'bg-white/20' : 'bg-gray-200'"
                                x-text="pendingDemandCount"></span>
                        </button>
                        <button @click="matchesTab = 'portfolios'"
                            class="px-4 py-2 rounded-full text-sm font-semibold flex items-center gap-1.5 transition-colors"
                            :class="matchesTab === 'portfolios' ? 'bg-green-600 text-white' : 'bg-gray-50 text-gray-600 hover:bg-gray-100'">
                            PortfÃ¶ylerim <span class="px-1.5 py-0.5 rounded-full text-xs"
                                :class="matchesTab === 'portfolios' ? 'bg-white/20' : 'bg-gray-200'"
                                x-text="pendingPortfolioCount"></span>
                        </button>
                        <button @click="matchesTab = 'approved'"
                            class="px-4 py-2 rounded-full text-sm font-semibold flex items-center gap-1.5 transition-colors"
                            :class="matchesTab === 'approved' ? 'bg-emerald-600 text-white' : 'bg-gray-50 text-gray-600 hover:bg-gray-100'">
                            Onaylanan <span class="px-1.5 py-0.5 rounded-full text-xs"
                                :class="matchesTab === 'approved' ? 'bg-white/20' : 'bg-gray-200'"
                                x-text="approvedMatchesCount"></span>
                        </button>
                    </div>
                </div>

                <!-- Matches List -->
                <div class="px-5 space-y-3">
                    <!-- Demand Matches (Taleplerim) -->
                    <template x-if="matchesTab === 'demands'">
                        <div class="space-y-3">
                            <template x-for="match in filteredMatches.sort((a, b) => b.score - a.score)"
                                :key="match.id">
                                <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden">
                                    <!-- Header -->
                                    <div class="p-4 flex justify-between items-start border-b border-gray-50">
                                        <div>
                                            <h3 class="font-bold text-gray-900 mb-1">
                                                <span x-text="match.title + ' â†” ' + match.name"></span>
                                                <span x-show="match.type" class="text-gray-500 font-normal text-xs ml-2"
                                                    x-text="'(' + match.type + ')'"></span>
                                            </h3>
                                            <div class="flex items-center gap-2">
                                                <p class="text-emerald-600 text-xs font-medium"
                                                    x-text="match.score + '% EÅŸleÅŸme'">
                                                </p>
                                                <span x-show="match.status === 'approved'"
                                                    class="bg-green-100 text-green-700 text-xs font-semibold px-2 py-0.5 rounded-full">
                                                    âœ“ OnaylÄ±
                                                </span>
                                                <span x-show="match.status === 'rejected'"
                                                    class="bg-red-100 text-red-700 text-xs font-semibold px-2 py-0.5 rounded-full">
                                                    âœ— Reddedildi
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button @click="toggleFavorite(match.id)"
                                                class="p-1.5 rounded-full hover:bg-gray-50 transition-colors"
                                                :class="match.isFavorite ? 'text-red-500' : 'text-gray-300 hover:text-red-400'">
                                                <svg class="w-6 h-6" :fill="match.isFavorite ? 'currentColor' : 'none'"
                                                    stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                                </svg>
                                            </button>
                                            <div class="bg-emerald-500 text-white text-xs font-bold px-2.5 py-1 rounded-lg"
                                                x-text="match.score + '%'"></div>
                                        </div>
                                    </div>

                                    <!-- Comparison -->
                                    <div class="p-4 bg-gray-50">
                                        <div class="flex gap-3 items-center mb-3">
                                            <!-- Property -->
                                            <div class="flex-1 bg-white rounded-xl p-3 border border-gray-100">
                                                <!-- Broker Info (Compact) -->
                                                <div class="flex items-center gap-2 mb-2 pb-2 border-b border-gray-100">
                                                    <div
                                                        class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                                                        <img x-show="match.brokerAvatar" :src="match.brokerAvatar"
                                                            class="w-full h-full object-cover">
                                                        <div x-show="!match.brokerAvatar"
                                                            class="w-full h-full flex items-center justify-center bg-blue-600 text-white text-xs font-bold"
                                                            x-text="match.brokerName?.charAt(0)"></div>
                                                    </div>
                                                    <div class="flex-1 min-w-0">
                                                        <p class="text-xs font-bold text-gray-900 truncate"
                                                            x-text="match.brokerName"></p>
                                                        <p class="text-xs text-gray-500 truncate"
                                                            x-text="match.brokerCompany || match.brokerTitle"></p>
                                                    </div>
                                                    <!-- âœ… Trust Score Badge -->
                                                    <div x-show="match.brokerTrustScore"
                                                        class="flex items-center gap-1 px-2 py-0.5 bg-amber-50 rounded-lg border border-amber-200">
                                                        <span x-text="match.brokerTrustEmoji || 'ðŸ”°'"
                                                            class="text-xs"></span>
                                                        <span x-text="match.brokerTrustScore || '0'"
                                                            class="text-xs font-bold text-amber-700"></span>
                                                    </div>
                                                    <button @click.stop="showBrokerContact(match)"
                                                        class="text-blue-600 hover:text-blue-700 p-1 transition-colors"
                                                        title="Ä°letiÅŸime GeÃ§">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                            viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                                        </svg>
                                                    </button>
                                                </div>

                                                <div class="w-full h-20 bg-gray-200 rounded-lg mb-2 overflow-hidden">
                                                    <img :src="match.image" class="w-full h-full object-cover"
                                                        alt="Property image">
                                                </div>
                                                <h4 class="font-bold text-gray-900 text-sm mb-1"
                                                    x-text="match.title || 'PortfÃ¶y'">
                                                </h4>
                                                <p class="text-blue-600 font-bold text-sm mb-1" x-text="match.price">
                                                </p>
                                                <p class="text-gray-500 text-xs" x-text="match.location"></p>
                                                <p class="text-gray-400 text-xs" x-text="match.specs"></p>
                                            </div>

                                            <!-- Arrow -->
                                            <div class="text-blue-400">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                                </svg>
                                            </div>

                                            <!-- Client (Your Demand) -->
                                            <div class="flex-1 bg-white rounded-xl p-3 border-2 border-blue-200">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <div class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold"
                                                        x-text="match.name.charAt(0)"></div>
                                                    <span
                                                        class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-medium">Talebiniz</span>
                                                </div>
                                                <h4 class="font-bold text-gray-900 text-sm mb-1" x-text="match.name">
                                                </h4>
                                                <p class="text-emerald-600 font-semibold text-sm mb-1"
                                                    x-text="match.clientBudget || 'BÃ¼tÃ§e Uygun'"></p>
                                                <p class="text-gray-500 text-xs" x-text="match.clientLocation"></p>
                                                <p class="text-gray-400 text-xs" x-text="match.specs"></p>
                                            </div>
                                        </div>

                                        <!-- Criteria -->
                                        <div class="flex flex-wrap gap-2 mb-3">
                                            <span
                                                class="px-2.5 py-1 bg-emerald-50 text-emerald-700 rounded-full text-xs font-medium flex items-center gap-1">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd"
                                                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                        clip-rule="evenodd" />
                                                </svg>
                                                Konum
                                            </span>
                                            <span
                                                class="px-2.5 py-1 bg-emerald-50 text-emerald-700 rounded-full text-xs font-medium flex items-center gap-1">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd"
                                                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                        clip-rule="evenodd" />
                                                </svg>
                                                BÃ¼tÃ§e
                                            </span>
                                        </div>

                                        <!-- Actions -->
                                        <div class="flex gap-2">
                                            <!-- Show buttons only if status is pending or not set -->
                                            <template x-if="match.status === 'pending' || !match.status">
                                                <div class="flex gap-2 w-full">
                                                    <!-- Normal buttons (when not confirming) -->
                                                    <template x-if="confirmingMatchId !== match.id">
                                                        <div class="flex gap-2 w-full">
                                                            <button @click="rejectMatch(match.id)"
                                                                class="flex-1 py-2.5 border-2 border-red-200 text-red-600 rounded-xl font-semibold text-sm hover:bg-red-50 flex items-center justify-center gap-1 transition-colors">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                                    viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                                </svg>
                                                                Reddet
                                                            </button>
                                                            <button @click="approveMatch(match.id)"
                                                                class="flex-1 py-2.5 bg-emerald-500 text-white rounded-xl font-semibold text-sm hover:bg-emerald-600 flex items-center justify-center gap-1 transition-colors">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                                    viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        stroke-width="2" d="M5 13l4 4L19 7" />
                                                                </svg>
                                                                Onayla
                                                            </button>
                                                        </div>
                                                    </template>

                                                    <!-- Confirmation UI for Approve -->
                                                    <template
                                                        x-if="confirmingMatchId === match.id && confirmingAction === 'approve'">
                                                        <div
                                                            class="w-full bg-emerald-50 border-2 border-emerald-200 rounded-xl p-3">
                                                            <p
                                                                class="text-sm text-emerald-900 font-semibold mb-2 text-center">
                                                                Onaylamak istediÄŸinize emin misiniz?</p>
                                                            <div class="flex gap-2">
                                                                <button
                                                                    @click="confirmingMatchId = null; confirmingAction = null"
                                                                    class="flex-1 py-2 bg-white border-2 border-gray-300 text-gray-700 rounded-lg font-medium text-sm hover:bg-gray-50 transition-colors">HayÄ±r</button>
                                                                <button @click="approveMatch(match.id)"
                                                                    class="flex-1 py-2 bg-emerald-500 text-white rounded-lg font-semibold text-sm hover:bg-emerald-600 transition-colors">Evet</button>
                                                            </div>
                                                        </div>
                                                    </template>

                                                    <!-- Confirmation UI for Reject -->
                                                    <template
                                                        x-if="confirmingMatchId === match.id && confirmingAction === 'reject'">
                                                        <div
                                                            class="w-full bg-red-50 border-2 border-red-200 rounded-xl p-3">
                                                            <p
                                                                class="text-sm text-red-900 font-semibold mb-2 text-center">
                                                                Reddetmek
                                                                istediÄŸinize emin misiniz?</p>
                                                            <div class="flex gap-2">
                                                                <button
                                                                    @click="confirmingMatchId = null; confirmingAction = null"
                                                                    class="flex-1 py-2 bg-white border-2 border-gray-300 text-gray-700 rounded-lg font-medium text-sm hover:bg-gray-50 transition-colors">HayÄ±r</button>
                                                                <button @click="rejectMatch(match.id)"
                                                                    class="flex-1 py-2 bg-red-600 text-white rounded-lg font-semibold text-sm hover:bg-red-700 transition-colors">Evet</button>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>

                                            <!-- Status displays -->
                                            <div x-show="match.status === 'approved'"
                                                class="w-full py-2.5 bg-green-50 text-green-700 rounded-xl font-semibold text-sm text-center">
                                                âœ“ Bu eÅŸleÅŸme onaylandÄ±
                                            </div>
                                            <div x-show="match.status === 'rejected'"
                                                class="w-full py-2.5 bg-red-50 text-red-700 rounded-xl font-semibold text-sm text-center">
                                                âœ— Bu eÅŸleÅŸme reddedildi
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <!-- Empty State -->
                            <div x-show="!filteredMatches || filteredMatches.length === 0" class="text-center py-12">
                                <div
                                    class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                                <p class="text-gray-500 font-medium">HenÃ¼z eÅŸleÅŸme bulunamadÄ±.</p>
                                <p class="text-sm text-gray-400 mt-2">
                                    Yeni talep ekleyerek eÅŸleÅŸme ÅŸansÄ±nÄ±zÄ± artÄ±rÄ±n.
                                </p>
                            </div>

                    </template>

                    <!-- Portfolio Matches (PortfÃ¶ylerim) -->
                    <template x-if="matchesTab === 'portfolios'">
                        <div class="space-y-3">
                            <template x-for="match in filteredMatches.sort((a, b) => b.score - a.score)"
                                :key="match.id">
                                <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden">
                                    <!-- Header -->
                                    <div class="p-4 flex justify-between items-start border-b border-gray-50">
                                        <div>
                                            <h3 class="font-bold text-gray-900 mb-1">
                                                <span x-text="match.portfolioTitle + ' â†” ' + match.demandTitle"></span>
                                                <span x-show="match.portfolioType"
                                                    class="text-gray-500 font-normal text-xs ml-2"
                                                    x-text="'(' + match.portfolioType + ')'"></span>
                                            </h3>
                                            <div class="flex items-center gap-2">
                                                <p class="text-emerald-600 text-xs font-medium"
                                                    x-text="match.score + '% EÅŸleÅŸme'">
                                                </p>
                                                <span x-show="match.status === 'approved'"
                                                    class="bg-green-100 text-green-700 text-xs font-semibold px-2 py-0.5 rounded-full">âœ“
                                                    OnaylÄ±</span>
                                                <span x-show="match.status === 'rejected'"
                                                    class="bg-red-100 text-red-700 text-xs font-semibold px-2 py-0.5 rounded-full">âœ—
                                                    Reddedildi</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button @click="toggleFavorite(match.id)"
                                                class="p-1.5 rounded-full hover:bg-gray-50 transition-colors"
                                                :class="match.isFavorite ? 'text-red-500' : 'text-gray-300 hover:text-red-400'">
                                                <svg class="w-6 h-6" :fill="match.isFavorite ? 'currentColor' : 'none'"
                                                    stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                                </svg>
                                            </button>
                                            <div class="bg-emerald-500 text-white text-xs font-bold px-2.5 py-1 rounded-lg"
                                                x-text="match.score + '%'"></div>
                                        </div>
                                    </div>

                                    <!-- Comparison (REVERSED) -->
                                    <div class="p-4 bg-gray-50">
                                        <div class="flex gap-3 items-center mb-3">
                                            <!-- Your Portfolio (LEFT) -->
                                            <div class="flex-1 bg-white rounded-xl p-3 border-2 border-green-200">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <span
                                                        class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-medium">PortfÃ¶yÃ¼nÃ¼z</span>
                                                </div>
                                                <div class="w-full h-20 bg-gray-200 rounded-lg mb-2 overflow-hidden">
                                                    <img :src="match.portfolioImage" class="w-full h-full object-cover"
                                                        alt="Portfolio image">
                                                </div>
                                                <h4 class="font-bold text-gray-900 text-sm mb-1"
                                                    x-text="match.portfolioTitle">
                                                </h4>
                                                <p class="text-blue-600 font-bold text-sm mb-1"
                                                    x-text="match.portfolioPrice">
                                                </p>
                                                <p class="text-gray-500 text-xs" x-text="match.portfolioLocation"></p>
                                                <p class="text-gray-400 text-xs" x-text="match.portfolioSpecs"></p>
                                            </div>

                                            <!-- Arrow -->
                                            <div class="text-blue-400">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                                </svg>
                                            </div>

                                            <!-- Client Demand (RIGHT) -->
                                            <div class="flex-1 bg-white rounded-xl p-3 border border-gray-100">
                                                <!-- Client Info (Compact) -->
                                                <div class="flex items-center gap-2 mb-2 pb-2 border-b border-gray-100">
                                                    <div
                                                        class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                                                        <img x-show="match.clientAvatar" :src="match.clientAvatar"
                                                            class="w-full h-full object-cover">
                                                        <div x-show="!match.clientAvatar"
                                                            class="w-full h-full flex items-center justify-center bg-purple-600 text-white text-xs font-bold"
                                                            x-text="match.clientName?.charAt(0)"></div>
                                                    </div>
                                                    <div class="flex-1 min-w-0">
                                                        <p class="text-xs font-bold text-gray-900 truncate"
                                                            x-text="match.clientName"></p>
                                                        <p class="text-xs text-gray-500 truncate"
                                                            x-text="match.clientCompany || match.clientTitle"></p>
                                                    </div>
                                                    <!-- âœ… Trust Score Badge -->
                                                    <div x-show="match.brokerTrustScore"
                                                        class="flex items-center gap-1 px-2 py-0.5 bg-amber-50 rounded-lg border border-amber-200">
                                                        <span x-text="match.brokerTrustEmoji || 'ðŸ”°'"
                                                            class="text-xs"></span>
                                                        <span x-text="match.brokerTrustScore || '0'"
                                                            class="text-xs font-bold text-amber-700"></span>
                                                    </div>
                                                    <button @click.stop="showClientContact(match)"
                                                        class="text-purple-600 hover:text-purple-700 p-1 transition-colors"
                                                        title="Ä°letiÅŸime GeÃ§">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                            viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                                        </svg>
                                                    </button>
                                                </div>
                                                <h4 class="font-bold text-gray-900 text-sm mb-1"
                                                    x-text="match.demandTitle || 'Talep'"></h4>
                                                <p class="text-emerald-600 font-bold text-sm mb-1"
                                                    x-text="match.demandBudget">
                                                </p>
                                                <p class="text-gray-500 text-xs" x-text="match.demandLocation"></p>
                                                <p class="text-gray-400 text-xs" x-text="match.demandSpecs"></p>
                                            </div>
                                        </div>

                                        <!-- Criteria -->
                                        <div class="flex flex-wrap gap-2 mb-3">
                                            <span
                                                class="px-2.5 py-1 bg-emerald-50 text-emerald-700 rounded-full text-xs font-medium flex items-center gap-1">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd"
                                                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                        clip-rule="evenodd" />
                                                </svg>
                                                Konum
                                            </span>
                                            <span
                                                class="px-2.5 py-1 bg-emerald-50 text-emerald-700 rounded-full text-xs font-medium flex items-center gap-1">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd"
                                                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                                        clip-rule="evenodd" />
                                                </svg>
                                                BÃ¼tÃ§e
                                            </span>
                                        </div>

                                        <!-- Actions -->
                                        <div class="flex gap-2">
                                            <template x-if="match.status === 'pending' || !match.status">
                                                <div class="flex gap-2 w-full">
                                                    <template x-if="confirmingMatchId !== match.id">
                                                        <div class="flex gap-2 w-full">
                                                            <button @click="rejectMatch(match.id)"
                                                                class="flex-1 py-2.5 border-2 border-red-200 text-red-600 rounded-xl font-semibold text-sm hover:bg-red-50 flex items-center justify-center gap-1 transition-colors">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                                    viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                                </svg>
                                                                Reddet
                                                            </button>
                                                            <button @click="approveMatch(match.id)"
                                                                class="flex-1 py-2.5 bg-emerald-500 text-white rounded-xl font-semibold text-sm hover:bg-emerald-600 flex items-center justify-center gap-1 transition-colors">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                                    viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        stroke-width="2" d="M5 13l4 4L19 7" />
                                                                </svg>
                                                                Onayla
                                                            </button>
                                                        </div>
                                                    </template>
                                                    <template
                                                        x-if="confirmingMatchId === match.id && confirmingAction === 'approve'">
                                                        <div
                                                            class="w-full bg-emerald-50 border-2 border-emerald-200 rounded-xl p-3">
                                                            <p
                                                                class="text-sm text-emerald-900 font-semibold mb-2 text-center">
                                                                Onaylamak istediÄŸinize emin misiniz?</p>
                                                            <div class="flex gap-2">
                                                                <button
                                                                    @click="confirmingMatchId = null; confirmingAction = null"
                                                                    class="flex-1 py-2 bg-white border-2 border-gray-300 text-gray-700 rounded-lg font-medium text-sm hover:bg-gray-50 transition-colors">HayÄ±r</button>
                                                                <button @click="approveMatch(match.id)"
                                                                    class="flex-1 py-2 bg-emerald-500 text-white rounded-lg font-semibold text-sm hover:bg-emerald-600 transition-colors">Evet</button>
                                                            </div>
                                                        </div>
                                                    </template>
                                                    <template
                                                        x-if="confirmingMatchId === match.id && confirmingAction === 'reject'">
                                                        <div
                                                            class="w-full bg-red-50 border-2 border-red-200 rounded-xl p-3">
                                                            <p
                                                                class="text-sm text-red-900 font-semibold mb-2 text-center">
                                                                Reddetmek
                                                                istediÄŸinize emin misiniz?</p>
                                                            <div class="flex gap-2">
                                                                <button
                                                                    @click="confirmingMatchId = null; confirmingAction = null"
                                                                    class="flex-1 py-2 bg-white border-2 border-gray-300 text-gray-700 rounded-lg font-medium text-sm hover:bg-gray-50 transition-colors">HayÄ±r</button>
                                                                <button @click="rejectMatch(match.id)"
                                                                    class="flex-1 py-2 bg-red-500 text-white rounded-lg font-semibold text-sm hover:bg-red-600 transition-colors">Evet</button>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>
                                            <template x-if="match.status === 'approved'">
                                                <div
                                                    class="w-full bg-green-50 border-2 border-green-200 rounded-xl p-3 text-center">
                                                    <p class="text-green-700 font-semibold text-sm">âœ“ Bu eÅŸleÅŸme
                                                        onaylandÄ±
                                                    </p>
                                                </div>
                                            </template>
                                            <template x-if="match.status === 'rejected'">
                                                <div
                                                    class="w-full bg-red-50 border-2 border-red-200 rounded-xl p-3 text-center">
                                                    <p class="text-red-700 font-semibold text-sm">âœ— Bu eÅŸleÅŸme
                                                        reddedildi
                                                    </p>
                                                </div>
                                            </template>
                                            <!-- Empty State -->
                                            <div x-show="!filteredMatches || filteredMatches.length === 0"
                                                class="text-center py-12">
                                                <div
                                                    class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                                    <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                                                        </path>
                                                    </svg>
                                                </div>
                                                <p class="text-gray-500 font-medium">HenÃ¼z eÅŸleÅŸme bulunamadÄ±.</p>
                                                <p class="text-sm text-gray-400 mt-2">
                                                    Yeni portfÃ¶y ekleyerek eÅŸleÅŸme ÅŸansÄ±nÄ±zÄ± artÄ±rÄ±n.
                                                </p>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- Approved Matches (Onaylanan) -->
                    <template x-if="matchesTab === 'approved'">
                        <div class="space-y-3">
                            <template x-for="match in matches.sort((a, b) => b.score - a.score)" :key="match.id">
                                <div class="bg-white rounded-2xl border border-emerald-200 overflow-hidden">
                                    <!-- Header -->
                                    <div
                                        class="p-4 flex justify-between items-start border-b border-emerald-50 bg-emerald-50/50">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-2">
                                                <!-- Match Type Badge -->
                                                <template x-if="match.portfolioTitle">
                                                    <span
                                                        class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full font-medium">
                                                        ðŸ“¦ PortfÃ¶yÃ¼nÃ¼ze EÅŸleÅŸen Talep
                                                    </span>
                                                </template>
                                                <template
                                                    x-if="!match.portfolioTitle && (match.brokerName || match.demandBrokerName)">
                                                    <span
                                                        class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-medium">
                                                        ðŸ” Talebinize EÅŸleÅŸen PortfÃ¶y
                                                    </span>
                                                </template>
                                                <span
                                                    class="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-medium">
                                                    âœ“ OnaylandÄ±
                                                </span>
                                            </div>
                                            <h3 class="font-bold text-gray-900 mb-1">
                                                <span
                                                    x-text="(match.title || match.portfolioTitle || 'PortfÃ¶y') + ' â†” ' + (match.name || match.demandTitle || 'Talep')"></span>
                                            </h3>
                                            <p class="text-emerald-600 text-xs font-medium"
                                                x-text="match.score + '% EÅŸleÅŸme'">
                                            </p>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span
                                                class="px-2.5 py-1 bg-emerald-100 text-emerald-700 rounded-lg text-sm font-bold"
                                                x-text="match.score + '%'"></span>
                                        </div>
                                    </div>
                                    <!-- Content -->
                                    <div class="p-4">
                                        <div class="flex gap-4 items-start">
                                            <!-- Broker Info (Always show OTHER party) -->
                                            <div class="flex-1">
                                                <div class="flex items-center gap-3 mb-3">
                                                    <!-- Avatar -->
                                                    <template
                                                        x-if="match.clientAvatar || match.brokerAvatar || match.demandBrokerAvatar">
                                                        <img :src="match.clientAvatar || match.brokerAvatar || match.demandBrokerAvatar"
                                                            class="w-12 h-12 rounded-full object-cover border-2 border-emerald-200">
                                                    </template>
                                                    <template
                                                        x-if="!match.clientAvatar && !match.brokerAvatar && !match.demandBrokerAvatar">
                                                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg"
                                                            x-text="(match.clientName || match.brokerName || match.demandBrokerName || 'B')?.charAt(0)">
                                                        </div>
                                                    </template>
                                                    <!-- Broker Details -->
                                                    <div class="flex-1">
                                                        <div class="flex items-center gap-2">
                                                            <p class="font-bold text-gray-900 text-sm"
                                                                x-text="match.clientName || match.brokerName || match.demandBrokerName || 'Broker'">
                                                            </p>
                                                            <!-- âœ… Trust Score Badge -->
                                                            <div x-show="match.brokerTrustScore"
                                                                class="flex items-center gap-1 px-2 py-0.5 bg-amber-50 rounded-lg border border-amber-200">
                                                                <span x-text="match.brokerTrustEmoji || 'ðŸ”°'"
                                                                    class="text-xs"></span>
                                                                <span x-text="match.brokerTrustScore || '0'"
                                                                    class="text-xs font-bold text-amber-700"></span>
                                                            </div>
                                                        </div>
                                                        <p class="text-xs text-gray-500"
                                                            x-text="match.clientCompany || match.brokerCompany || match.demandBrokerCompany || 'Emlak DanÄ±ÅŸmanÄ±'">
                                                        </p>
                                                        <p class="text-xs text-emerald-600 font-medium mt-0.5"
                                                            x-text="match.clientTitle || match.brokerTitle || ''">
                                                        </p>
                                                    </div>
                                                </div>
                                                <!-- Property/Demand Details -->
                                                <div class="bg-gray-50 rounded-lg p-3">
                                                    <p class="text-sm font-semibold text-gray-900 mb-1"
                                                        x-text="match.title || match.portfolioTitle || match.demandTitle || ''">
                                                    </p>
                                                    <p class="text-sm text-emerald-600 font-medium mb-1"
                                                        x-text="match.price || match.portfolioPrice || match.clientBudget || ''">
                                                    </p>
                                                    <p class="text-xs text-gray-500"
                                                        x-text="match.location || match.portfolioLocation || match.clientLocation || ''">
                                                    </p>
                                                </div>
                                            </div>
                                            <!-- Contact Button -->
                                            <div class="flex items-center">
                                                <button
                                                    @click="sendMessage(match.clientName || match.brokerName || match.demandBrokerName, match.clientId || match.brokerId || match.demandBrokerId)"
                                                    class="px-4 py-2.5 bg-emerald-500 text-white rounded-xl font-semibold text-sm hover:bg-emerald-600 transition-colors flex items-center gap-2 shadow-sm">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                                    </svg>
                                                    Mesaj GÃ¶nder
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <!-- Empty State -->
                            <div x-show="!matches || matches.length === 0" class="text-center py-12">
                                <div
                                    class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                                <p class="text-gray-500 font-medium">HenÃ¼z onaylanan eÅŸleÅŸme yok.</p>
                                <p class="text-sm text-gray-400 mt-2">
                                    Bekleyen eÅŸleÅŸmeleri onaylayarak burada gÃ¶rÃ¼ntÃ¼leyin.
                                </p>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            <!-- NETWORK/AÄž VIEW -->
            <div x-show="currentTab === 'network'" class="pb-24 w-full" x-cloak>
                <!-- Header with Tabs -->
                <div class="px-5 py-4 border-b border-gray-100 bg-white sticky top-0 z-10">
                    <h2 class="text-xl font-bold text-gray-900">AÄŸÄ±m</h2>
                    <div class="flex gap-4 mt-4 overflow-x-auto no-scrollbar">
                        <button @click="networkTab = 'discover'"
                            class="pb-2 text-sm font-medium whitespace-nowrap border-b-2 transition-colors"
                            :class="networkTab === 'discover' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                            KeÅŸfet
                        </button>
                        <button @click="networkTab = 'my_connections'"
                            class="pb-2 text-sm font-medium whitespace-nowrap border-b-2 transition-colors"
                            :class="networkTab === 'my_connections' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                            BaÄŸlantÄ±larÄ±m (<span x-text="connections.length"></span>)
                        </button>
                        <button @click="networkTab = 'requests'"
                            class="pb-2 text-sm font-medium whitespace-nowrap border-b-2 transition-colors relative"
                            :class="networkTab === 'requests' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                            Ä°stekler
                            <span x-show="connectionRequests.length > 0"
                                class="absolute -top-1 -right-2 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full"
                                x-text="connectionRequests.length"></span>
                        </button>
                        <button @click="networkTab = 'network_demands'"
                            class="pb-2 text-sm font-medium whitespace-nowrap border-b-2 transition-colors"
                            :class="networkTab === 'network_demands' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                            AÄŸdan Talepler
                        </button>
                        <button @click="networkTab = 'network_portfolios'"
                            class="pb-2 text-sm font-medium whitespace-nowrap border-b-2 transition-colors"
                            :class="networkTab === 'network_portfolios' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                            AÄŸdan PortfÃ¶yler
                        </button>
                        <button @click="networkTab = 'blocked'"
                            class="pb-2 text-sm font-medium whitespace-nowrap border-b-2 transition-colors"
                            :class="networkTab === 'blocked' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
                            Engellenenler (<span x-text="blockedUsers.length"></span>)
                        </button>
                    </div>
                </div>

                <!-- DISCOVER TAB -->
                <div x-show="networkTab === 'discover'" class="p-5">
                    <div class="mb-4">
                        <input type="text" placeholder="Yeni brokerlar keÅŸfedin..."
                            class="w-full bg-gray-50 border-gray-200 rounded-xl px-4 py-2.5 text-sm">
                    </div>

                    <div class="grid grid-cols-1 gap-3">
                        <template x-for="broker in suggestedBrokers" :key="broker.id">
                            <div x-show="broker.id !== user.id && broker.connectionStatus === 'none'"
                                @click="viewBrokerProfile(broker.id)"
                                class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center gap-3 cursor-pointer hover:bg-gray-50 transition-colors">
                                <div class="w-12 h-12 rounded-full bg-gray-200 flex-shrink-0 overflow-hidden relative">
                                    <img x-show="broker.avatar_url" :src="broker.avatar_url"
                                        class="w-full h-full object-cover">
                                    <div x-show="!broker.avatar_url"
                                        class="w-full h-full flex items-center justify-center bg-purple-600 text-white font-bold text-lg"
                                        x-text="broker.name?.charAt(0).toUpperCase()"></div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-bold text-gray-900 truncate" x-text="broker.name"></h4>
                                    <p class="text-xs text-gray-500 truncate" x-text="broker.title || 'Broker'"></p>
                                    <span
                                        class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full mt-1 inline-block"
                                        x-text="broker.company || 'Åžirket Yok'"></span>
                                </div>
                                <button
                                    class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-sm font-semibold hover:bg-blue-100">
                                    Profil
                                </button>
                            </div>
                        </template>
                    </div>

                    <!-- BoÅŸ durum -->
                    <div x-show="!brokersLoading && suggestedBrokers.filter(b => b.connectionStatus === 'none').length === 0"
                        class="text-center py-10 text-gray-500">
                        <p>Ã–nerilen yeni broker bulunamadÄ±.</p>
                    </div>

                    <!-- Daha Fazla YÃ¼kle -->
                    <div class="mt-4 text-center">
                        <button x-show="brokersHasMore" @click="loadMoreBrokers()" :disabled="brokersLoading"
                            class="px-6 py-2.5 bg-white border border-gray-200 rounded-xl text-sm font-semibold text-gray-700 hover:bg-gray-50 transition-colors shadow-sm disabled:opacity-50">
                            <span x-show="!brokersLoading">Daha Fazla YÃ¼kle</span>
                            <span x-show="brokersLoading">YÃ¼kleniyor...</span>
                        </button>
                        <p x-show="!brokersHasMore && suggestedBrokers.length > 0" class="text-xs text-gray-400 py-2">
                            TÃ¼m brokerlar yÃ¼klendi.</p>
                    </div>
                </div>

                <!-- MY CONNECTIONS TAB -->
                <div x-show="networkTab === 'my_connections'" class="p-5">
                    <!-- Search -->
                    <div class="mb-4">
                        <input type="text" placeholder="BaÄŸlantÄ±larÄ±nÄ±zda arayÄ±n..."
                            class="w-full bg-gray-50 border-gray-200 rounded-xl px-4 py-2.5 text-sm">
                    </div>

                    <div x-show="connections.length === 0"
                        class="text-center py-10 text-gray-500 bg-white rounded-xl border border-dashed border-gray-200">
                        <div class="text-4xl mb-3">ðŸ¤</div>
                        <p class="font-medium text-gray-900">HenÃ¼z baÄŸlantÄ±nÄ±z yok</p>
                        <p class="text-sm">DiÄŸer brokerlarÄ± bulun ve aÄŸÄ±nÄ±za ekleyin.</p>
                    </div>

                    <div class="grid grid-cols-1 gap-3">
                        <template x-for="conn in connections" :key="conn.id">
                            <div @click="viewBrokerProfile(conn.broker_id)"
                                class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center gap-3 cursor-pointer hover:bg-gray-50 transition-colors">
                                <div class="w-12 h-12 rounded-full bg-gray-200 flex-shrink-0 overflow-hidden relative">
                                    <img x-show="conn.broker?.avatar_url" :src="conn.broker?.avatar_url"
                                        class="w-full h-full object-cover">
                                    <div x-show="!conn.broker?.avatar_url"
                                        class="w-full h-full flex items-center justify-center bg-blue-600 text-white font-bold text-lg"
                                        x-text="conn.broker?.name?.charAt(0).toUpperCase()"></div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <h4 class="font-bold text-gray-900 truncate" x-text="conn.broker?.name"></h4>
                                        <!-- âœ… Trust Score Badge -->
                                        <div x-show="conn.broker?.trust_scores?.total_score"
                                            class="flex items-center gap-1 px-2 py-0.5 bg-amber-50 rounded-lg border border-amber-200">
                                            <span x-text="conn.broker?.trust_scores?.level_emoji || 'ðŸ”°'"
                                                class="text-xs"></span>
                                            <span x-text="conn.broker?.trust_scores?.total_score || '0'"
                                                class="text-xs font-bold text-amber-700"></span>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 truncate" x-text="conn.broker?.title || 'Broker'">
                                    </p>
                                    <p class="text-xs text-gray-400 truncate" x-text="conn.broker?.company"></p>
                                </div>
                                <!-- Contact Buttons -->
                                <div class="flex gap-2">
                                    <!-- Message Button -->
                                    <button @click.stop="openConversation(conn.broker_id, conn.broker?.name)"
                                        class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors"
                                        title="Mesaj GÃ¶nder">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                        </svg>
                                    </button>
                                    <!-- Phone Button -->
                                    <button @click.stop="showConnectionContact(conn)"
                                        class="p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-colors"
                                        title="Telefon NumarasÄ±nÄ± GÃ¶ster">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- REQUESTS TAB -->
                <div x-show="networkTab === 'requests'" class="p-5">

                    <!-- RECEIVED REQUESTS -->
                    <h3 class="font-bold text-gray-900 mb-3 text-sm uppercase tracking-wide">Gelen Ä°stekler</h3>
                    <div x-show="connectionRequests.length === 0"
                        class="text-gray-500 text-sm mb-6 italic bg-gray-50 p-3 rounded-lg border border-dashed border-gray-200 text-center">
                        Bekleyen istek yok.
                    </div>
                    <div class="space-y-3 mb-8">
                        <template x-for="req in connectionRequests" :key="req.id">
                            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm animate-fade-in">
                                <div class="flex items-center gap-3 mb-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-gray-200 flex-shrink-0 overflow-hidden relative">
                                        <img x-show="req.requester?.avatar_url" :src="req.requester?.avatar_url"
                                            class="w-full h-full object-cover">
                                        <div x-show="!req.requester?.avatar_url"
                                            class="w-full h-full flex items-center justify-center bg-blue-600 text-white font-bold"
                                            x-text="req.requester?.name?.charAt(0).toUpperCase()"></div>
                                    </div>
                                    <div>
                                        <p class="font-bold text-sm" x-text="req.requester?.name"></p>
                                        <p class="text-xs text-gray-500" x-text="req.requester?.title || 'Broker'"></p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="acceptConnectionRequest(req.id)"
                                        class="flex-1 bg-blue-600 text-white py-1.5 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors">Kabul
                                        Et</button>
                                    <button @click="rejectConnectionRequest(req.id)"
                                        class="flex-1 bg-gray-100 text-gray-700 py-1.5 rounded-lg text-sm font-semibold hover:bg-gray-200 transition-colors">Reddet</button>
                                    <button @click="viewBrokerProfile(req.requester_id)"
                                        class="px-3 bg-gray-50 text-gray-600 rounded-lg text-sm font-semibold hover:bg-gray-100 transition-colors">Profil</button>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- SENT REQUESTS -->
                    <h3 class="font-bold text-gray-900 mb-3 text-sm uppercase tracking-wide">GÃ¶nderilen Ä°stekler</h3>
                    <div x-show="sentRequests.length === 0"
                        class="text-gray-500 text-sm italic bg-gray-50 p-3 rounded-lg border border-dashed border-gray-200 text-center">
                        Bekleyen gÃ¶nderilmiÅŸ istek yok.
                    </div>
                    <div class="space-y-3">
                        <template x-for="req in sentRequests" :key="req.id">
                            <div
                                class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-full bg-gray-200 flex-shrink-0 overflow-hidden relative">
                                        <img x-show="req.receiver?.avatar_url" :src="req.receiver?.avatar_url"
                                            class="w-full h-full object-cover">
                                        <div x-show="!req.receiver?.avatar_url"
                                            class="w-full h-10 flex items-center justify-center bg-gray-400 text-white font-bold"
                                            x-text="req.receiver?.name?.charAt(0).toUpperCase()"></div>
                                    </div>
                                    <div>
                                        <p class="font-bold text-sm" x-text="req.receiver?.name"></p>
                                        <span
                                            class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">Bekliyor</span>
                                    </div>
                                </div>
                                <button @click="viewBrokerProfile(req.receiver_id)"
                                    class="text-blue-600 text-sm font-medium hover:underline">GÃ¶rÃ¼ntÃ¼le</button>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- NETWORK DEMANDS TAB -->
                <div x-show="networkTab === 'network_demands'" class="p-5">
                    <!-- BoÅŸ Durum -->
                    <div x-show="networkDemands.length === 0"
                        class="text-center py-10 bg-white rounded-xl border border-dashed border-gray-200">
                        <div class="text-4xl mb-3">ðŸ“­</div>
                        <p class="font-medium text-gray-900">HenÃ¼z aÄŸdan talep yok</p>
                        <p class="text-sm text-gray-500">BaÄŸlantÄ±larÄ±nÄ±z talep eklediÄŸinde burada gÃ¶rÃ¼necektir.</p>
                    </div>

                    <!-- Talepler Listesi -->
                    <div class="space-y-3">
                        <template x-for="demand in networkDemands" :key="demand.id">
                            <div
                                class="bg-white rounded-xl border border-gray-100 shadow-sm p-4 hover:shadow-md transition-shadow">
                                <!-- Broker Bilgisi (Ãœstte) -->
                                <div class="flex items-center gap-2 mb-3 pb-3 border-b border-gray-100">
                                    <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                                        <img x-show="demand.broker_avatar_url" :src="demand.broker_avatar_url"
                                            class="w-full h-full object-cover">
                                        <div x-show="!demand.broker_avatar_url"
                                            class="w-full h-full flex items-center justify-center bg-blue-600 text-white text-xs font-bold"
                                            x-text="demand.broker_name?.charAt(0).toUpperCase()"></div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-bold text-gray-900 truncate" x-text="demand.broker_name">
                                        </p>
                                        <p class="text-xs text-gray-500 truncate"
                                            x-text="demand.broker_title || 'Broker'">
                                        </p>
                                    </div>
                                    <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-full">AÄŸÄ±mdan</span>
                                </div>


                                <!-- Talep DetaylarÄ± -->
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div x-show="demand.title">
                                        <span class="text-gray-500">BaÅŸlÄ±k:</span>
                                        <span class="font-medium text-gray-900" x-text="demand.title"></span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">BÃ¶lge:</span>
                                        <span class="font-medium text-gray-900"
                                            x-text="formatLocation(demand.district, demand.city)"></span>
                                    </div>
                                    <div x-show="demand.budget && demand.budget > 0">
                                        <span class="text-gray-500">BÃ¼tÃ§e:</span>
                                        <span class="font-medium text-green-700"
                                            x-text="formatBudget(demand.budget, demand.max_budget)"></span>
                                    </div>
                                    <div x-show="demand.category">
                                        <span class="text-gray-500">Kategori:</span>
                                        <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs font-medium"
                                            x-text="demand.category"></span>
                                    </div>
                                    <div x-show="demand.rooms">
                                        <span class="text-gray-500">Oda:</span>
                                        <span class="font-medium text-gray-900" x-text="demand.rooms"></span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Tarih:</span>
                                        <span class="font-medium text-gray-900"
                                            x-text="formatDate(demand.created_at)"></span>
                                    </div>
                                    <!-- Urgency Badge (Full Width) -->
                                    <div x-show="demand.is_urgent" class="col-span-2">
                                        <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-bold">
                                            ðŸ”¥ ACÄ°L
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- NETWORK PORTFOLIOS TAB -->
                <div x-show="networkTab === 'network_portfolios'" class="p-5">
                    <!-- BoÅŸ Durum -->
                    <div x-show="networkPortfolios.length === 0" class="text-center py-10">
                        <div class="text-4xl mb-3">ðŸ¢</div>
                        <p class="font-medium text-gray-900">HenÃ¼z aÄŸdan portfÃ¶y yok</p>
                        <p class="text-sm text-gray-500 mt-1">BaÄŸlantÄ±larÄ±nÄ±z portfÃ¶y eklediÄŸinde burada gÃ¶rÃ¼necektir.
                        </p>
                    </div>

                    <!-- PortfÃ¶yler Listesi -->
                    <div class="space-y-3">
                        <template x-for="portfolio in networkPortfolios" :key="portfolio.id">
                            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-4">
                                <!-- Broker Bilgisi -->
                                <div class="flex items-center gap-2 mb-3 pb-3 border-b border-gray-100">
                                    <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                                        <template x-if="portfolio.broker_avatar_url">
                                            <img :src="portfolio.broker_avatar_url" class="w-full h-full object-cover">
                                        </template>
                                        <template x-if="!portfolio.broker_avatar_url">
                                            <div class="w-full h-full flex items-center justify-center bg-blue-600 text-white text-xs font-bold"
                                                x-text="portfolio.broker_name?.charAt(0).toUpperCase()"></div>
                                        </template>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-bold text-gray-900 truncate"
                                            x-text="portfolio.broker_name">
                                        </p>
                                        <p class="text-xs text-gray-500 truncate"
                                            x-text="portfolio.broker_title || 'Broker'">
                                        </p>
                                    </div>
                                    <span
                                        class="text-xs bg-green-50 text-green-700 px-2 py-1 rounded-full flex-shrink-0">AÄŸÄ±mdan</span>
                                </div>

                                <!-- PortfÃ¶y DetaylarÄ± -->
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div x-show="portfolio.title" class="col-span-2">
                                        <span class="text-gray-500">BaÅŸlÄ±k:</span>
                                        <span class="font-medium text-gray-900" x-text="portfolio.title"></span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">BÃ¶lge:</span>
                                        <span class="font-medium text-gray-900"
                                            x-text="formatLocation(portfolio.district, portfolio.city)"></span>
                                    </div>
                                    <div x-show="portfolio.rooms">
                                        <span class="text-gray-500">Oda:</span>
                                        <span class="font-medium text-gray-900" x-text="portfolio.rooms"></span>
                                    </div>
                                    <div x-show="portfolio.category">
                                        <span class="text-gray-500">Kategori:</span>
                                        <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs font-medium"
                                            x-text="portfolio.category"></span>
                                    </div>
                                    <div x-show="portfolio.price && portfolio.price > 0">
                                        <span class="text-gray-500">Fiyat:</span>
                                        <span class="font-medium text-green-700"
                                            x-text="formatBudget(portfolio.price, null)"></span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Tarih:</span>
                                        <span class="font-medium text-gray-900"
                                            x-text="formatDate(portfolio.created_at)"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- BLOCKED USERS TAB / ENGELLENMÄ°Åž KULLANICILAR -->
                <div x-show="networkTab === 'blocked'" class="p-5">
                    <!-- BoÅŸ Durum -->
                    <div x-show="blockedUsers.length === 0" class="text-center py-10">
                        <div class="text-4xl mb-3">âœ…</div>
                        <p class="font-medium text-gray-900">EngellenmiÅŸ kullanÄ±cÄ± yok</p>
                        <p class="text-sm text-gray-500 mt-1">Ä°stenmeyen kullanÄ±cÄ±larÄ± engelleyerek aÄŸÄ±nÄ±zdan
                            kaldÄ±rabilirsiniz.</p>
                    </div>

                    <!-- Blocked Users List -->
                    <div x-show="blockedUsers.length > 0" class="space-y-3">
                        <template x-for="profile in blockedUserProfiles" :key="profile.id">
                            <div
                                class="bg-white rounded-xl border border-gray-100 shadow-sm p-4 flex items-center gap-4">
                                <!-- Avatar -->
                                <div class="w-12 h-12 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                                    <template x-if="profile.avatar_url">
                                        <img :src="profile.avatar_url" class="w-full h-full object-cover">
                                    </template>
                                    <template x-if="!profile.avatar_url">
                                        <div class="w-full h-full flex items-center justify-center bg-red-600 text-white text-lg font-bold"
                                            x-text="profile.name?.charAt(0).toUpperCase()"></div>
                                    </template>
                                </div>

                                <!-- User Info -->
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-bold text-gray-900 truncate" x-text="profile.name"></p>
                                    <p class="text-xs text-gray-500 truncate" x-text="profile.title || 'Broker'"></p>
                                    <p class="text-xs text-gray-400 truncate" x-text="profile.company"></p>
                                </div>

                                <!-- Unblock Button -->
                                <button @click="unblockUser(profile.id)"
                                    class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors flex-shrink-0">
                                    Engeli KaldÄ±r
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            <!-- PORTFOLIOS/PORTFÃ–YLER VIEW -->
            <div x-show="currentTab === 'portfolios'" class="pb-24 w-full" x-cloak>
                <!-- Header -->
                <div class="px-5 py-4 border-b border-gray-100">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">PortfÃ¶ylerim</h2>
                            <p class="text-sm text-gray-500 mt-1">TÃ¼m gayrimenkullerinizi yÃ¶netin</p>
                        </div>
                        <button @click.prevent="showAddModal = true; editingPortfolioId = null"
                            class="hidden md:flex items-center gap-2 bg-blue-600 text-white px-4 py-2.5 rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4">
                                </path>
                            </svg>
                            <span class="font-medium">Yeni Ekle</span>
                        </button>
                    </div>
                </div>

                <!-- Summary Bar -->
                <div class="px-5 py-4 bg-white border-b border-gray-50">
                    <div class="flex gap-4 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">Toplam:</span>
                            <span class="font-bold text-blue-600" x-text="portfolios.length">0</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">SatÄ±lÄ±k:</span>
                            <span class="font-bold text-emerald-600"
                                x-text="portfolios.filter(p => p.type === 'SatÄ±lÄ±k').length">0</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500">KiralÄ±k:</span>
                            <span class="font-bold text-orange-600"
                                x-text="portfolios.filter(p => p.type === 'KiralÄ±k').length">0</span>
                        </div>
                    </div>
                </div>

                <!-- Filter Buttons & View Controls -->
                <div class="px-5 py-3 border-b border-gray-50">
                    <!-- SatÄ±lÄ±k/KiralÄ±k Toggle -->
                    <div class="flex gap-2 mb-3">
                        <button @click="currentPortfolioListingType = 'satilik'"
                            class="px-4 py-2 rounded-xl text-sm font-semibold transition-all"
                            :class="currentPortfolioListingType === 'satilik' ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-200' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                            <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path
                                    d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                            </svg>
                            SatÄ±lÄ±k
                        </button>
                        <button @click="currentPortfolioListingType = 'kiralik'"
                            class="px-4 py-2 rounded-xl text-sm font-semibold transition-all"
                            :class="currentPortfolioListingType === 'kiralik' ? 'bg-orange-500 text-white shadow-lg shadow-orange-200' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            KiralÄ±k
                        </button>
                    </div>

                    <!-- Category Filter Buttons -->
                    <div class="flex gap-2 mb-3 overflow-x-auto hide-scrollbar">
                        <button @click="currentPortfolioCategory = 'all'"
                            class="px-3 py-1.5 rounded-lg text-xs font-semibold transition-all whitespace-nowrap"
                            :class="currentPortfolioCategory === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                            TÃ¼mÃ¼
                        </button>
                        <button @click="currentPortfolioCategory = 'Villa'"
                            class="px-3 py-1.5 rounded-lg text-xs font-semibold transition-all whitespace-nowrap"
                            :class="currentPortfolioCategory === 'Villa' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                            Villa
                        </button>
                        <button @click="currentPortfolioCategory = 'Daire'"
                            class="px-3 py-1.5 rounded-lg text-xs font-semibold transition-all whitespace-nowrap"
                            :class="currentPortfolioCategory === 'Daire' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                            Daire
                        </button>
                        <button @click="currentPortfolioCategory = 'Arsa'"
                            class="px-3 py-1.5 rounded-lg text-xs font-semibold transition-all whitespace-nowrap"
                            :class="currentPortfolioCategory === 'Arsa' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                            Arsa
                        </button>
                        <button @click="currentPortfolioCategory = 'Ä°ÅŸyeri'"
                            class="px-3 py-1.5 rounded-lg text-xs font-semibold transition-all whitespace-nowrap"
                            :class="currentPortfolioCategory === 'Ä°ÅŸyeri' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'">
                            Ä°ÅŸyeri
                        </button>
                    </div>

                    <!-- View Controls -->
                    <div class="flex gap-2 items-center justify-between">
                        <div class="flex gap-2">
                            <button class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-sm font-medium">
                                <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path
                                        d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" />
                                </svg>
                                Liste
                            </button>
                        </div>
                        <div class="flex gap-2 items-center">
                            <button class="text-gray-500 p-2 hover:bg-gray-100 rounded-lg">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                                </svg>
                            </button>
                            <!-- Sort Dropdown -->
                            <select x-model="portfolioSortOrder"
                                class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 text-gray-600 focus:outline-none focus:border-blue-500">
                                <option>Tarih</option>
                                <option>Fiyat (DÃ¼ÅŸÃ¼k)</option>
                                <option>Fiyat (YÃ¼ksek)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Properties Grid - 3 columns -->
                <div class="px-5 py-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <template x-for="portfolio in filteredMyPortfolios" :key="portfolio.id">
                        <div
                            class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                            <!-- Image -->
                            <div class="relative">
                                <div class="h-32 bg-gray-200 overflow-hidden">
                                    <img :src="portfolio.image || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?auto=format&fit=crop&w=800&q=80'"
                                        class="w-full h-full object-cover" alt="">
                                </div>
                                <!-- Type Badge -->
                                <div class="absolute top-2 left-2 text-white text-xs font-bold px-2 py-1 rounded-lg"
                                    :class="portfolio.type === 'KiralÄ±k' ? 'bg-orange-500' : 'bg-emerald-500'"
                                    x-text="portfolio.type">
                                </div>
                            </div>

                            <!-- Content -->
                            <div class="p-3">
                                <!-- Price -->
                                <div class="font-bold text-base mb-1"
                                    :class="portfolio.type === 'KiralÄ±k' ? 'text-orange-600' : 'text-emerald-600'"
                                    x-text="formatPrice(portfolio.price)"></div>

                                <!-- Title -->
                                <h3 class="font-bold text-gray-900 text-sm mb-1" x-text="portfolio.title"></h3>

                                <!-- Category Badge -->
                                <div class="mb-2">
                                    <span class="text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full font-medium"
                                        x-text="portfolio.category"></span>
                                </div>

                                <!-- Location -->
                                <p class="text-gray-500 text-xs mb-2 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                                            clip-rule="evenodd" />
                                    </svg>
                                    <span x-text="portfolio.location || portfolio.district"></span>
                                </p>

                                <!-- Specs -->
                                <div class="flex items-center gap-2 text-gray-400 text-xs mb-2">
                                    <span class="flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path
                                                d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                                        </svg>
                                        <span x-text="portfolio.rooms || '3+1'"></span>
                                    </span>
                                    <span>â€¢</span>
                                    <span class="flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                                        </svg>
                                        <span x-text="portfolio.area || '140mÂ²'"></span>
                                    </span>
                                    <span>â€¢</span>
                                    <span class="flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        <span x-text="portfolio.age || '5y'"></span>
                                    </span>
                                </div>

                                <!-- Features -->
                                <div class="flex flex-wrap gap-1 mb-2"
                                    x-show="portfolio.features && portfolio.features.length > 0">
                                    <template x-for="(feature, fIdx) in (portfolio.features || []).slice(0, 2)"
                                        :key="'feature-' + fIdx">
                                        <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full"
                                            x-text="feature"></span>
                                    </template>
                                </div>

                                <!-- Actions -->
                                <div class="flex gap-2">
                                    <button @click="editPortfolio(portfolio.id)"
                                        class="flex-1 py-1.5 border border-gray-200 rounded-lg text-xs font-medium text-gray-600 hover:bg-gray-50 transition-colors">
                                        <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                        DÃ¼zenle
                                    </button>
                                    <button @click="deletePortfolio(portfolio.id)"
                                        class="py-1.5 px-2 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 transition-colors">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Empty State -->
                    <template x-if="filteredMyPortfolios.length === 0">
                        <div class="col-span-3 text-center py-12">
                            <div
                                class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">PortfÃ¶y BulunamadÄ±</h3>
                            <p class="text-sm text-gray-500 mb-4">
                                <span x-text="currentPortfolioListingType === 'kiralik' ? 'KiralÄ±k' : 'SatÄ±lÄ±k'"></span>
                                portfÃ¶yÃ¼nÃ¼z yok.
                            </p>
                            <button
                                class="px-4 py-2 bg-blue-600 text-white rounded-xl text-sm font-medium hover:bg-blue-700 transition-colors">
                                + Yeni PortfÃ¶y Ekle
                            </button>
                        </div>
                    </template>
                </div>

                <!-- FAB Button -->
                <button
                    class="fixed bottom-24 right-5 md:bottom-8 md:right-8 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg shadow-blue-300 flex items-center justify-center hover:bg-blue-700 transition-colors z-40">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </button>
            </div>

            <!-- PROFILE VIEW -->
            <div x-show="currentTab === 'profile'" class="pb-24 w-full" x-cloak>
                <!-- Header -->
                <div class="px-5 py-4 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-900">Profilim</h2>
                </div>

                <!-- Profile Content -->
                <div class="max-w-4xl mx-auto p-5">
                    <!-- Cover Photo -->
                    <div
                        class="h-48 bg-gradient-to-r from-blue-500 to-purple-600 rounded-t-2xl relative overflow-hidden group">
                        <img x-show="userProfile?.cover_url" :src="userProfile?.cover_url"
                            class="w-full h-full object-cover">
                        <!-- Cover Upload Button (appears on hover) -->
                        <div
                            class="absolute inset-0 bg-black bg-opacity-40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <label
                                class="cursor-pointer bg-white text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition-colors">
                                ðŸ“· Kapak FotoÄŸrafÄ± DeÄŸiÅŸtir
                                <input type="file" accept="image/*" @change="handleCoverUpload" class="hidden">
                            </label>
                        </div>
                    </div>

                    <!-- Profile Card -->
                    <div class="bg-white rounded-b-2xl shadow-lg p-6 -mt-16 relative">
                        <!-- Avatar & Basic Info -->
                        <div class="flex items-end gap-4 mb-6">
                            <div
                                class="w-32 h-32 rounded-full border-4 border-white shadow-lg bg-gray-200 overflow-hidden flex-shrink-0 relative group">
                                <img x-show="userProfile?.avatar_url" :src="userProfile?.avatar_url"
                                    class="w-full h-full object-cover">
                                <div x-show="!userProfile?.avatar_url"
                                    class="w-full h-full flex items-center justify-center text-4xl font-bold text-white bg-blue-600"
                                    x-text="user?.email?.charAt(0).toUpperCase()">
                                </div>
                                <!-- Avatar Upload Button (appears on hover) -->
                                <div
                                    class="absolute inset-0 bg-black bg-opacity-40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                    <label
                                        class="cursor-pointer bg-white text-gray-800 px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-gray-100 transition-colors">
                                        ðŸ“· DeÄŸiÅŸtir
                                        <input type="file" accept="image/*" @change="handleAvatarUpload" class="hidden">
                                    </label>
                                </div>
                            </div>

                            <div class="flex-1 mb-2">
                                <h1 class="text-2xl font-bold text-gray-900"
                                    x-text="userProfile?.name || user?.email || 'Ä°sim BelirtilmemiÅŸ'"></h1>
                                <p class="text-gray-600" x-text="userProfile?.title || 'Unvan BelirtilmemiÅŸ'"></p>
                                <p class="text-sm text-gray-500" x-show="userProfile?.company"
                                    x-text="userProfile?.company">
                                </p>

                                <!-- Verified Badge -->
                                <div x-show="userProfile?.ttyb_verified" class="mt-2">
                                    <span
                                        class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full">
                                        âœ“ DoÄŸrulanmÄ±ÅŸ Broker
                                    </span>
                                </div>
                            </div>

                            <button @click="editMode = true"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                DÃ¼zenle
                            </button>
                        </div>

                        <!-- Bio -->
                        <div class="border-t pt-4">
                            <h3 class="font-semibold text-gray-900 mb-2">HakkÄ±mda</h3>
                            <p class="text-gray-700 whitespace-pre-wrap"
                                x-text="userProfile?.bio || 'HenÃ¼z biyografi eklenmemiÅŸ.'"></p>
                        </div>

                        <!-- Trust Score Breakdown -->
                        <div class="border-t pt-4 mt-4">
                            <div
                                class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl border border-amber-200 p-5">
                                <h3 class="font-bold text-gray-900 text-lg mb-4 flex items-center gap-2">
                                    ðŸ† GÃ¼ven PuanÄ±nÄ±z
                                </h3>

                                <!-- Main Score -->
                                <div class="flex items-center gap-4 mb-5">
                                    <div class="text-5xl font-bold text-amber-600"
                                        x-text="userProfile.trustScore?.total || 0">
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-2xl"
                                                x-text="userProfile.trustScore?.levelEmoji || 'ðŸ”°'"></span>
                                            <span class="font-semibold text-gray-900"
                                                x-text="userProfile.trustScore?.levelName || 'HesaplanÄ±yor...'"></span>
                                        </div>
                                        <p class="text-sm text-gray-500">100 Ã¼zerinden</p>
                                    </div>
                                </div>

                                <!-- Breakdown Progress Bars -->
                                <div class="space-y-3">
                                    <!-- Profile Score -->
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-600">ðŸ“‹ Profil Tamamlama</span>
                                            <span class="font-medium"
                                                x-text="(userProfile.trustScore?.profile || 0) + '/40'"></span>
                                        </div>
                                        <div class="h-2 bg-white rounded-full border border-gray-200">
                                            <div class="h-full bg-blue-500 rounded-full transition-all duration-500"
                                                :style="`width: ${((userProfile.trustScore?.profile || 0) / 40) * 100}%`">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Login Score -->
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-600">ðŸ”‘ GiriÅŸ AktifliÄŸi</span>
                                            <span class="font-medium"
                                                x-text="(userProfile.trustScore?.login || 0) + '/20'"></span>
                                        </div>
                                        <div class="h-2 bg-white rounded-full border border-gray-200">
                                            <div class="h-full bg-green-500 rounded-full transition-all duration-500"
                                                :style="`width: ${((userProfile.trustScore?.login || 0) / 20) * 100}%`">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Data Score -->
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-600">ðŸ“Š Veri GÃ¼ncelliÄŸi</span>
                                            <span class="font-medium"
                                                x-text="(userProfile.trustScore?.data || 0) + '/20'"></span>
                                        </div>
                                        <div class="h-2 bg-white rounded-full border border-gray-200">
                                            <div class="h-full bg-purple-500 rounded-full transition-all duration-500"
                                                :style="`width: ${((userProfile.trustScore?.data || 0) / 20) * 100}%`">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Reaction Score -->
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-600">ðŸ¤ Reaksiyon</span>
                                            <span class="font-medium"
                                                x-text="(userProfile.trustScore?.reaction || 0) + '/20'"></span>
                                        </div>
                                        <div class="h-2 bg-white rounded-full border border-gray-200">
                                            <div class="h-full bg-orange-500 rounded-full transition-all duration-500"
                                                :style="`width: ${((userProfile.trustScore?.reaction || 0) / 20) * 100}%`">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tip -->
                                <div class="mt-4 p-3 bg-white rounded-lg border border-amber-200">
                                    <p class="text-sm text-gray-600">
                                        ðŸ’¡ <strong>PuanÄ±nÄ± artÄ±r:</strong> Profilini tamamla, portfÃ¶y/talep ekle ve
                                        eÅŸleÅŸmelere hÄ±zlÄ± cevap ver!
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Service Areas -->
                        <div class="border-t pt-4 mt-4"
                            x-show="userProfile?.service_areas && userProfile.service_areas.length > 0">
                            <h3 class="font-semibold text-gray-900 mb-3">Hizmet BÃ¶lgeleri</h3>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="(area, aIdx) in userProfile.service_areas" :key="'user-area-' + aIdx">
                                    <span
                                        class="inline-flex items-center gap-2 bg-blue-50 text-blue-700 px-3 py-1.5 rounded-lg text-sm border border-blue-200">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                                                clip-rule="evenodd" />
                                        </svg>
                                        <span x-text="`${area.district}, ${area.city}`"></span>
                                    </span>
                                </template>
                            </div>
                        </div>

                        <!-- Specialties -->
                        <div class="border-t pt-4 mt-4"
                            x-show="userProfile?.specialties && userProfile.specialties.length > 0">
                            <h3 class="font-semibold text-gray-900 mb-3">UzmanlÄ±k AlanlarÄ±</h3>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="(specialty, sIdx) in userProfile.specialties"
                                    :key="'user-specialty-' + sIdx">
                                    <span
                                        class="inline-flex items-center gap-1 bg-purple-50 text-purple-700 px-3 py-1.5 rounded-full text-sm border border-purple-200 font-medium">
                                        <span x-text="`#${specialty}`"></span>
                                    </span>
                                </template>
                            </div>
                        </div>

                        <!-- Contact Info -->
                        <div class="border-t pt-4 mt-4" x-show="userProfile?.phone">
                            <h3 class="font-semibold text-gray-900 mb-2">Ä°letiÅŸim</h3>
                            <p class="text-gray-700">
                                <span class="font-medium">Telefon:</span>
                                <span x-text="userProfile?.phone"></span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Edit Mode Modal -->
                <div x-show="editMode"
                    class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" x-cloak>
                    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
                        <h2 class="text-2xl font-bold mb-4">Profili DÃ¼zenle</h2>

                        <form @submit.prevent="saveProfile()">
                            <!-- Name -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold mb-1">Ä°sim Soyisim *</label>
                                <input x-model="userProfile.name" type="text" required
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                            </div>

                            <!-- Title -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold mb-1">Unvan</label>
                                <input x-model="userProfile.title" type="text" placeholder="Ã–rn: Gayrimenkul DanÄ±ÅŸmanÄ±"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                            </div>

                            <!-- Company -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold mb-1">Åžirket / Marka</label>
                                <input x-model="userProfile.company" type="text" placeholder="Ã–rn: Remax Hills"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                            </div>

                            <!-- Phone -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold mb-1">Telefon</label>
                                <input x-model="userProfile.phone" type="tel" placeholder="05XX XXX XX XX"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
                            </div>

                            <!-- Bio -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold mb-1">HakkÄ±mda</label>
                                <textarea x-model="userProfile.bio" rows="4"
                                    placeholder="Kendinizi tanÄ±tÄ±n, deneyimlerinizi paylaÅŸÄ±n..."
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500"></textarea>
                            </div>

                            <!-- Service Areas (Hizmet BÃ¶lgeleri) -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold mb-2">Hizmet BÃ¶lgeleri</label>
                                <p class="text-xs text-gray-500 mb-3">Hangi bÃ¶lgelerde aktif olarak Ã§alÄ±ÅŸÄ±yorsunuz?</p>

                                <!-- Add New Area -->
                                <div class="flex gap-2 mb-3">
                                    <select x-model="tempServiceCity" @change="tempServiceDistrict = ''"
                                        class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                                        <option value="">Åžehir SeÃ§in</option>
                                        <template x-for="city in Object.keys(locationData)" :key="city">
                                            <option :value="city" x-text="city"></option>
                                        </template>
                                    </select>

                                    <select x-model="tempServiceDistrict" :disabled="!tempServiceCity"
                                        class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500 disabled:bg-gray-100">
                                        <option value="">Ä°lÃ§e SeÃ§in</option>
                                        <template x-if="tempServiceCity && locationData[tempServiceCity]">
                                            <template x-for="district in Object.keys(locationData[tempServiceCity])"
                                                :key="district">
                                                <option :value="district" x-text="district"></option>
                                            </template>
                                        </template>
                                    </select>

                                    <button type="button" @click="addServiceArea()"
                                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                        + Ekle
                                    </button>
                                </div>

                                <!-- Display Added Areas -->
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="(area, index) in userProfile.service_areas" :key="index">
                                        <span
                                            class="inline-flex items-center gap-2 bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd"
                                                    d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                            <span x-text="`${area.district}, ${area.city}`"></span>
                                            <button type="button" @click="removeServiceArea(index)"
                                                class="hover:text-blue-900">
                                                Ã—
                                            </button>
                                        </span>
                                    </template>
                                    <span x-show="userProfile.service_areas.length === 0" class="text-sm text-gray-400">
                                        HenÃ¼z bÃ¶lge eklenmemiÅŸ
                                    </span>
                                </div>
                            </div>

                            <!-- Specialties (UzmanlÄ±k AlanlarÄ±) -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold mb-2">UzmanlÄ±k AlanlarÄ±</label>
                                <p class="text-xs text-gray-500 mb-3">Hangi alanlarda uzmansÄ±nÄ±z? (Ã–rn: LÃ¼ks Konut,
                                    Ticari,
                                    Arsa)</p>

                                <!-- Add New Specialty -->
                                <div class="flex gap-2 mb-3">
                                    <input x-model="tempSpecialty" @keydown.enter.prevent="addSpecialty()" type="text"
                                        placeholder="UzmanlÄ±k alanÄ± yazÄ±n ve Enter'a basÄ±n"
                                        class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                                    <button type="button" @click="addSpecialty()"
                                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
                                        + Ekle
                                    </button>
                                </div>

                                <!-- Display Added Specialties -->
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="(specialty, index) in userProfile.specialties" :key="index">
                                        <span
                                            class="inline-flex items-center gap-2 bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">
                                            <span x-text="`#${specialty}`"></span>
                                            <button type="button" @click="removeSpecialty(index)"
                                                class="hover:text-purple-900 font-bold">
                                                Ã—
                                            </button>
                                        </span>
                                    </template>
                                    <span x-show="userProfile.specialties.length === 0" class="text-sm text-gray-400">
                                        HenÃ¼z uzmanlÄ±k alanÄ± eklenmemiÅŸ
                                    </span>
                                </div>
                            </div>

                            <!-- TTYB Privacy Note -->
                            <div class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <label class="block text-sm font-semibold mb-1">TTYB No (Opsiyonel)</label>
                                <input x-model="userProfile.ttyb_number" type="text" placeholder="12345"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500 mb-2">
                                <p class="text-xs text-blue-700">
                                    ðŸ”’ Bu bilgi profilinizde <strong>gÃ¶sterilmez</strong>, sadece doÄŸrulama iÃ§in
                                    kullanÄ±lÄ±r.
                                    TTYB numarasÄ± girerseniz "DoÄŸrulanmÄ±ÅŸ Broker" rozeti alÄ±rsÄ±nÄ±z.
                                </p>
                            </div>

                            <!-- Buttons -->
                            <div class="flex gap-3 mt-6">
                                <button type="submit"
                                    class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                    Kaydet
                                </button>
                                <button type="button" @click="editMode = false"
                                    class="px-6 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                    Ä°ptal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- BROKER PROFILE MODAL -->
            <div x-show="showBrokerModal" @click.self="showBrokerModal = false"
                class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" style="display: none;">
                <div @click.stop class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <!-- Modal Header -->
                    <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                        <h2 class="text-xl font-bold">Broker Profili</h2>
                        <button @click="showBrokerModal = false" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <!-- Modal Content -->
                    <div class="p-6" x-show="selectedBroker">
                        <!-- Cover & Avatar -->
                        <div class="h-32 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg relative mb-16">
                            <img x-show="selectedBroker?.cover_url" :src="selectedBroker?.cover_url"
                                class="w-full h-full object-cover rounded-lg">
                            <div class="absolute -bottom-12 left-6">
                                <div
                                    class="w-24 h-24 rounded-full border-4 border-white shadow-lg bg-gray-200 overflow-hidden">
                                    <img x-show="selectedBroker?.avatar_url" :src="selectedBroker?.avatar_url"
                                        class="w-full h-full object-cover">
                                    <div x-show="!selectedBroker?.avatar_url"
                                        class="w-full h-full flex items-center justify-center text-3xl font-bold text-white bg-blue-600"
                                        x-text="selectedBroker?.name?.charAt(0).toUpperCase()">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Name & Title -->
                        <div class="mb-4">
                            <h3 class="text-2xl font-bold text-gray-900" x-text="selectedBroker?.name"></h3>
                            <p class="text-gray-600" x-text="selectedBroker?.title || 'Broker'"></p>
                            <p class="text-sm text-gray-500" x-text="selectedBroker?.company"></p>
                            <span x-show="selectedBroker?.ttyb_verified"
                                class="inline-flex items-center gap-1 bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium mt-2">
                                âœ“ DoÄŸrulanmÄ±ÅŸ Broker
                            </span>
                        </div>

                        <!-- Bio -->
                        <div class="mb-4" x-show="selectedBroker?.bio">
                            <h4 class="font-semibold text-gray-900 mb-2">HakkÄ±nda</h4>
                            <p class="text-gray-700 whitespace-pre-wrap" x-text="selectedBroker?.bio"></p>
                        </div>

                        <!-- Service Areas -->
                        <div class="mb-4"
                            x-show="selectedBroker?.service_areas && selectedBroker.service_areas.length > 0">
                            <h4 class="font-semibold text-gray-900 mb-2">Hizmet BÃ¶lgeleri</h4>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="(area, aIdx) in selectedBroker?.service_areas"
                                    :key="'broker-area-' + aIdx">
                                    <span
                                        class="inline-flex items-center gap-1 bg-blue-50 text-blue-700 px-2 py-1 rounded-lg text-sm border border-blue-200">
                                        ðŸ“ <span x-text="`${area.district}, ${area.city}`"></span>
                                    </span>
                                </template>
                            </div>
                        </div>

                        <!-- Specialties -->
                        <div class="mb-4" x-show="selectedBroker?.specialties && selectedBroker.specialties.length > 0">
                            <h4 class="font-semibold text-gray-900 mb-2">UzmanlÄ±k AlanlarÄ±</h4>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="(specialty, sIdx) in selectedBroker?.specialties"
                                    :key="'broker-specialty-' + sIdx">
                                    <span
                                        class="bg-purple-50 text-purple-700 px-2 py-1 rounded-full text-sm border border-purple-200 font-medium">
                                        #<span x-text="specialty"></span>
                                    </span>
                                </template>
                            </div>
                        </div>

                        <!-- Connection Action Button -->
                        <div class="mt-6 pt-4 border-t">
                            <!-- No Connection -->
                            <button x-show="selectedBroker?.connectionStatus === 'none'"
                                @click="sendConnectionRequest(selectedBroker.id)"
                                class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                ðŸ¤ AÄŸÄ±na Ekle
                            </button>

                            <!-- Pending Sent -->
                            <button x-show="selectedBroker?.connectionStatus === 'pending_sent'" disabled
                                class="w-full bg-gray-200 text-gray-600 py-3 rounded-lg font-semibold cursor-not-allowed">
                                â³ Ä°stek GÃ¶nderildi
                            </button>

                            <!-- Pending Received -->
                            <div x-show="selectedBroker?.connectionStatus === 'pending_received'" class="flex gap-2">
                                <button
                                    @click="acceptConnectionRequest(connectionRequests.find(r => r.requester_id === selectedBroker.id)?.id)"
                                    class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                                    âœ“ Kabul Et
                                </button>
                                <button
                                    @click="rejectConnectionRequest(connectionRequests.find(r => r.requester_id === selectedBroker.id)?.id)"
                                    class="flex-1 bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700">
                                    âœ— Reddet
                                </button>
                            </div>

                            <!-- Connected -->
                            <button x-show="selectedBroker?.connectionStatus === 'connected'" disabled
                                class="w-full bg-green-100 text-green-800 py-3 rounded-lg font-semibold cursor-not-allowed">
                                âœ“ BaÄŸlantÄ±dasÄ±nÄ±z
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DEMANDS VIEW -->
            <div x-show="currentTab === 'demands'" class="pb-24 animate-fade-in w-full" x-cloak>
                <!-- Header -->
                <div class="px-5 py-4 border-b border-gray-100">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Talepler</h2>
                            <p class="text-sm text-gray-500 mt-1">MÃ¼ÅŸteri talepleri</p>
                        </div>
                        <button @click.prevent="showAddDemandModal = true; editingDemandId = null"
                            class="px-4 py-2 bg-blue-600 text-white rounded-xl font-semibold text-sm hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            Talep
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="px-5 mb-4 overflow-x-auto hide-scrollbar">
                    <div class="flex gap-6 border-b border-gray-200 min-w-max">
                        <button @click="currentDemandTab = 'active'"
                            class="pb-3 text-sm font-medium transition-colors relative"
                            :class="currentDemandTab === 'active' ? 'text-blue-800 font-bold' : 'text-gray-500'">
                            Taleplerim
                            <span class="ml-1 px-2 py-0.5 rounded-full text-xs transition-colors"
                                :class="currentDemandTab === 'active' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'"
                                x-text="demands.length"></span>
                            <div x-show="currentDemandTab === 'active'"
                                class="absolute bottom-0 left-0 w-full h-0.5 bg-blue-800"></div>
                        </button>
                        <button @click="currentDemandTab = 'network'"
                            class="pb-3 text-sm font-medium transition-colors relative"
                            :class="currentDemandTab === 'network' ? 'text-blue-800 font-bold' : 'text-gray-500'">
                            AÄŸ Talepleri (TÃ¼mÃ¼)
                            <span class="ml-1 px-2 py-0.5 rounded-full text-xs transition-colors"
                                :class="currentDemandTab === 'network' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'"
                                x-text="networkDemands.length"></span>
                            <div x-show="currentDemandTab === 'network'"
                                class="absolute bottom-0 left-0 w-full h-0.5 bg-blue-800"></div>
                        </button>
                    </div>
                </div>

                <!-- Demands Header & Stats -->
                <div class="px-5 mb-6" x-show="currentDemandTab === 'active'">
                    <div class="mb-6 flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Talepler</h2>
                            <p class="text-gray-500 text-sm">MÃ¼ÅŸteri taleplerini takip edin</p>
                        </div>
                        <div>
                            <select x-model="demandSortOrder"
                                class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-blue-500">
                                <option value="newest">Yeniden Eskiye</option>
                                <option value="oldest">Eskiden Yeniye</option>
                            </select>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <!-- Total -->
                        <div class="bg-blue-50 rounded-2xl p-4 border border-blue-100">
                            <div class="flex items-center gap-2 text-blue-600 mb-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                <span class="font-medium text-sm">Toplam</span>
                            </div>
                            <div class="text-3xl font-bold text-gray-900" x-text="demands.length"></div>
                        </div>

                        <!-- Urgent -->
                        <div class="bg-red-50 rounded-2xl p-4 border border-red-100">
                            <div class="flex items-center gap-2 text-red-600 mb-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                <span class="font-medium text-sm">Acil</span>
                            </div>
                            <div class="text-3xl font-bold text-gray-900"
                                x-text="demands.filter(d => d.isUrgent).length">
                            </div>
                        </div>

                        <!-- Matches -->
                        <div class="bg-emerald-50 rounded-2xl p-4 border border-emerald-100">
                            <div class="flex items-center gap-2 text-emerald-600 mb-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span class="font-medium text-sm">EÅŸleÅŸme</span>
                            </div>
                            <div class="text-3xl font-bold text-gray-900"
                                x-text="demands.reduce((acc, d) => acc + (d.matchCount || 0), 0)"></div>
                        </div>
                    </div>

                    <!-- Sub-Tabs (Pills) -->
                    <div class="flex gap-2 bg-gray-50 p-1 rounded-xl w-fit mb-6">
                        <button class="px-4 py-2 bg-white rounded-lg text-sm font-bold text-gray-900 shadow-sm">
                            Aktif (<span x-text="demands.length"></span>)
                        </button>
                        <button
                            class="px-4 py-2 text-gray-500 text-sm font-medium hover:bg-gray-100 rounded-lg transition-colors">
                            Bekleyen (0)
                        </button>
                        <button
                            class="px-4 py-2 text-gray-500 text-sm font-medium hover:bg-gray-100 rounded-lg transition-colors">
                            Tamamlanan (0)
                        </button>
                    </div>

                    <!-- Search Bar -->
                    <div class="relative mb-6">
                        <svg class="w-5 h-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <input type="text" placeholder="Ä°sim, konum veya kriterlere gÃ¶re ara..."
                            class="w-full pl-12 pr-4 py-3 bg-white border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-shadow shadow-sm">
                    </div>
                </div>

                <!-- MY DEMANDS LIST (Grid) -->
                <div x-show="currentDemandTab === 'active'" class="px-5 pb-20 grid grid-cols-1 md:grid-cols-3 gap-5">
                    <template x-for="demand in filteredDemands" :key="demand.id">
                        <div
                            class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                            <!-- Header -->
                            <div class="p-4 flex justify-between items-start"
                                :class="demand.isUrgent ? 'bg-red-50' : 'bg-orange-50'">
                                <div class="flex items-center gap-3">
                                    <!-- Avatar -->
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-sm"
                                        :class="demand.isUrgent ? 'bg-blue-600' : 'bg-blue-500'"
                                        x-text="demand.title.charAt(0)">
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-900 text-sm">
                                            <span x-text="demand.title"></span>
                                            <span x-show="demand.type" class="text-gray-500 font-normal text-xs ml-2"
                                                x-text="'(' + demand.type + ')'"></span>
                                        </h3>
                                        <div class="flex gap-2 mt-1">
                                            <span
                                                class="text-white text-[10px] px-2 py-0.5 rounded-full flex items-center gap-1 font-bold shadow-sm"
                                                :class="demand.isUrgent ? 'bg-red-500' : 'bg-orange-400'">
                                                <span x-show="demand.isUrgent">ðŸ”¥ Acil</span>
                                                <span x-show="!demand.isUrgent">âš¡ Aktif</span>
                                            </span>
                                            <span
                                                class="bg-white/80 text-gray-600 text-[10px] px-2 py-0.5 rounded-full flex items-center gap-1 font-bold border border-gray-100">
                                                ðŸ‘¤ <span x-text="demand.category"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Match Badge -->
                                <div class="flex flex-col items-center">
                                    <div class="w-8 h-8 rounded-full bg-emerald-500 text-white flex items-center justify-center font-bold text-sm shadow-sm"
                                        x-text="demand.matchCount || 0">
                                    </div>
                                    <span class="text-[10px] text-gray-500 mt-0.5 font-medium">eÅŸleÅŸme</span>
                                </div>
                            </div>

                            <!-- Body -->
                            <div class="p-4">
                                <!-- Budget Box -->
                                <div class="bg-emerald-50 border border-emerald-100 rounded-xl p-3 mb-4">
                                    <div
                                        class="text-emerald-700 text-[10px] uppercase tracking-wider font-bold mb-1 flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        BÃ¼tÃ§e AralÄ±ÄŸÄ±
                                    </div>
                                    <div class="text-emerald-600 font-bold text-lg">
                                        <span x-text="formatPrice(demand.budget)"></span>
                                        <span x-show="demand.maxBudget"> - <span
                                                x-text="formatPrice(demand.maxBudget)"></span></span>
                                    </div>
                                </div>

                                <!-- Location -->
                                <div class="mb-4">
                                    <div
                                        class="text-gray-400 text-[10px] uppercase tracking-wider font-bold mb-1 flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        Aranan BÃ¶lgeler
                                    </div>
                                    <div class="text-gray-900 font-bold text-sm ml-4" x-text="demand.district"></div>
                                </div>

                                <!-- Features Grid -->
                                <div class="grid grid-cols-3 gap-2 mb-4">
                                    <div class="bg-gray-50 rounded-xl p-2 text-center border border-gray-100">
                                        <svg class="w-4 h-4 text-blue-500 mx-auto mb-1" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                                        </svg>
                                        <div class="font-bold text-gray-900 text-sm" x-text="demand.rooms"></div>
                                        <div class="text-gray-400 text-[10px] font-medium">Oda</div>
                                    </div>
                                    <div class="bg-gray-50 rounded-xl p-2 text-center border border-gray-100">
                                        <svg class="w-4 h-4 text-blue-500 mx-auto mb-1" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                        </svg>
                                        <div class="font-bold text-gray-900 text-sm" x-text="demand.category"></div>
                                        <div class="text-gray-400 text-[10px] font-medium">Tip</div>
                                    </div>
                                    <div class="bg-gray-50 rounded-xl p-2 text-center border border-gray-100">
                                        <svg class="w-4 h-4 text-blue-500 mx-auto mb-1" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M5 13l4 4L19 7" />
                                        </svg>
                                        <div class="font-bold text-gray-900 text-sm">Evet</div>
                                        <div class="text-gray-400 text-[10px] font-medium">Park</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Footer -->
                            <div class="px-4 py-3 bg-gray-50 border-t border-gray-100 flex gap-2">
                                <button @click="editDemand(demand.id)"
                                    class="flex-1 py-2 bg-white border border-gray-200 rounded-lg text-xs font-bold text-blue-600 hover:bg-blue-50 transition-colors">
                                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                    DÃ¼zenle
                                </button>
                                <button @click="deleteDemand(demand.id)"
                                    class="flex-1 py-2 bg-white border border-red-200 rounded-lg text-xs font-bold text-red-600 hover:bg-red-50 transition-colors">
                                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    Sil
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
                <!-- Network Demands List -->
                <div class="px-5 space-y-4" x-show="currentDemandTab === 'network'">
                    <!-- Filter Header -->
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900">AÄŸdan Gelen Talepler</h3>
                        <select x-model="demandSortOrder"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-blue-500">
                            <option value="newest">Yeniden Eskiye</option>
                            <option value="oldest">Eskiden Yeniye</option>
                        </select>
                    </div>

                    <template x-for="demand in sortedNetworkDemands" :key="demand.id">
                        <div
                            class="bg-white rounded-xl border border-gray-100 shadow-sm p-4 hover:shadow-md transition-shadow">
                            <!-- Broker Bilgisi (Ãœstte) -->
                            <div class="flex items-center gap-2 mb-3 pb-3 border-b border-gray-100">
                                <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                                    <img x-show="demand.broker_avatar_url" :src="demand.broker_avatar_url"
                                        class="w-full h-full object-cover">
                                    <div x-show="!demand.broker_avatar_url"
                                        class="w-full h-full flex items-center justify-center bg-blue-600 text-white text-xs font-bold"
                                        x-text="demand.broker_name?.charAt(0).toUpperCase()"></div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-bold text-gray-900 truncate" x-text="demand.broker_name"></p>
                                    <p class="text-xs text-gray-500 truncate" x-text="demand.broker_title || 'Broker'">
                                    </p>
                                </div>
                                <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-full">AÄŸÄ±mdan</span>
                            </div>

                            <!-- Talep DetaylarÄ± -->
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div x-show="demand.title">
                                    <span class="text-gray-500">BaÅŸlÄ±k:</span>
                                    <span class="font-medium text-gray-900" x-text="demand.title"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">BÃ¶lge:</span>
                                    <span class="font-medium text-gray-900"
                                        x-text="formatLocation(demand.district, demand.city)"></span>
                                </div>
                                <div x-show="demand.budget && demand.budget > 0">
                                    <span class="text-gray-500">BÃ¼tÃ§e:</span>
                                    <span class="font-medium text-green-700"
                                        x-text="formatBudget(demand.budget, demand.max_budget)"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Tarih:</span>
                                    <span class="font-medium text-gray-900"
                                        x-text="formatDate(demand.created_at)"></span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            </template>
    </div>
    </div>

    <!-- MATCHING DETAIL VIEW (Overlay) -->
    <div x-show="showMatchDetail" class="fixed inset-0 z-50 bg-gray-100 overflow-y-auto" style="display: none;">
        <!-- Header -->
        <div class="sticky top-0 bg-white px-5 py-4 flex justify-between items-center shadow-sm z-10">
            <button @click="showMatchDetail = false" class="p-2 -ml-2 text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                    </path>
                </svg>
            </button>
            <h2 class="text-lg font-bold text-gray-900">EÅŸleÅŸme Analizi</h2>
            <div class="flex gap-2">
                <button class="p-2 text-gray-600"><svg class="w-6 h-6" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg></button>
            </div>
        </div>

        <!-- Filters -->
        <div class="px-5 py-4 flex gap-3 overflow-x-auto hide-scrollbar items-center">
            <button @click="generateMatches()" :disabled="isMatching"
                class="px-4 py-2 bg-purple-600 text-white rounded-full text-sm font-bold shadow-sm hover:bg-purple-700 transition-colors flex items-center gap-2">
                <span x-show="!isMatching">ðŸ”„ EÅŸleÅŸtirmeleri Yenile</span>
                <span x-show="isMatching">â³ AranÄ±yor... <span x-text="matchingProgress + '%'"></span></span>
            </button>
            <!-- Aciliyet Toggle Butonu -->
            <button @click="showOnlyUrgent = !showOnlyUrgent"
                :class="showOnlyUrgent ? 'bg-red-600' : 'bg-gray-200 text-gray-700'"
                class="px-4 py-2 text-white rounded-full text-sm font-bold shadow-sm hover:opacity-90 transition-all flex items-center gap-2">
                <span x-show="!showOnlyUrgent">ðŸ”¥ Sadece Acil</span>
                <span x-show="showOnlyUrgent">ðŸ“‹ TÃ¼m EÅŸleÅŸmeler</span>
            </button>
        </div>

        <!-- Sub-tabs (Separate Row) -->
        <div class="px-5 pb-3 flex gap-2 border-b border-gray-100">
            <button @click="matchesTab = 'demands'"
                :class="matchesTab === 'demands' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'"
                class="px-4 py-2 rounded-full text-sm font-semibold transition-colors flex items-center gap-2">
                Taleplerim
                <span class="bg-white/20 px-2 py-0.5 rounded-full text-xs" x-text="demandMatches.length"></span>
            </button>
            <button @click="matchesTab = 'portfolios'"
                :class="matchesTab === 'portfolios' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700'"
                class="px-4 py-2 rounded-full text-sm font-semibold transition-colors flex items-center gap-2">
                PortfÃ¶ylerim
                <span class="bg-white/20 px-2 py-0.5 rounded-full text-xs" x-text="portfolioMatches.length"></span>
            </button>
        </div>

        <!-- Filters -->
        <div class="px-5 py-3 flex gap-3 overflow-x-auto hide-scrollbar items-center">
            <!-- Cleanup Duplicates Button -->
            <button @click="cleanupDuplicateMatches()"
                class="px-4 py-2 bg-orange-600 text-white rounded-full text-sm font-bold shadow-sm hover:bg-orange-700 transition-all flex items-center gap-2">
                ðŸ§¹ MÃ¼kerrerleri Temizle
            </button>
            <button
                class="px-4 py-2 bg-blue-900 text-white rounded-full text-sm font-bold whitespace-nowrap flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                    </path>
                </svg>
                TÃ¼m EÅŸleÅŸmeler <span class="bg-white/20 px-1.5 py-0.5 rounded-full text-xs ml-1">4</span>
            </button>
            <button
                class="px-4 py-2 bg-white text-gray-600 border border-gray-200 rounded-full text-sm font-medium whitespace-nowrap flex items-center gap-1 shadow-sm">
                <svg class="w-4 h-4 text-emerald-500" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
                %90+ EÅŸleÅŸme <span class="bg-gray-100 px-1.5 py-0.5 rounded-full text-xs ml-1">1</span>
            </button>
        </div>

        <!-- Match Card -->
        <div class="px-5 pb-24">
            <div class="bg-white rounded-3xl p-5 shadow-soft border border-gray-50 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="font-bold text-gray-900 text-lg">EÅŸleÅŸme #001</h3>
                        <p class="text-emerald-600 text-sm font-medium">MÃ¼kemmel EÅŸleÅŸme</p>
                    </div>
                    <div
                        class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                        %92
                    </div>
                </div>

                <!-- Comparison -->
                <div class="flex items-center gap-2 mb-6">
                    <div class="flex-1 bg-gray-50 rounded-2xl p-3 border border-gray-100">
                        <img src="https://images.unsplash.com/photo-1600596542815-27b5c028d603?ixlib=rb-4.0.3&auto=format&fit=crop&w=150&q=80"
                            class="w-12 h-12 rounded-xl object-cover mb-2">
                        <div class="font-bold text-gray-900 text-sm truncate">Modern Aile Evi</div>
                        <div class="text-xs text-gray-500 truncate">Bebek, Ä°st.</div>
                        <div class="text-blue-700 font-bold text-xs mt-1">12.5M â‚º</div>
                        <div class="text-xs text-gray-400 mt-1">3+1 â€¢ 145mÂ²</div>
                    </div>

                    <div class="text-gray-400">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                        </svg>
                    </div>

                    <div class="flex-1 bg-blue-50 rounded-2xl p-3 border border-blue-100">
                        <div
                            class="w-12 h-12 rounded-xl bg-blue-800 flex items-center justify-center text-white font-bold text-sm mb-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z">
                                </path>
                            </svg>
                        </div>
                        <div class="font-bold text-gray-900 text-sm truncate">Talep #001</div>
                        <div class="text-xs text-gray-500 truncate">Bebek, Ä°st.</div>
                        <div class="text-blue-700 font-bold text-xs mt-1">12-14M â‚º</div>
                        <div class="text-xs text-gray-400 mt-1">3+1 â€¢ Daire</div>
                    </div>
                </div>

                <!-- Criteria Analysis -->
                <div class="mb-6">
                    <h4 class="text-sm font-bold text-gray-500 mb-3 uppercase tracking-wider">Kriter Analizi
                    </h4>
                    <div class="flex flex-wrap gap-2">
                        <span
                            class="px-3 py-1.5 bg-emerald-50 text-emerald-700 rounded-lg text-xs font-bold border border-emerald-100 flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                    d="M5 13l4 4L19 7"></path>
                            </svg>
                            Konum
                        </span>
                        <span
                            class="px-3 py-1.5 bg-emerald-50 text-emerald-700 rounded-lg text-xs font-bold border border-emerald-100 flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                    d="M5 13l4 4L19 7"></path>
                            </svg>
                            BÃ¼tÃ§e
                        </span>
                        <span
                            class="px-3 py-1.5 bg-emerald-50 text-emerald-700 rounded-lg text-xs font-bold border border-emerald-100 flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                    d="M5 13l4 4L19 7"></path>
                            </svg>
                            Oda SayÄ±sÄ±
                        </span>
                        <span
                            class="px-3 py-1.5 bg-emerald-50 text-emerald-700 rounded-lg text-xs font-bold border border-emerald-100 flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                    d="M5 13l4 4L19 7"></path>
                            </svg>
                            Tip
                        </span>
                        <span
                            class="px-3 py-1.5 bg-orange-50 text-orange-600 rounded-lg text-xs font-bold border border-orange-100 flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                </path>
                            </svg>
                            Otopark
                        </span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-3">
                    <button
                        class="flex-1 py-3 border border-orange-200 text-orange-600 font-bold rounded-xl hover:bg-orange-50 transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Reddet
                    </button>
                    <button
                        class="flex-1 py-3 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-200 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                        Onayla
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>

    </div> <!-- End of scroll-content -->

    <!-- FAB Button Wrapper (Mobile Only) - Portfolio -->
    <div class="fixed bottom-0 left-0 w-full h-0 z-50 pointer-events-none md:hidden"
        x-show="currentTab === 'portfolios'">
        <button @click.prevent="showAddModal = true; editingPortfolioId = null" x-data
            class="fixed bottom-24 right-5 w-14 h-14 bg-blue-600 rounded-full flex items-center justify-center text-white shadow-lg pointer-events-auto hover:scale-105 transition-transform">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                </path>
            </svg>
        </button>
    </div>

    <!-- FAB Button Wrapper (Mobile Only) - Demands -->
    <div class="fixed bottom-0 left-0 w-full h-0 z-50 pointer-events-none md:hidden" x-show="currentTab === 'demands'">
        <button @click.prevent="showAddDemandModal = true; editingDemandId = null" x-data
            class="fixed bottom-24 right-5 w-14 h-14 bg-emerald-600 rounded-full flex items-center justify-center text-white shadow-lg pointer-events-auto hover:scale-105 transition-transform">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                </path>
            </svg>
        </button>
    </div>

    <!-- Contact Modal -->
    <div x-show="contactModalOpen" @click.self="contactModalOpen = false" x-cloak
        class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Broker Ä°letiÅŸim</h3>

            <!-- Broker Bilgisi -->
            <div class="flex items-center gap-3 mb-4">
                <div class="w-16 h-16 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                    <img x-show="selectedMatchContact?.brokerAvatar" :src="selectedMatchContact?.brokerAvatar"
                        class="w-full h-full object-cover">
                    <div x-show="!selectedMatchContact?.brokerAvatar"
                        class="w-full h-full flex items-center justify-center bg-blue-600 text-white text-2xl font-bold"
                        x-text="selectedMatchContact?.brokerName?.charAt(0)"></div>
                </div>
                <div class="flex-1">
                    <p class="font-bold text-lg" x-text="selectedMatchContact?.brokerName"></p>
                    <p class="text-sm text-gray-600" x-text="selectedMatchContact?.brokerTitle"></p>
                    <p class="text-sm text-gray-500" x-text="selectedMatchContact?.brokerCompany"></p>
                </div>
            </div>

            <!-- Telefon -->
            <div class="bg-blue-50 rounded-xl p-4 mb-4">
                <p class="text-sm text-gray-600 mb-1">Telefon</p>
                <a :href="'tel:' + selectedMatchContact?.brokerPhone"
                    class="text-2xl font-bold text-blue-600 hover:text-blue-700 transition-colors block"
                    x-text="selectedMatchContact?.brokerPhone || 'Telefon bilgisi yok'"></a>
            </div>

            <!-- PortfÃ¶y Bilgisi (Sadece eÅŸleÅŸmelerde gÃ¶ster) -->
            <div x-show="selectedMatchContact?.title" class="bg-gray-50 rounded-xl p-4 mb-4">
                <p class="text-xs text-gray-500 mb-1">EÅŸleÅŸen PortfÃ¶y</p>
                <p class="font-semibold text-gray-900" x-text="selectedMatchContact?.title"></p>
                <p class="text-sm text-blue-600 font-bold" x-text="selectedMatchContact?.price"></p>
            </div>

            <button @click="contactModalOpen = false"
                class="w-full bg-gray-100 hover:bg-gray-200 py-3 rounded-xl font-semibold transition-colors">
                Kapat
            </button>
        </div>
    </div>

    </main>

    <!-- Bottom Navigation (Mobile Only) -->
    <div class="mobile-nav fixed bottom-0 left-0 w-full bg-white border-t border-gray-100 pb-safe z-40 md:hidden">
        <div class="flex justify-around items-center py-2">
            <button @click="currentTab = 'dashboard'" class="flex flex-col items-center gap-0.5 py-1"
                :class="currentTab === 'dashboard' ? 'text-blue-600' : 'text-gray-400'">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                </svg>
                <span class="text-[11px] font-medium">Dashboard</span>
            </button>
            <button @click="currentTab = 'portfolios'" class="flex flex-col items-center gap-0.5 py-1"
                :class="currentTab === 'portfolios' ? 'text-blue-600' : 'text-gray-400'">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                </svg>
                <span class="text-[11px] font-medium">PortfÃ¶yler</span>
            </button>
            <button @click="currentTab = 'demands'" class="flex flex-col items-center gap-0.5 py-1"
                :class="currentTab === 'demands' ? 'text-blue-600' : 'text-gray-400'">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <span class="text-[11px] font-medium">Talepler</span>
            </button>
            <button @click="currentTab = 'matches'" class="flex flex-col items-center gap-0.5 py-1"
                :class="currentTab === 'matches' ? 'text-blue-600' : 'text-gray-400'">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                </svg>
                <span class="text-[11px] font-medium">EÅŸleÅŸmeler</span>
            </button>
            <button @click="currentTab = 'network'" class="flex flex-col items-center gap-0.5 py-1"
                :class="currentTab === 'network' ? 'text-blue-600' : 'text-gray-400'">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                </svg>
                <span class="text-[11px] font-medium">AÄŸ</span>
            </button>
        </div>
    </div>



    </div>
    </div>


    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Wait for Supabase to load, then initialize app
        document.addEventListener('DOMContentLoaded', function () {
            // Check if Supabase is loaded
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase failed to load');
                return;
            }

            // Supabase Configuration
            const supabaseUrl = 'https://redwdkfeypnpuyndvysl.supabase.co';
            const supabaseKey = 'sb_publishable_-nD1cds8uhQ80CjphgIG1A__NrAP7v1';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            // Define app globally BEFORE Alpine loads
            window.app = function () {
                return {
                    // STATE
                    user: null,
                    userProfile: {
                        name: '',
                        title: '',
                        company: '',
                        phone: '',
                        bio: '',
                        ttyb_number: '',
                        ttyb_verified: false,
                        avatar_url: '',
                        cover_url: '',
                        service_areas: [], // Hizmet bÃ¶lgeleri
                        specialties: [], // UzmanlÄ±k alanlarÄ±
                        // Trust Score System
                        trustScore: {
                            total: 0,
                            level: 'newcomer',
                            levelName: 'BaÅŸlangÄ±Ã§',
                            levelEmoji: 'ðŸ”°',
                            profile: 0,
                            login: 0,
                            data: 0,
                            reaction: 0
                        }
                    }, // Profil bilgileri
                    editMode: false, // Profil dÃ¼zenleme modu

                    // Service Areas (Hizmet BÃ¶lgeleri)
                    tempServiceCity: '', // GeÃ§ici seÃ§im
                    tempServiceDistrict: '', // GeÃ§ici seÃ§im

                    // Specialties (UzmanlÄ±k AlanlarÄ±)
                    tempSpecialty: '', // GeÃ§ici hashtag input

                    // Networking (BaÄŸlantÄ± Sistemi)
                    connectionRequests: [], // Gelen baÄŸlantÄ± istekleri
                    sentRequests: [], // GÃ¶nderilen istekler
                    connections: [], // Kabul edilmiÅŸ baÄŸlantÄ±lar
                    selectedBroker: null, // Modal iÃ§in seÃ§ili broker
                    showBrokerModal: false, // Broker profil modal'Ä±
                    contactModalOpen: false, // Ä°letiÅŸim modal'Ä±
                    selectedMatchContact: null, // Ä°letiÅŸim iÃ§in seÃ§ilen eÅŸleÅŸme
                    suggestedBrokers: [], // Ã–nerilen brokerlar (KeÅŸfet)
                    brokersOffset: 0, // Pagination offset
                    brokersHasMore: true, // Daha fazla broker var mÄ±?
                    brokersLoading: false, // YÃ¼kleniyor durumu
                    blockedUsers: [], // Engellenen kullanÄ±cÄ±lar
                    blockedUserProfiles: [], // Engellenen kullanÄ±cÄ±larÄ±n profil detaylarÄ±
                    networkTab: 'discover', // AÄŸ sekmesi alt-menÃ¼sÃ¼
                    authMode: 'login', // login, register
                    authEmail: '',
                    authPassword: '',
                    authName: '',
                    authError: '',
                    authLoading: false,

                    currentTab: 'dashboard',
                    currentDemandTab: 'active', // active, pending, completed, archived, network
                    currentDemandFilter: 'all', // all, urgent, match
                    demandSortOrder: 'newest', // newest, oldest
                    matchSortOrder: 'newest', // newest, oldest
                    currentListingType: 'satilik', // satilik, kiralik
                    currentCategory: 'all', // all, Villa, Daire, Arsa, Ä°ÅŸ yeri
                    currentCity: 'all',
                    currentDistrict: 'all',
                    currentPortfolioCity: 'all',
                    currentPortfolioDistrict: 'all',
                    currentPortfolioListingType: 'satilik', // satilik, kiralik
                    currentPortfolioCategory: 'all', // all, Villa, Daire, Arsa, Ä°ÅŸyeri
                    portfolioSortOrder: 'Tarih', // Tarih, Fiyat (DÃ¼ÅŸÃ¼k), Fiyat (YÃ¼ksek)
                    currentMatchFilter: 'all', // all, top, favorites
                    activeConversation: null,
                    showMatchDetail: false,
                    showAddModal: false,
                    editingPortfolioId: null,
                    showAddDemandModal: false,
                    editingDemandId: null,
                    confirmingMatchId: null, // ID of match being confirmed
                    confirmingAction: null, // 'approve' or 'reject'
                    newDemand: {
                        title: '',
                        type: 'SatÄ±lÄ±k',
                        category: '',
                        budget: '',
                        maxBudget: '',
                        city: 'Ä°STANBUL',
                        location: '', // Ä°lÃ§e
                        district: '', // 1. Semt/Mahalle tercihi
                        district2: '', // 2. Semt/Mahalle tercihi
                        district3: '', // 3. Semt/Mahalle tercihi
                        rooms: '',
                        isUrgent: false
                    },
                    newListingImages: [],
                    isCompressing: false,
                    newPortfolio: {
                        title: '',
                        type: 'SatÄ±lÄ±k',
                        category: '',
                        price: '',
                        city: '',
                        location: '',
                        district: '',
                        district2: '', // Not used for portfolios, but for consistency
                        district3: '',
                        rooms: '',
                        area: '',
                        age: ''
                    },
                    demands: [],
                    portfolios: [],
                    networkPortfolios: [],
                    networkDemands: [],
                    conversations: [],
                    newMessageText: '', // For message input
                    messages: {}, // Message storage by conversation ID

                    // Loading states
                    isLoading: true,
                    isLoadingPortfolios: false,
                    isLoadingMatches: false,
                    showOnlyUrgent: false, // Toggle for "Acil" filter
                    matchesTab: 'demands', // 'demands' or 'portfolios'
                    demandMatches: [], // Talep eÅŸleÅŸmeleri
                    portfolioMatches: [], // PortfÃ¶y eÅŸleÅŸmeleri
                    isLoadingConversations: false,

                    // Error state
                    errorMessage: '',
                    successMessage: '',

                    // Location Data for Dropdowns (3-level: City > District > Neighborhood)
                    locationData: null,
                    cities: [],

                    // Get districts for selected city
                    getDistricts(city) {
                        if (!this.locationData || !city) return [];
                        const cityData = this.locationData[city];
                        return cityData ? Object.keys(cityData).sort() : [];
                    },

                    // Get neighborhoods for selected district
                    getNeighborhoods(city, district) {
                        if (!this.locationData || !city || !district) return [];
                        const cityData = this.locationData[city];
                        return cityData && cityData[district] ? cityData[district].sort() : [];
                    },

                    // For Portfolio form
                    get portfolioDistricts() {
                        return this.getDistricts(this.newPortfolio.city);
                    },

                    get portfolioNeighborhoods() {
                        return this.getNeighborhoods(this.newPortfolio.city, this.newPortfolio.location);
                    },

                    // For Demand form
                    get demandDistricts() {
                        return this.getDistricts(this.newDemand.city);
                    },

                    get filteredDemands() {
                        let filtered = this.demands;

                        // Filter by Category
                        if (this.currentCategory !== 'all') {
                            filtered = filtered.filter(d => d.category === this.currentCategory);
                        }

                        // Filter by City
                        if (this.currentCity !== 'all') {
                            filtered = filtered.filter(d => (d.district.split(',')[1]?.trim() || d.district) === this.currentCity);
                        }

                        // Filter by District
                        if (this.currentDistrict !== 'all') {
                            filtered = filtered.filter(d => d.district.split(',')[0]?.trim() === this.currentDistrict);
                        }

                        // Existing Filters
                        if (this.currentDemandFilter === 'urgent') {
                            filtered = filtered.filter(d => d.isUrgent);
                        } else if (this.currentDemandFilter === 'match') {
                            filtered = filtered.filter(d => d.matchCount > 0);
                        }

                        // Sort by date (Safe handling for missing dates)
                        filtered.sort((a, b) => {
                            const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
                            const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
                            return this.demandSortOrder === 'newest' ? dateB - dateA : dateA - dateB;
                        });

                        return filtered;
                    },

                    // Sorted Network Demands
                    get sortedNetworkDemands() {
                        const demands = [...this.networkDemands];
                        demands.sort((a, b) => {
                            // Use created_at or fallback to current time logic if missing
                            const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
                            const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
                            return this.demandSortOrder === 'newest' ? dateB - dateA : dateA - dateB;
                        });
                        return demands;
                    },

                    get filteredMyPortfolios() {
                        let filtered = [...this.portfolios]; // Create a copy to avoid mutating original array

                        // Filter by Listing Type
                        if (this.currentPortfolioListingType) {
                            filtered = filtered.filter(p => p.type === (this.currentPortfolioListingType === 'satilik' ? 'SatÄ±lÄ±k' : 'KiralÄ±k'));
                        }

                        // Filter by Category
                        if (this.currentPortfolioCategory !== 'all') {
                            filtered = filtered.filter(p => p.category === this.currentPortfolioCategory);
                        }

                        // Sort
                        if (this.portfolioSortOrder === 'Fiyat (DÃ¼ÅŸÃ¼k)') {
                            filtered.sort((a, b) => a.price - b.price);
                        } else if (this.portfolioSortOrder === 'Fiyat (YÃ¼ksek)') {
                            filtered.sort((a, b) => b.price - a.price);
                        } else {
                            // Tarih (VarsayÄ±lan - Yeni en Ã¼stte)
                            filtered.sort((a, b) => {
                                // created_at varsa kullan, yoksa id (bÃ¼yÃ¼k id = yeni)
                                if (a.created_at && b.created_at) {
                                    return new Date(b.created_at) - new Date(a.created_at);
                                }
                                return b.id - a.id;
                            });
                        }


                        if (this.currentPortfolioCity !== 'all') {
                            filtered = filtered.filter(p => (p.district.split(',')[1]?.trim() || p.district) === this.currentPortfolioCity);
                        }
                        if (this.currentPortfolioDistrict !== 'all') {
                            filtered = filtered.filter(p => p.district.split(',')[0]?.trim() === this.currentPortfolioDistrict);
                        }
                        return filtered;
                    },

                    get filteredNetworkPortfolios() {
                        let filtered = this.networkPortfolios;

                        // Filter by Listing Type
                        if (this.currentPortfolioListingType) {
                            filtered = filtered.filter(p => p.type === (this.currentPortfolioListingType === 'satilik' ? 'SatÄ±lÄ±k' : 'KiralÄ±k'));
                        }

                        if (this.currentPortfolioCity !== 'all') {
                            filtered = filtered.filter(p => (p.district.split(',')[1]?.trim() || p.district) === this.currentPortfolioCity);
                        }
                        if (this.currentPortfolioDistrict !== 'all') {
                            filtered = filtered.filter(p => p.district.split(',')[0]?.trim() === this.currentPortfolioDistrict);
                        }
                        return filtered;
                    },

                    // Matches (Computed - combines demand and portfolio matches based on tab)
                    get matches() {
                        let matches = [];

                        if (this.matchesTab === 'approved') {
                            // Show all approved matches (both demands and portfolios)
                            const allMatches = [
                                ...(this.demandMatches || []),
                                ...(this.portfolioMatches || [])
                            ];
                            matches = allMatches.filter(m => m.status === 'approved');
                        } else if (this.matchesTab === 'portfolios') {
                            // Show pending portfolio matches
                            matches = (this.portfolioMatches || []).filter(m =>
                                m.status === 'pending' || !m.status
                            );
                        } else {
                            // Show pending demand matches
                            matches = (this.demandMatches || []).filter(m =>
                                m.status === 'pending' || !m.status
                            );
                        }

                        // Deduplication: demand_id + portfolio_id based
                        // If same pair exists multiple times, prefer approved > pending > rejected
                        // If same status, prefer newer
                        const matchMap = new Map();
                        matches.forEach(m => {
                            const key = `${m.demand_id}-${m.portfolio_id}`;
                            const existing = matchMap.get(key);

                            if (!existing) {
                                matchMap.set(key, m);
                            } else {
                                // Priority: approved > pending > rejected
                                const statusPriority = { 'approved': 3, 'pending': 2, 'rejected': 1 };
                                const existingPriority = statusPriority[existing.status] || 0;
                                const newPriority = statusPriority[m.status] || 0;

                                if (newPriority > existingPriority) {
                                    matchMap.set(key, m);
                                } else if (newPriority === existingPriority) {
                                    // Same status, prefer newer
                                    const existingDate = new Date(existing.created_at || 0);
                                    const newDate = new Date(m.created_at || 0);
                                    if (newDate > existingDate) {
                                        matchMap.set(key, m);
                                    }
                                }
                            }
                        });

                        return Array.from(matchMap.values());
                    },

                    // Dashboard: Son 4 EÅŸleÅŸme (En yeni Ã¶nce)
                    get dashboardMatches() {
                        // TÃ¼m eÅŸleÅŸmeleri topla ve normalize et
                        const allMatches = [];

                        // Demand Matches (BENÄ°M TALEPLERÄ°M)
                        (this.demandMatches || []).forEach(m => {
                            allMatches.push({
                                ...m,
                                // Demand matches zaten doÄŸru formatta
                                name: m.name || m.title,
                                price: m.price,
                                location: m.location,
                                specs: m.specs,
                                image: m.image,
                                brokerName: m.brokerName,
                                brokerAvatar: m.brokerAvatar
                            });
                        });


                        // Portfolio Matches (BENÄ°M PORTFÃ–YLER Ä°M)
                        (this.portfolioMatches || []).forEach(m => {
                            allMatches.push({
                                ...m,
                                // Portfolio matches'i normalize et - KARÅžI TARAFIN TALEBÄ°NÄ° GÃ–STER
                                name: m.demandTitle || 'Talep', // KarÅŸÄ± tarafÄ±n talebi
                                title: m.demandTitle || 'Talep',
                                price: m.demandBudget || m.portfolioPrice, // Talep bÃ¼tÃ§esi
                                location: m.demandLocation || m.portfolioLocation,
                                specs: m.demandSpecs || m.portfolioSpecs,
                                image: m.portfolioImage, // PortfÃ¶y resmi gÃ¶ster
                                type: m.portfolioType || 'SatÄ±lÄ±k', // PortfÃ¶y tipi
                                brokerName: m.clientName, // KarÅŸÄ± tarafÄ±n adÄ±
                                brokerAvatar: m.clientAvatar,
                                brokerCompany: m.clientCompany,
                                brokerTitle: m.clientTitle
                            });
                        });

                        // Deduplication: demand_id + portfolio_id bazlÄ±
                        const matchMap = new Map();
                        allMatches.forEach(m => {
                            const key = `${m.demand_id}-${m.portfolio_id}`;
                            const existing = matchMap.get(key);

                            if (!existing) {
                                matchMap.set(key, m);
                            } else {
                                // Ã–ncelik: approved > pending > rejected
                                const statusPriority = { 'approved': 3, 'pending': 2, 'rejected': 1 };
                                const existingPriority = statusPriority[existing.status] || 0;
                                const newPriority = statusPriority[m.status] || 0;

                                if (newPriority > existingPriority) {
                                    matchMap.set(key, m);
                                } else if (newPriority === existingPriority) {
                                    // AynÄ± status, en yeni olanÄ± tut
                                    const existingDate = new Date(existing.created_at || 0);
                                    const newDate = new Date(m.created_at || 0);
                                    if (newDate > existingDate) {
                                        matchMap.set(key, m);
                                    }
                                }
                            }
                        });

                        // Tarihe gÃ¶re sÄ±rala (en yeni Ã¶nce) ve SADECE PENDING olanlarÄ± gÃ¶ster
                        return Array.from(matchMap.values())
                            .filter(m => m.status === 'pending' || !m.status) // Sadece pending eÅŸleÅŸmeler
                            .sort((a, b) => {
                                const dateA = new Date(a.created_at || 0);
                                const dateB = new Date(b.created_at || 0);
                                return dateB - dateA; // En yeni Ã¶nce
                            })
                            .slice(0, 4); // Ä°lk 4 eÅŸleÅŸme
                    },

                    // Toplam Unique EÅŸleÅŸme SayÄ±sÄ± (rejected hariÃ§, deduplication sonrasÄ±)
                    get totalMatchCount() {
                        const allMatches = [
                            ...(this.demandMatches || []),
                            ...(this.portfolioMatches || [])
                        ];

                        const matchMap = new Map();
                        allMatches.forEach(m => {
                            const key = `${m.demand_id}-${m.portfolio_id}`;
                            if (!matchMap.has(key)) {
                                matchMap.set(key, m);
                            }
                        });

                        // Rejected olanlarÄ± hariÃ§ tut
                        return Array.from(matchMap.values())
                            .filter(m => m.status !== 'rejected')
                            .length;
                    },

                    // Average Match Score (exclude rejected matches for consistency)
                    get averageMatchScore() {
                        const allMatches = [...(this.demandMatches || []), ...(this.portfolioMatches || [])];

                        // Filter out rejected matches
                        const activeMatches = allMatches.filter(m => m.status !== 'rejected');

                        if (activeMatches.length === 0) return 0;
                        const total = activeMatches.reduce((sum, m) => sum + (m.score || 0), 0);
                        return Math.round(total / activeMatches.length);
                    },

                    // ========================================
                    // TRUST SCORE - FETCH FROM DATABASE
                    // ========================================
                    async calculateTrustScore() {
                        if (!this.user) return;

                        try {
                            // âœ… Check login activity from localStorage
                            const lastLoginTimestamp = localStorage.getItem('brokerlink_last_login');
                            const now = Date.now();
                            const daysSinceLogin = lastLoginTimestamp
                                ? (now - parseInt(lastLoginTimestamp)) / (1000 * 60 * 60 * 24)
                                : 0;

                            // Only update last_active_at if user logged in within 5 days
                            const shouldUpdateLastActive = daysSinceLogin <= 5;

                            // 1. Call server-side function to calculate and update score
                            const { error: rpcError } = await supabase.rpc('update_trust_score', {
                                p_user_id: this.user.id,
                                p_update_last_active: shouldUpdateLastActive
                            });

                            if (rpcError) {
                                console.warn('Trust Score RPC error:', rpcError);
                            }

                            // 2. Fetch the calculated score from database
                            const { data, error } = await supabase
                                .from('trust_scores')
                                .select('*')
                                .eq('user_id', this.user.id)
                                .single();

                            if (error) {
                                console.error('Trust Score fetch error:', error);
                                // Fallback to default values
                                this.userProfile.trustScore = {
                                    total: 0,
                                    level: 'newcomer',
                                    levelName: 'BaÅŸlangÄ±Ã§',
                                    levelEmoji: 'ðŸ”°',
                                    profile: 0,
                                    login: 0,
                                    data: 0,
                                    reaction: 0
                                };
                                return;
                            }

                            // 3. Update state with database values
                            if (data) {
                                this.userProfile.trustScore = {
                                    total: data.total_score || 0,
                                    level: data.level || 'newcomer',
                                    levelName: data.level_name || 'BaÅŸlangÄ±Ã§',
                                    levelEmoji: data.level_emoji || 'ðŸ”°',
                                    profile: data.profile_score || 0,
                                    login: data.login_score || 0,
                                    data: data.data_score || 0,
                                    reaction: data.reaction_score || 0
                                };

                            }
                        } catch (e) {
                            console.error('Trust Score calculation failed:', e);
                        }
                    },

                    // Count of pending demand matches (deduplicated)
                    get pendingDemandCount() {
                        const matches = (this.demandMatches || []).filter(m =>
                            m.status === 'pending' || !m.status
                        );
                        const seen = new Set();
                        return matches.filter(m => {
                            const key = `${m.demand_id}-${m.portfolio_id}`;
                            if (seen.has(key)) return false;
                            seen.add(key);
                            return true;
                        }).length;
                    },

                    // Count of pending portfolio matches (deduplicated)
                    get pendingPortfolioCount() {
                        const matches = (this.portfolioMatches || []).filter(m =>
                            m.status === 'pending' || !m.status
                        );
                        const seen = new Set();
                        return matches.filter(m => {
                            const key = `${m.demand_id}-${m.portfolio_id}`;
                            if (seen.has(key)) return false;
                            seen.add(key);
                            return true;
                        }).length;
                    },

                    // Count of approved matches (for Onaylanan tab)
                    get approvedMatchesCount() {
                        const allMatches = [
                            ...(this.demandMatches || []),
                            ...(this.portfolioMatches || [])
                        ];
                        const approved = allMatches.filter(m => m.status === 'approved');

                        // Deduplicate by demand_id + portfolio_id
                        const matchMap = new Map();
                        approved.forEach(m => {
                            const key = `${m.demand_id}-${m.portfolio_id}`;
                            matchMap.set(key, m);
                        });

                        return matchMap.size;
                    },

                    // Filtered Matches (Urgency Toggle)
                    get filteredMatches() {
                        let filtered;
                        if (this.showOnlyUrgent) {
                            filtered = this.matches.filter(m => {
                                // Find the demand for this match
                                const demand = this.demands.find(d => d.id === m.demand_id);
                                return demand && (demand.is_urgent || demand.isUrgent);
                            });
                        } else {
                            filtered = [...this.matches];
                        }

                        // Sort by date (Safe handling)
                        filtered.sort((a, b) => {
                            const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
                            const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
                            return this.matchSortOrder === 'newest' ? dateB - dateA : dateA - dateB;
                        });

                        return filtered;
                    },

                    get networkActivities() {
                        const activities = [];

                        // 1. AÄŸÄ±mdaki brokerlarÄ±n YENÄ° portfÃ¶yleri
                        (this.networkPortfolios || [])
                            .filter(p => p.created_at)
                            .slice(0, 10) // Performance optimization
                            .forEach(p => {
                                activities.push({
                                    id: `network-portfolio-${p.id}`,
                                    user: p.broker_name || 'Broker',
                                    action: `"${p.title}" ilanÄ± ekledi`,
                                    time: this.formatTime(p.created_at),
                                    avatar: p.broker_avatar_url || null, // No more random avatars
                                    created_at: p.created_at
                                });
                            });

                        // 2. AÄŸÄ±mdaki brokerlarÄ±n YENÄ° talepleri
                        (this.networkDemands || [])
                            .filter(d => d.created_at)
                            .slice(0, 10)
                            .forEach(d => {
                                activities.push({
                                    id: `network-demand-${d.id}`,
                                    user: d.broker_name || 'Broker',
                                    action: `"${d.title}" talebi ekledi`,
                                    time: this.formatTime(d.created_at),
                                    avatar: d.broker_avatar_url || null,
                                    created_at: d.created_at
                                });
                            });

                        // 3. Yeni baÄŸlantÄ± istekleri
                        (this.connectionRequests || [])
                            .slice(0, 3)
                            .forEach(req => {
                                activities.push({
                                    id: `connection-${req.id}`,
                                    user: req.requester?.name || 'MeslektaÅŸ',
                                    action: 'BaÄŸlantÄ± isteÄŸi gÃ¶nderdi',
                                    time: this.formatTime(req.created_at),
                                    avatar: req.requester?.avatar_url || null,
                                    created_at: req.created_at
                                });
                            });

                        // 4. Sort safely (create copy with spread to avoid mutating reactive state)
                        return [...activities]
                            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                            .slice(0, 10);
                    },

                    // Helper: Format date safely
                    formatDate(dateString) {
                        if (!dateString) return '-';

                        try {
                            const date = new Date(dateString);
                            if (isNaN(date.getTime())) return '-';

                            return date.toLocaleDateString('tr-TR', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            });
                        } catch (e) {
                            return '-';
                        }
                    },

                    // Helper: Format location (district, city)
                    formatLocation(district, city) {
                        const parts = [district, city].filter(Boolean);
                        return parts.length > 0 ? parts.join(', ') : 'BelirtilmemiÅŸ';
                    },

                    // Helper: Format budget range
                    formatBudget(min, max, currency = 'TL') {
                        if (!min || min === 0) return '-';

                        const minStr = min.toLocaleString('tr-TR');
                        if (!max || max === 0 || max === min) {
                            return `${minStr} ${currency}`;
                        }

                        return `${minStr} - ${max.toLocaleString('tr-TR')} ${currency}`;
                    },

                    async init() {
                        this.isLoading = true;

                        try {
                            // Load location data for dropdowns (3-level hierarchy)
                            try {
                                const response = await fetch('assets/locations_full.json');
                                this.locationData = await response.json();
                                this.cities = Object.keys(this.locationData).sort();
                            } catch (e) {
                                console.error('Failed to load location data:', e);
                            }

                            // Check active session
                            const { data: { session } } = await supabase.auth.getSession();
                            this.user = session?.user || null;

                            // Listen for auth changes
                            supabase.auth.onAuthStateChange((_event, session) => {
                                this.user = session?.user || null;
                                if (this.user) {
                                    this.fetchData();
                                }
                            });

                            if (this.user) {
                                // âœ… Track login timestamp for Trust Score
                                const lastLoginTimestamp = localStorage.getItem('brokerlink_last_login');
                                const now = Date.now();

                                if (!lastLoginTimestamp) {
                                    // First login
                                    localStorage.setItem('brokerlink_last_login', now.toString());
                                } else {
                                    const daysSinceLogin = (now - parseInt(lastLoginTimestamp)) / (1000 * 60 * 60 * 24);

                                    // Update timestamp if more than 5 days passed
                                    if (daysSinceLogin > 5) {
                                        localStorage.setItem('brokerlink_last_login', now.toString());
                                    }
                                }

                                await this.fetchData();
                                await this.fetchProfile(); // Load user profile
                                await this.fetchBlockedUsers(); // Load blocked users first
                                await this.fetchBlockedUserProfiles(); // Load blocked user details
                                await this.fetchConnectionRequests(); // Load networking data
                                await this.fetchSentRequests();
                                await this.fetchConnections();
                                await this.fetchSuggestedBrokers(); // Load suggested brokers
                                await this.fetchNetworkDemands(); // Load network demands
                                await this.fetchNetworkPortfolios(); // Load network portfolios

                                // Realtime Subscription for Auto-Matching & Network Updates
                                supabase
                                    .channel('auto-match')
                                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'demands' }, async () => {
                                        await this.fetchNetworkDemands(); // Update Feed
                                        this.generateMatches(); // Run Match Algo
                                    })
                                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'portfolios' }, async () => {
                                        await this.fetchNetworkPortfolios(); // Update Feed
                                        this.generateMatches(); // Run Match Algo
                                    })
                                    .subscribe();

                                // Realtime Subscription for Network Connection Changes
                                supabase
                                    .channel('network-connections')
                                    .on('postgres_changes', { event: '*', schema: 'public', table: 'network_connections' }, async () => {
                                        await this.fetchConnectionRequests();
                                        await this.fetchSentRequests();
                                        await this.fetchConnections();
                                        await this.fetchSuggestedBrokers();
                                    })
                                    .subscribe();

                                // Realtime Subscription for Messages (incoming messages)
                                supabase
                                    .channel('messages-realtime')
                                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, async (payload) => {
                                        const newMsg = payload.new;
                                        // If message belongs to active conversation, add it instantly
                                        if (this.activeConversation && newMsg.conversation_id === this.activeConversation.id && newMsg.sender_id !== this.user.id) {
                                            const msg = {
                                                id: newMsg.id,
                                                sender: 'received',
                                                content: newMsg.content,
                                                time: new Date(newMsg.created_at).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }),
                                                read: newMsg.read
                                            };
                                            if (!this.messages[this.activeConversation.id]) {
                                                this.messages[this.activeConversation.id] = [];
                                            }
                                            this.messages[this.activeConversation.id].push(msg);
                                        }
                                        // Refresh conversation list to update last_message
                                        await this.loadConversations();
                                    })
                                    .subscribe();
                            }
                        } catch (error) {
                            console.error('Init error:', error);
                            this.showError('BaÅŸlatma hatasÄ±: ' + error.message);
                        } finally {
                            // Always set loading to false
                            this.isLoading = false;
                        }
                    },

                    async fetchData() {
                        try {
                            if (!this.user) {
                                return;
                            }

                            // Fetch Demands (only current user's demands)
                            const { data: demands, error: demandError } = await supabase
                                .from('demands')
                                .select('*')
                                .eq('user_id', this.user.id);
                            if (demandError) {
                                console.error('Error fetching demands:', demandError);
                                this.showError('Talepler yÃ¼klenemedi. LÃ¼tfen tekrar deneyin.');
                            }
                            // Map snake_case fields from Supabase to camelCase for frontend
                            this.demands = (demands || []).map(d => ({
                                ...d,
                                maxBudget: d.max_budget,
                                isUrgent: d.is_urgent,
                                matchCount: d.match_count || 0
                            }));

                            // Fetch Portfolios (only current user's portfolios)
                            this.isLoadingPortfolios = true;
                            const { data: portfolios, error: portfolioError } = await supabase
                                .from('portfolios')
                                .select('*')
                                .eq('user_id', this.user.id);
                            if (portfolioError) {
                                console.error('Error fetching portfolios:', portfolioError);
                                this.showError('Portfolyolar yÃ¼klenemedi. LÃ¼tfen tekrar deneyin.');
                            }
                            if (portfolios && portfolios.length > 0) {
                                this.portfolios = portfolios.map(p => ({
                                    ...p,
                                    image: p.image_url || p.image,
                                    location: p.location || p.district,
                                    district: p.district,
                                    rooms: p.rooms,
                                    area: p.area || '-',
                                    age: p.age || '-',
                                    // Workaround: Assign type based on price (since DB doesn't have type column)
                                    // Rental (KiralÄ±k) properties have lower monthly prices (< 100k)
                                    type: p.type || (p.price <= 100000 ? 'KiralÄ±k' : 'SatÄ±lÄ±k'),
                                    category: p.category,
                                    features: p.features || []
                                }));
                            }
                            this.isLoadingPortfolios = false;

                            // Fetch Matches (only current user's matches via demand.user_id)
                            const { data: matches, error: matchError } = await supabase
                                .from('matches')
                                .select(`
                                    *, 
                                    demand:demands!inner(*), 
                                    portfolio:portfolios(
                                        *,
                                        broker:profiles!portfolios_user_id_fkey(
                                            id,
                                            name,
                                            avatar_url,
                                            company,
                                            phone,
                                            title,
                                            trust_scores(total_score, level_emoji)
                                        )
                                    )
                                `)
                                .eq('demand.user_id', this.user.id);
                            if (matchError) {
                                console.error('Error fetching demand matches:', matchError);
                                this.showError('EÅŸleÅŸmeler yÃ¼klenemedi. LÃ¼tfen tekrar deneyin.');
                            }
                            if (matches && matches.length > 0) {
                                this.demandMatches = matches.map(m => {
                                    // 1. Format Portfolio Location 
                                    // New Data: City=MUÄžLA, Loc=BODRUM, Dist=YALIKAVAK -> YALIKAVAK, BODRUM, MUÄžLA
                                    // Old Data: Dist="Bebek, Ä°stanbul" -> check duplicates
                                    const p = m.portfolio || {};
                                    let pLoc = '';
                                    const dist = p.district || '';
                                    const loc = p.location || '';
                                    const city = p.city || '';

                                    // Robust Deduplication Logic
                                    // 1. Combine all parts into a single string first
                                    const rawLoc = `${dist}, ${loc}, ${city}`;

                                    // 2. Split by comma, trim whitespace, remove empty values
                                    const parts = rawLoc.split(',')
                                        .map(s => s.trim())
                                        .filter(s => s.length > 0);

                                    // 3. Use Set to remove exact duplicates (case-insensitive check handled by display logic if needed, but here usually standard)
                                    // To be safe, we keep the first occurrence of each unique string
                                    const uniqueParts = [...new Set(parts)];

                                    pLoc = uniqueParts.join(', ');

                                    // 2. Format Client Demand Location
                                    const d = m.demand || {};
                                    let dLoc = '';

                                    // Similar logic for client location if needed, but preferred logic is different:
                                    if (d.district && d.location && d.city) {
                                        // For demands we want: "YalÄ±kavak, GÃ¼mÃ¼ÅŸlÃ¼k (Bodrum, MuÄŸla)"
                                        // But fallback to simple join if needed
                                        const hoods = [d.district, d.district2, d.district3].filter(x => x).join(', ');
                                        // Deduplicate the parent location part too
                                        const parentLocParts = [d.location, d.city].filter(x => x);
                                        const uniqueParent = [...new Set(parentLocParts)].join(', ');

                                        dLoc = `${hoods} (${uniqueParent})`;
                                    } else {
                                        // Legacy fallback with dedup
                                        const rawD = `${d.district || ''}, ${d.location || ''}, ${d.city || ''}`;
                                        const dParts = rawD.split(',').map(s => s.trim()).filter(s => s);
                                        dLoc = [...new Set(dParts)].join(', ');
                                    }

                                    return {
                                        ...m,
                                        title: p.title,
                                        name: d.title || 'MÃ¼ÅŸteri Talebi', // Client demand title
                                        price: this.formatPrice(p.price),
                                        clientBudget: this.formatBudget(d.budget, d.max_budget), // Client demand budget range
                                        location: pLoc,        // Portfolio Location
                                        clientLocation: dLoc,  // Client Demand Location
                                        specs: `${p.rooms} â€¢ ${p.category}`,
                                        type: p.type || (p.price <= 100000 ? 'KiralÄ±k' : 'SatÄ±lÄ±k'), // Portfolio type
                                        score: m.score || 95,
                                        isFavorite: m.is_favorite || false,
                                        image: p.image_url || p.image || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?auto=format&fit=crop&w=800&q=80',
                                        // Broker info from nested query
                                        brokerName: p.broker?.name || 'Broker',
                                        brokerAvatar: p.broker?.avatar_url || null,
                                        brokerCompany: p.broker?.company || null,
                                        brokerPhone: p.broker?.phone || null,
                                        brokerTitle: p.broker?.title || 'Emlak DanÄ±ÅŸmanÄ±',
                                        brokerId: p.broker?.id || null,
                                        // âœ… Trust Score info
                                        brokerTrustScore: p.broker?.trust_scores?.total_score || 0,
                                        brokerTrustEmoji: p.broker?.trust_scores?.level_emoji || 'ðŸ”°'
                                    };
                                });
                            }

                            // Fetch Portfolio Matches (BENÄ°M portfÃ¶ylerim â†” BaÅŸkalarÄ±nÄ±n talepleri)
                            const { data: portfolioMatchesData, error: portfolioMatchError } = await supabase
                                .from('matches')
                                .select(`
                                    *, 
                                    demand:demands(
                                        *,
                                        profiles!demands_user_id_fkey(
                                            id,
                                            name,
                                            avatar_url,
                                            company,
                                            phone,
                                            title,
                                            trust_scores(total_score, level_emoji)
                                        )
                                    ), 
                                    portfolio:portfolios!inner(*)
                                `)
                                .eq('portfolio.user_id', this.user.id);

                            if (portfolioMatchError) {
                                console.error('Error fetching portfolio matches:', portfolioMatchError);
                            }

                            if (portfolioMatchesData && portfolioMatchesData.length > 0) {
                                this.portfolioMatches = portfolioMatchesData.map(m => {
                                    const d = m.demand || {};
                                    const p = m.portfolio || {};

                                    // Format locations
                                    const pLoc = [p.district, p.location, p.city].filter(x => x).join(', ');
                                    const dLoc = [d.district, d.location, d.city].filter(x => x).join(', ');

                                    // Get demand owner's profile (the broker we need to show)
                                    const demandOwner = d.profiles || {};

                                    return {
                                        ...m,
                                        // Portfolio (BENÄ°M)
                                        portfolioTitle: p.title,
                                        portfolioPrice: this.formatPrice(p.price),
                                        portfolioLocation: pLoc,
                                        portfolioSpecs: `${p.rooms} â€¢ ${p.category}`,
                                        portfolioImage: p.image_url || 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?auto=format&fit=crop&w=800&q=80',
                                        portfolioType: p.type || (p.price <= 100000 ? 'KiralÄ±k' : 'SatÄ±lÄ±k'),

                                        // Demand (KARÅžI TARAFIN)
                                        demandTitle: d.title || 'Talep',
                                        demandBudget: this.formatBudget(d.budget, d.max_budget),
                                        demandLocation: dLoc,
                                        demandSpecs: `${d.rooms} â€¢ ${d.category}`,

                                        // Client/Broker bilgisi (Talep sahibi - KARÅžI TARAF)
                                        // CRITICAL: Always use d.user_id for clientId since d.profiles may be null
                                        clientId: d.user_id,
                                        clientName: demandOwner.name || 'Broker',
                                        clientAvatar: demandOwner.avatar_url,
                                        clientCompany: demandOwner.company,
                                        clientPhone: demandOwner.phone,
                                        clientTitle: demandOwner.title || 'Emlak DanÄ±ÅŸmanÄ±',
                                        // âœ… Trust Score info (for portfolio matches, client is the demand owner)
                                        brokerTrustScore: demandOwner.trust_scores?.total_score || 0,
                                        brokerTrustEmoji: demandOwner.trust_scores?.level_emoji || 'ðŸ”°',

                                        score: m.score || 95,
                                        isFavorite: m.is_favorite || false
                                    };
                                });
                            }

                            // MOCK DATA RESTORATION (For Demo Purposes)

                            // 1. Mock Conversations - REMOVED
                            // Now loaded from Supabase only

                            // 2. Mock Messages - REMOVED  
                            // Now loaded from Supabase only

                            // 2. Network (Brokers) - loaded via fetchConnections()
                            // this.network is populated by fetchConnections() â€” no mock data

                            // 3. Network Portfolios - loaded via fetchNetworkPortfolios()
                            // this.networkPortfolios is populated by fetchNetworkPortfolios() RPC â€” no mock data

                            // 4. Network Demands - Loaded via fetchNetworkDemands() (no mock data)
                            // this.networkDemands will be populated by fetchNetworkDemands() call

                            // 5. Load conversations from Supabase
                            await this.loadConversations();

                            // 7. Load subscription / quota info
                            await this.loadSubscription();

                            // 6. Calculate Trust Score
                            await this.calculateTrustScore();
                        } catch (e) {
                            console.error('CRITICAL ERROR in fetchData:', e);
                            alert('Bir hata oluÅŸtu: ' + e.message);
                        }
                    },

                    async loadSubscription() {
                        try {
                            const { data, error } = await supabase.rpc('get_my_subscription');
                            if (!error && data) {
                                this.subscription = data;
                            }
                        } catch (e) {
                            console.warn('Subscription load failed:', e);
                        }
                    },

                    async loadConversations() {
                        if (!this.user) return;

                        this.isLoadingConversations = true;
                        try {
                            const { data, error } = await supabase
                                .from('conversations')
                                .select('*')
                                .order('updated_at', { ascending: false });

                            if (error) throw error;

                            if (data && data.length > 0) {
                                // Fetch avatars from profiles for each conversation
                                const conversationsWithAvatars = await Promise.all(
                                    data.map(async (c) => {
                                        let avatar = null;
                                        let name = c.participant_name;

                                        // Determine the "other person" from current user's perspective
                                        const otherUserId = c.user_id === this.user.id ? c.receiver_id : c.user_id;

                                        if (otherUserId) {
                                            const { data: profile } = await supabase
                                                .from('profiles')
                                                .select('avatar_url, name')
                                                .eq('id', otherUserId)
                                                .single();

                                            if (profile) {
                                                avatar = profile.avatar_url;
                                                name = profile.name || c.participant_name;
                                            }
                                        }

                                        return {
                                            id: c.id,
                                            userName: name,
                                            lastMessage: c.last_message || 'Yeni konuÅŸma',
                                            time: this.formatTime(c.last_message_time),
                                            unread: c.unread_count || 0,
                                            userImage: avatar,
                                            receiverId: otherUserId
                                        };
                                    })
                                );

                                this.conversations = conversationsWithAvatars.filter(c => !this.isBlocked(c.receiverId));
                            } else {
                            }
                        } catch (error) {
                            console.error('Error loading conversations:', error);
                            this.showError('KonuÅŸmalar yÃ¼klenemedi. LÃ¼tfen tekrar deneyin.');
                        } finally {
                            this.isLoadingConversations = false;
                        }
                    },

                    async loadMessages(conversationId) {
                        if (!this.user || !conversationId) return;

                        try {
                            const { data, error } = await supabase
                                .from('messages')
                                .select('*')
                                .eq('conversation_id', conversationId)
                                .order('created_at', { ascending: true });

                            if (error) throw error;

                            const messages = data.map(m => ({
                                id: m.id,
                                sender: m.sender_id === this.user.id ? 'sent' : 'received',
                                content: m.content,
                                time: new Date(m.created_at).toLocaleTimeString('tr-TR', {
                                    hour: '2-digit',
                                    minute: '2-digit'
                                }),
                                read: m.read
                            }));

                            this.messages[conversationId] = messages;
                            return messages;
                        } catch (error) {
                            console.error('Error loading messages:', error);
                            return [];
                        }
                    },

                    // generateMatches() â€” defined in MATCHING ALGORITHM section below

                    // PROFILE MANAGEMENT
                    async fetchProfile() {
                        if (!this.user) return;

                        try {
                            const { data, error } = await supabase
                                .from('profiles')
                                .select('*')
                                .eq('id', this.user.id)
                                .single();

                            if (error) {
                                console.error('Profile fetch error:', error);
                                return;
                            }

                            // Merge fetched data with existing userProfile to preserve structure
                            if (data) {
                                this.userProfile = {
                                    ...this.userProfile,
                                    ...data
                                };
                            }
                        } catch (error) {
                            console.error('Error fetching profile:', error);
                        }
                    },

                    // SERVICE AREA MANAGEMENT
                    addServiceArea() {
                        if (!this.tempServiceCity || !this.tempServiceDistrict) {
                            alert('LÃ¼tfen ÅŸehir ve ilÃ§e seÃ§in!');
                            return;
                        }

                        // Check if already exists
                        const exists = this.userProfile.service_areas.some(area =>
                            area.city === this.tempServiceCity && area.district === this.tempServiceDistrict
                        );

                        if (exists) {
                            alert('Bu bÃ¶lge zaten ekli!');
                            return;
                        }

                        this.userProfile.service_areas.push({
                            city: this.tempServiceCity,
                            district: this.tempServiceDistrict
                        });

                        // Reset temp selections
                        this.tempServiceCity = '';
                        this.tempServiceDistrict = '';
                    },

                    removeServiceArea(index) {
                        this.userProfile.service_areas.splice(index, 1);
                    },

                    // SPECIALTY HASHTAG MANAGEMENT
                    normalizeTag(tag) {
                        // TÃ¼rkÃ§e karakterleri Ä°ngilizce'ye Ã§evir, kÃ¼Ã§Ã¼k harfe dÃ¶nÃ¼ÅŸtÃ¼r ve boÅŸluklarÄ± kaldÄ±r
                        return tag.toLowerCase()
                            .replace(/ÄŸ/g, 'g')
                            .replace(/Ã¼/g, 'u')
                            .replace(/ÅŸ/g, 's')
                            .replace(/Ä±/g, 'i')
                            .replace(/Ã¶/g, 'o')
                            .replace(/Ã§/g, 'c')
                            .replace(/\s+/g, '') // TÃ¼m boÅŸluklarÄ± kaldÄ±r
                            .trim();
                    },

                    addSpecialty() {
                        if (!this.tempSpecialty || this.tempSpecialty.trim() === '') {
                            return;
                        }

                        const specialty = this.tempSpecialty.trim();

                        // Check if already exists (normalized comparison)
                        const normalized = this.normalizeTag(specialty);
                        const exists = this.userProfile.specialties.some(s =>
                            this.normalizeTag(s) === normalized
                        );

                        if (exists) {
                            alert('Bu uzmanlÄ±k alanÄ± zaten ekli!');
                            return;
                        }

                        this.userProfile.specialties.push(specialty);
                        this.tempSpecialty = '';
                    },

                    removeSpecialty(index) {
                        this.userProfile.specialties.splice(index, 1);
                    },

                    // IMAGE UPLOAD
                    async uploadImage(file, type) {
                        if (!file || !this.user) return null;

                        try {
                            // Validate file type
                            if (!file.type.startsWith('image/')) {
                                alert('LÃ¼tfen sadece resim dosyasÄ± yÃ¼kleyin!');
                                return null;
                            }

                            // Validate file size (max 5MB)
                            if (file.size > 5 * 1024 * 1024) {
                                alert('Resim boyutu 5MB\'dan kÃ¼Ã§Ã¼k olmalÄ±!');
                                return null;
                            }

                            const fileName = `${this.user.id} / ${type}_${Date.now()}.jpg`;

                            // Upload to Supabase Storage
                            const { data, error } = await supabase.storage
                                .from('profile-images')
                                .upload(fileName, file, {
                                    cacheControl: '3600',
                                    upsert: false
                                });

                            if (error) {
                                console.error('Upload error:', error);
                                alert('Resim yÃ¼klenemedi!');
                                return null;
                            }

                            // Get public URL
                            const { data: { publicUrl } } = supabase.storage
                                .from('profile-images')
                                .getPublicUrl(fileName);

                            return publicUrl;
                        } catch (error) {
                            console.error('Image upload error:', error);
                            alert('Bir hata oluÅŸtu!');
                            return null;
                        }
                    },

                    async handleAvatarUpload(event) {
                        const file = event.target.files[0];
                        if (!file) return;

                        const url = await this.uploadImage(file, 'avatar');
                        if (url) {
                            this.userProfile.avatar_url = url;
                            await this.saveProfile();
                            await this.fetchProfile(); // Refresh to show new image
                        }
                    },

                    async handleCoverUpload(event) {
                        const file = event.target.files[0];
                        if (!file) return;

                        const url = await this.uploadImage(file, 'cover');
                        if (url) {
                            this.userProfile.cover_url = url;
                            await this.saveProfile();
                            await this.fetchProfile(); // Refresh to show new image
                        }
                    },

                    // NETWORKING DATA FETCH
                    async fetchConnectionRequests() {
                        if (!this.user) return;

                        try {
                            const { data, error } = await supabase
                                .from('network_connections')
                                .select(`
                            *,
                                requester: profiles!network_connections_requester_id_fkey(*)
                                    `)
                                .eq('receiver_id', this.user.id)
                                .eq('status', 'pending');

                            if (error) throw error;
                            this.connectionRequests = data || [];
                        } catch (error) {
                            console.error('Error fetching connection requests:', error);
                        }
                    },

                    async fetchSentRequests() {
                        if (!this.user) return;

                        try {
                            const { data, error } = await supabase
                                .from('network_connections')
                                .select(`
                            *,
                                receiver: profiles!network_connections_receiver_id_fkey(*)
                                    `)
                                .eq('requester_id', this.user.id)
                                .eq('status', 'pending');

                            if (error) throw error;
                            this.sentRequests = data || [];
                        } catch (error) {
                            console.error('Error fetching sent requests:', error);
                        }
                    },

                    async fetchConnections() {
                        if (!this.user) return;

                        try {
                            const { data, error } = await supabase
                                .from('network_connections')
                                .select(`
                            *,
                                requester: profiles!network_connections_requester_id_fkey(
                                    *,
                                    trust_scores(total_score, level_emoji)
                                ),
                                receiver: profiles!network_connections_receiver_id_fkey(
                                    *,
                                    trust_scores(total_score, level_emoji)
                                )
                                `)
                                .eq('status', 'accepted')
                                .or(`requester_id.eq.${this.user.id}, receiver_id.eq.${this.user.id}`);

                            if (error) throw error;

                            // Map to get the "other" person's profile and filter out blocked users
                            this.connections = (data || [])
                                .map(conn => {
                                    const otherPerson = conn.requester_id === this.user.id
                                        ? conn.receiver
                                        : conn.requester;
                                    return {
                                        ...conn,
                                        broker: otherPerson,
                                        broker_id: otherPerson.id
                                    };
                                })
                                .filter(conn => !this.isBlocked(conn.broker_id)); // Filter blocked users


                            // Fetch recent activities from connections
                            await this.fetchNetworkActivities();
                        } catch (error) {
                            console.error('Error fetching connections:', error);
                        }
                    },

                    async fetchNetworkActivities() {
                        if (!this.connections || this.connections.length === 0) {
                            this.networkActivities = [];
                            return;
                        }

                        try {
                            const connectionIds = this.connections.map(c => c.broker_id);

                            // Fetch recent portfolios from connections
                            const { data: portfolios } = await supabase
                                .from('portfolios')
                                .select('id, title, created_at, user_id, profiles(name, avatar_url)')
                                .in('user_id', connectionIds)
                                .order('created_at', { ascending: false })
                                .limit(3);

                            // Fetch recent demands from connections
                            const { data: demands } = await supabase
                                .from('demands')
                                .select('id, title, created_at, user_id, profiles(name, avatar_url)')
                                .in('user_id', connectionIds)
                                .order('created_at', { ascending: false })
                                .limit(3);

                            // Combine and sort activities
                            const activities = [];

                            if (portfolios) {
                                portfolios.forEach(p => {
                                    activities.push({
                                        id: 'portfolio_' + p.id,
                                        user: p.profiles.name,
                                        avatar: p.profiles.avatar_url,
                                        action: 'Yeni portfÃ¶y ekledi: ' + p.title,
                                        time: this.formatTime(p.created_at),
                                        timestamp: new Date(p.created_at).getTime()
                                    });
                                });
                            }

                            if (demands) {
                                demands.forEach(d => {
                                    activities.push({
                                        id: 'demand_' + d.id,
                                        user: d.profiles.name,
                                        avatar: d.profiles.avatar_url,
                                        action: 'Yeni talep ekledi: ' + d.title,
                                        time: this.formatTime(d.created_at),
                                        timestamp: new Date(d.created_at).getTime()
                                    });
                                });
                            }

                            // Sort by timestamp (newest first) and take top 5
                            this.networkActivities = activities
                                .sort((a, b) => b.timestamp - a.timestamp)
                                .slice(0, 5);

                        } catch (error) {
                            console.error('Error fetching network activities:', error);
                            this.networkActivities = [];
                        }
                    },

                    // NETWORKING ACTIONS
                    async getConnectionStatus(brokerId) {
                        if (!this.user || !brokerId) return 'none';

                        // Check if already connected
                        const connected = this.connections.some(c => c.broker_id === brokerId);
                        if (connected) return 'connected';

                        // Check if pending request sent
                        const sentPending = this.sentRequests.some(r => r.receiver_id === brokerId);
                        if (sentPending) return 'pending_sent';

                        // Check if pending request received
                        const receivedPending = this.connectionRequests.some(r => r.requester_id === brokerId);
                        if (receivedPending) return 'pending_received';

                        return 'none';
                    },

                    async sendConnectionRequest(receiverId) {
                        if (!this.user) return;

                        // Validation 1: Cannot send to self
                        if (receiverId === this.user.id) {
                            alert('Kendinize baÄŸlantÄ± isteÄŸi gÃ¶nderemezsiniz!');
                            return;
                        }

                        // Validation 2: Check if connection already exists
                        const status = await this.getConnectionStatus(receiverId);
                        if (status !== 'none') {
                            if (status === 'connected') alert('Zaten baÄŸlantÄ±dasÄ±nÄ±z!');
                            else if (status === 'pending_sent') alert('Zaten bir istek gÃ¶nderdiniz!');
                            else if (status === 'pending_received') alert('Bu kiÅŸiden zaten bir istek aldÄ±nÄ±z!');
                            return;
                        }

                        try {
                            const { error } = await supabase
                                .from('network_connections')
                                .insert({
                                    requester_id: this.user.id,
                                    receiver_id: receiverId,
                                    status: 'pending'
                                });

                            if (error) throw error;

                            await this.fetchSentRequests();
                            this.showBrokerModal = false;
                            alert('BaÄŸlantÄ± isteÄŸi gÃ¶nderildi!');
                        } catch (error) {
                            console.error('Error sending connection request:', error);
                            alert('Ä°stek gÃ¶nderilemedi!');
                        }
                    },

                    async acceptConnectionRequest(requestId) {
                        if (!this.user) return;

                        try {
                            const { error } = await supabase
                                .from('network_connections')
                                .update({ status: 'accepted', updated_at: new Date().toISOString() })
                                .eq('id', requestId);

                            if (error) throw error;

                            await this.fetchConnectionRequests();
                            await this.fetchSentRequests();
                            await this.fetchConnections();
                            await this.fetchSuggestedBrokers();

                            // Update broker modal if open
                            if (this.showBrokerModal && this.selectedBroker) {
                                this.selectedBroker.connectionStatus = 'connected';
                            }

                            alert('BaÄŸlantÄ± kabul edildi!');
                        } catch (error) {
                            console.error('Error accepting connection:', error);
                            alert('Kabul edilemedi!');
                        }
                    },

                    async rejectConnectionRequest(requestId) {
                        if (!this.user) return;

                        try {
                            const { error } = await supabase
                                .from('network_connections')
                                .delete()
                                .eq('id', requestId);

                            if (error) throw error;

                            await this.fetchConnectionRequests();
                            await this.fetchSentRequests();
                            await this.fetchSuggestedBrokers();

                            // Update broker modal if open
                            if (this.showBrokerModal && this.selectedBroker) {
                                this.selectedBroker.connectionStatus = 'none';
                            }

                            alert('BaÄŸlantÄ± isteÄŸi reddedildi.');
                        } catch (error) {
                            console.error('Error rejecting connection:', error);
                            alert('Reddedilemedi!');
                        }
                    },

                    async viewBrokerProfile(brokerId) {
                        if (!brokerId) return;

                        try {
                            const { data, error } = await supabase
                                .from('profiles')
                                .select('*')
                                .eq('id', brokerId)
                                .single();

                            if (error) throw error;

                            this.selectedBroker = data;
                            this.selectedBroker.connectionStatus = await this.getConnectionStatus(brokerId);
                            this.showBrokerModal = true;
                        } catch (error) {
                            console.error('Error viewing broker profile:', error);
                            alert('Profil yÃ¼klenemedi!');
                        }
                    },

                    showBrokerContact(match) {
                        if (!match) return;
                        this.selectedMatchContact = match;
                        this.contactModalOpen = true;
                    },

                    showClientContact(match) {
                        if (!match) return;
                        // Convert client data to broker format for modal
                        this.selectedMatchContact = {
                            ...match,
                            brokerName: match.clientName,
                            brokerAvatar: match.clientAvatar,
                            brokerCompany: match.clientCompany,
                            brokerPhone: match.clientPhone,
                            brokerTitle: match.clientTitle,
                            title: match.portfolioTitle,
                            price: match.portfolioPrice
                        };
                        this.contactModalOpen = true;
                    },

                    showConnectionContact(connection) {
                        if (!connection || !connection.broker) return;
                        // Convert connection data to broker format for modal
                        this.selectedMatchContact = {
                            brokerName: connection.broker.name,
                            brokerAvatar: connection.broker.avatar_url,
                            brokerCompany: connection.broker.company,
                            brokerPhone: connection.broker.phone,
                            brokerTitle: connection.broker.title
                        };
                        this.contactModalOpen = true;
                    },

                    async openConversation(brokerId, brokerName) {
                        // Switch to messages tab
                        this.currentTab = 'messages';

                        // Find existing conversation with this broker
                        const existingConv = this.conversations.find(c =>
                            c.receiverId === brokerId
                        );

                        if (existingConv) {
                            // Open existing conversation
                            this.activeConversation = existingConv;
                            this.loadMessages(existingConv.id);
                        } else {
                            // Fetch broker profile to get avatar
                            const { data: brokerProfile } = await supabase
                                .from('profiles')
                                .select('avatar_url, name')
                                .eq('id', brokerId)
                                .single();

                            // Create new conversation - just set activeConversation
                            // The user can start typing and it will create the conversation
                            this.activeConversation = {
                                id: null,
                                other_user_id: brokerId,
                                other_user_name: brokerName,
                                userName: brokerProfile?.name || brokerName,
                                userImage: brokerProfile?.avatar_url || null,
                                lastMessage: 'Yeni konuÅŸma',
                                time: 'Åžimdi',
                                unread: 0
                            };
                        }
                    },

                    async deleteConversation(conversationId) {
                        if (!confirm('Bu konuÅŸmayÄ± silmek istediÄŸinizden emin misiniz?')) return;

                        try {
                            // Delete from database
                            const { error } = await supabase
                                .from('conversations')
                                .delete()
                                .eq('id', conversationId);

                            if (error) throw error;

                            // Remove from local state
                            this.conversations = this.conversations.filter(c => c.id !== conversationId);
                            this.activeConversation = null;
                            delete this.messages[conversationId];

                        } catch (error) {
                            console.error('Error deleting conversation:', error);
                            alert('KonuÅŸma silinemedi');
                        }
                    },

                    async fetchBlockedUsers() {
                        if (!this.user) return;
                        try {
                            const { data, error } = await supabase
                                .from('blocked_users')
                                .select('blocked_id')
                                .eq('blocker_id', this.user.id);
                            if (error) throw error;
                            this.blockedUsers = (data || []).map(b => b.blocked_id);
                        } catch (error) {
                            console.error('Error fetching blocked users:', error);
                        }
                    },

                    isBlocked(userId) {
                        return this.blockedUsers.includes(userId);
                    },

                    async blockUser(userId) {
                        if (!userId) return;
                        if (!confirm('Bu kullanÄ±cÄ±yÄ± engellemek istediÄŸinizden emin misiniz? Engellenen kullanÄ±cÄ± size mesaj gÃ¶nderemez ve aÄŸÄ±nÄ±zda gÃ¶rÃ¼nmez.')) return;

                        try {
                            // 1. Insert into blocked_users
                            const { error: blockError } = await supabase
                                .from('blocked_users')
                                .insert({ blocker_id: this.user.id, blocked_id: userId });
                            if (blockError) throw blockError;

                            // 2. Remove from connections if exists
                            await supabase
                                .from('network_connections')
                                .delete()
                                .or(`and(requester_id.eq.${this.user.id},receiver_id.eq.${userId}),and(requester_id.eq.${userId},receiver_id.eq.${this.user.id})`);

                            // 3. Update local state
                            this.blockedUsers.push(userId);
                            await this.fetchBlockedUserProfiles(); // Update profiles list
                            this.connections = this.connections.filter(c => c.broker_id !== userId);
                            this.conversations = this.conversations.filter(c => c.receiverId !== userId);
                            this.suggestedBrokers = this.suggestedBrokers.filter(b => b.id !== userId);
                            this.networkDemands = this.networkDemands.filter(d => d.user_id !== userId);
                            this.networkPortfolios = this.networkPortfolios.filter(p => p.user_id !== userId);
                            this.connectionRequests = this.connectionRequests.filter(r => r.requester_id !== userId);
                            this.sentRequests = this.sentRequests.filter(r => r.receiver_id !== userId);

                            // 4. Clear active conversation if it was with blocked user
                            if (this.activeConversation && this.activeConversation.receiverId === userId) {
                                this.activeConversation = null;
                            }

                            alert('KullanÄ±cÄ± engellendi.');
                        } catch (error) {
                            console.error('Error blocking user:', error);
                            alert('Engelleme baÅŸarÄ±sÄ±z: ' + error.message);
                        }
                    },

                    async unblockUser(userId) {
                        if (!userId) return;
                        if (!confirm('Bu kullanÄ±cÄ±nÄ±n engelini kaldÄ±rmak istediÄŸinizden emin misiniz?')) return;

                        try {
                            const { error } = await supabase
                                .from('blocked_users')
                                .delete()
                                .eq('blocker_id', this.user.id)
                                .eq('blocked_id', userId);
                            if (error) throw error;

                            this.blockedUsers = this.blockedUsers.filter(id => id !== userId);

                            // Refresh data to show unblocked user's content again
                            await this.fetchBlockedUserProfiles();
                            await this.fetchConnections(); // Refresh connections
                            await this.fetchSuggestedBrokers();
                            await this.fetchNetworkDemands();
                            await this.fetchNetworkPortfolios();

                            alert('Engel kaldÄ±rÄ±ldÄ±.');
                        } catch (error) {
                            console.error('Error unblocking user:', error);
                            alert('Engel kaldÄ±rÄ±lamadÄ±: ' + error.message);
                        }
                    },

                    async fetchBlockedUserProfiles() {
                        if (!this.user || this.blockedUsers.length === 0) {
                            this.blockedUserProfiles = [];
                            return;
                        }

                        try {
                            const { data, error } = await supabase
                                .from('profiles')
                                .select('id, name, avatar_url, company, title')
                                .in('id', this.blockedUsers);

                            if (error) throw error;
                            this.blockedUserProfiles = data || [];
                        } catch (error) {
                            console.error('Error fetching blocked user profiles:', error);
                        }
                    },

                    async fetchSuggestedBrokers() {
                        if (!this.user) return;

                        // Reset pagination
                        this.brokersOffset = 0;
                        this.brokersHasMore = true;
                        this.suggestedBrokers = [];

                        await this.loadMoreBrokers();
                    },

                    async loadMoreBrokers() {
                        if (!this.user || this.brokersLoading || !this.brokersHasMore) return;

                        const PAGE_SIZE = 20;
                        this.brokersLoading = true;

                        try {
                            const { data, error } = await supabase
                                .from('profiles')
                                .select('*')
                                .neq('id', this.user.id)
                                .order('name', { ascending: true })
                                .range(this.brokersOffset, this.brokersOffset + PAGE_SIZE - 1);

                            if (error) throw error;

                            // Filter out blocked users and calculate connection status
                            const filtered = (data || []).filter(b => !this.isBlocked(b.id));
                            const withStatus = await Promise.all(filtered.map(async b => {
                                const status = await this.getConnectionStatus(b.id);
                                return { ...b, connectionStatus: status };
                            }));

                            this.suggestedBrokers = [...this.suggestedBrokers, ...withStatus];
                            this.brokersOffset += PAGE_SIZE;

                            // EÄŸer gelen kayÄ±t sayÄ±sÄ± PAGE_SIZE'dan azsa daha fazla yoktur
                            if ((data || []).length < PAGE_SIZE) {
                                this.brokersHasMore = false;
                            }
                        } catch (error) {
                            console.error('Error loading more brokers:', error);
                        } finally {
                            this.brokersLoading = false;
                        }
                    },

                    async fetchNetworkDemands() {
                        if (!this.user) return;

                        try {
                            const { data, error } = await supabase.rpc('get_network_demands');

                            if (error) {
                                console.error('Error fetching network demands:', error);
                                return;
                            }

                            this.networkDemands = data || [];
                        } catch (error) {
                            console.error('Error in fetchNetworkDemands:', error);
                        }
                    },

                    async fetchNetworkPortfolios() {
                        if (!this.user) return;

                        try {
                            const { data, error } = await supabase.rpc('get_network_portfolios');

                            if (error) {
                                console.error('Error fetching network portfolios:', error);
                                return;
                            }

                            this.networkPortfolios = data || [];
                        } catch (error) {
                            console.error('Error in fetchNetworkPortfolios:', error);
                        }
                    },

                    async saveProfile() {
                        if (!this.user) return;

                        try {

                            const { data, error } = await supabase
                                .from('profiles')
                                .upsert({
                                    id: this.user.id,
                                    name: this.userProfile.name,
                                    title: this.userProfile.title,
                                    bio: this.userProfile.bio,
                                    company: this.userProfile.company,
                                    phone: this.userProfile.phone,
                                    avatar_url: this.userProfile.avatar_url,
                                    cover_url: this.userProfile.cover_url,
                                    ttyb_number: this.userProfile.ttyb_number,
                                    ttyb_verified: !!this.userProfile.ttyb_number, // Auto-verify if TTYB exists
                                    service_areas: this.userProfile.service_areas, // Hizmet bÃ¶lgeleri
                                    specialties: this.userProfile.specialties // UzmanlÄ±k alanlarÄ±
                                })
                                .select();


                            if (error) {
                                console.error('âŒ Profile update error:', error);
                                alert('Profil gÃ¼ncellenemedi! Hata: ' + error.message);
                                return;
                            }

                            if (!data || data.length === 0) {
                                console.error('âŒ No data returned from upsert - RLS policy might be blocking!');
                                alert('Profil kaydedilemedi! RLS policy sorunu olabilir. Console\'u kontrol edin.');
                                return;
                            }

                            this.editMode = false;
                            await this.fetchProfile(); // Refresh
                            alert('Profil baÅŸarÄ±yla gÃ¼ncellendi!');
                        } catch (error) {
                            console.error('âŒ Error saving profile:', error);
                            alert('Bir hata oluÅŸtu: ' + error.message);
                        }
                    },

                    async seedData() {
                        if (!this.user) return;
                        if (!confirm('VeritabanÄ±na Ã¶rnek veriler eklenecek. OnaylÄ±yor musunuz?')) return;


                        // 1. Create/Update Profile
                        const { error: profileError } = await supabase.from('profiles').update({ name: 'Ahmet YÄ±lmaz', role: 'broker' }).eq('id', this.user.id);
                        if (profileError) console.error('SeedData: Profile update error:', profileError);

                        // 2. Insert Demands
                        const mockDemands = [
                            { user_id: this.user.id, title: 'Bebek Sahil LÃ¼ks Daire', budget: 45000000, max_budget: 50000000, district: 'Bebek, BeÅŸiktaÅŸ', rooms: '3+1', category: 'Daire', status: 'active' },
                            { user_id: this.user.id, title: 'YenikÃ¶y BoÄŸaz ManzaralÄ± Villa', budget: 85000000, max_budget: 90000000, district: 'YenikÃ¶y, SarÄ±yer', rooms: '5+1', category: 'Villa', status: 'pending' },
                            { user_id: this.user.id, title: 'Suadiye KiralÄ±k Daire', budget: 45000, max_budget: 50000, district: 'Suadiye, KadÄ±kÃ¶y', rooms: '3+1', category: 'Daire', status: 'active' }
                        ];
                        const { data: demandData, error: demandError } = await supabase.from('demands').insert(mockDemands).select();
                        if (demandError) console.error('SeedData: Demand insert error:', demandError);

                        // 3. Insert Portfolios - 24 total (12 SatÄ±lÄ±k, 12 KiralÄ±k)
                        const mockPortfolios = [
                            // SATILIK - Villa (3)
                            { user_id: this.user.id, title: 'BahÃ§eli MÃ¼stakil Villa', price: 1200000, location: 'SarÄ±yer', district: 'SarÄ±yer, Ä°stanbul', rooms: '5+1', area: '250mÂ²', age: '2y', type: 'SatÄ±lÄ±k', category: 'Villa', features: ['Havuz', 'BahÃ§e'], image_url: 'https://images.unsplash.com/photo-1613490493576-7fde63acd811?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'BoÄŸaz ManzaralÄ± Villa', price: 2500000, location: 'Bebek', district: 'Bebek, Ä°stanbul', rooms: '6+2', area: '350mÂ²', age: '4y', type: 'SatÄ±lÄ±k', category: 'Villa', features: ['Deniz ManzarasÄ±', 'Jakuzi'], image_url: 'https://images.unsplash.com/photo-1600566753190-17f0baa2a6c3?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'Modern Villa', price: 1800000, location: 'ZekeriyakÃ¶y', district: 'ZekeriyakÃ¶y, Ä°stanbul', rooms: '4+2', area: '280mÂ²', age: '1y', type: 'SatÄ±lÄ±k', category: 'Villa', features: ['AkÄ±llÄ± Ev', 'Garaj'], image_url: 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?auto=format&fit=crop&w=800&q=80' },
                            // SATILIK - Daire (3)
                            { user_id: this.user.id, title: 'Modern Aile Dairesi', price: 450000, location: 'KadÄ±kÃ¶y', district: 'KadÄ±kÃ¶y, Ä°stanbul', rooms: '3+1', area: '140mÂ²', age: '5y', type: 'SatÄ±lÄ±k', category: 'Daire', features: ['Otopark', 'AsansÃ¶r'], image_url: 'https://images.unsplash.com/photo-1600596542815-2495db9dc2c3?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'Deniz ManzaralÄ± Daire', price: 890000, location: 'BeÅŸiktaÅŸ', district: 'BeÅŸiktaÅŸ, Ä°stanbul', rooms: '4+1', area: '180mÂ²', age: '2y', type: 'SatÄ±lÄ±k', category: 'Daire', features: ['Otopark', 'GÃ¼venlik'], image_url: 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'LÃ¼ks Rezidans', price: 750000, location: 'Levent', district: 'Levent, Ä°stanbul', rooms: '2+1', area: '120mÂ²', age: '3y', type: 'SatÄ±lÄ±k', category: 'Daire', features: ['Spor Salonu', 'Havuz'], image_url: 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?auto=format&fit=crop&w=800&q=80' },
                            // SATILIK - Arsa (3)
                            { user_id: this.user.id, title: 'YatÄ±rÄ±mlÄ±k Arsa', price: 850000, location: 'Ã‡ekmekÃ¶y', district: 'Ã‡ekmekÃ¶y, Ä°stanbul', rooms: '-', area: '500mÂ²', age: '-', type: 'SatÄ±lÄ±k', category: 'Arsa', features: ['Ä°marlÄ±'], image_url: 'https://images.unsplash.com/photo-1500382017468-9049fed747ef?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'Denize SÄ±fÄ±r Arsa', price: 1500000, location: 'Åžile', district: 'Åžile, Ä°stanbul', rooms: '-', area: '1000mÂ²', age: '-', type: 'SatÄ±lÄ±k', category: 'Arsa', features: ['Deniz ManzarasÄ±'], image_url: 'https://images.unsplash.com/photo-1628624747186-a941c476b7ef?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'KÃ¶y ArsasÄ±', price: 350000, location: 'Silivri', district: 'Silivri, Ä°stanbul', rooms: '-', area: '2000mÂ²', age: '-', type: 'SatÄ±lÄ±k', category: 'Arsa', features: ['Tarla'], image_url: 'https://images.unsplash.com/photo-1625246333195-78d9c38ad449?auto=format&fit=crop&w=800&q=80' },
                            // SATILIK - Ä°ÅŸyeri (3)
                            { user_id: this.user.id, title: 'Cadde Ãœzeri DÃ¼kkan', price: 950000, location: 'BakÄ±rkÃ¶y', district: 'BakÄ±rkÃ¶y, Ä°stanbul', rooms: '-', area: '85mÂ²', age: '8y', type: 'SatÄ±lÄ±k', category: 'Ä°ÅŸyeri', features: ['Vitrin', 'Depo'], image_url: 'https://images.unsplash.com/photo-1441986300917-64674bd600d8?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'Plaza Ofis', price: 1200000, location: 'Maslak', district: 'Maslak, Ä°stanbul', rooms: '3+1', area: '150mÂ²', age: '5y', type: 'SatÄ±lÄ±k', category: 'Ä°ÅŸyeri', features: ['Otopark', 'ToplantÄ± OdasÄ±'], image_url: 'https://images.unsplash.com/photo-1497366216548-37526070297c?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'Fabrika BinasÄ±', price: 3500000, location: 'Tuzla', district: 'Tuzla, Ä°stanbul', rooms: '-', area: '2000mÂ²', age: '15y', type: 'SatÄ±lÄ±k', category: 'Ä°ÅŸyeri', features: ['YÃ¼kleme RampasÄ±'], image_url: 'https://images.unsplash.com/photo-1553062407-98eeb64c6a62?auto=format&fit=crop&w=800&q=80' },
                            // KIRALIK - Villa (3)
                            { user_id: this.user.id, title: 'KiralÄ±k Havuzlu Villa', price: 45000, location: 'ZekeriyakÃ¶y', district: 'ZekeriyakÃ¶y, Ä°stanbul', rooms: '4+2', area: '280mÂ²', age: '2y', type: 'KiralÄ±k', category: 'Villa', features: ['BahÃ§e', 'Havuz'], image_url: 'https://images.unsplash.com/photo-1564013799919-ab600027ffc6?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'Deniz KenarÄ± Villa', price: 65000, location: 'Dragos', district: 'Dragos, Ä°stanbul', rooms: '5+1', area: '320mÂ²', age: '3y', type: 'KiralÄ±k', category: 'Villa', features: ['Deniz ManzarasÄ±', 'Ä°skele'], image_url: 'https://images.unsplash.com/photo-1580587771525-78b9dba3b914?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'Orman ManzaralÄ± Villa', price: 35000, location: 'Kemerburgaz', district: 'Kemerburgaz, Ä°stanbul', rooms: '4+1', area: '240mÂ²', age: '4y', type: 'KiralÄ±k', category: 'Villa', features: ['ÅžÃ¶mine', 'BahÃ§e'], image_url: 'https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?auto=format&fit=crop&w=800&q=80' },
                            // KIRALIK - Daire (3)
                            { user_id: this.user.id, title: 'Rezidans Dairesi', price: 25000, location: 'Levent', district: 'Levent, Ä°stanbul', rooms: '2+1', area: '110mÂ²', age: '3y', type: 'KiralÄ±k', category: 'Daire', features: ['Spor Salonu', 'Havuz'], image_url: 'https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'Merkezi Daire', price: 18000, location: 'ÅžiÅŸli', district: 'ÅžiÅŸli, Ä°stanbul', rooms: '3+1', area: '130mÂ²', age: '6y', type: 'KiralÄ±k', category: 'Daire', features: ['Metro YakÄ±nÄ±', 'AsansÃ¶r'], image_url: 'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'BoÄŸaz ManzaralÄ± Daire', price: 40000, location: 'OrtakÃ¶y', district: 'OrtakÃ¶y, Ä°stanbul', rooms: '3+1', area: '145mÂ²', age: '2y', type: 'KiralÄ±k', category: 'Daire', features: ['Balkon', 'Manzara'], image_url: 'https://images.unsplash.com/photo-1493809842364-78817add7ffb?auto=format&fit=crop&w=800&q=80' },
                            // KIRALIK - Arsa (3)
                            { user_id: this.user.id, title: 'Otopark ArsasÄ±', price: 8000, location: 'KadÄ±kÃ¶y', district: 'KadÄ±kÃ¶y, Ä°stanbul', rooms: '-', area: '300mÂ²', age: '-', type: 'KiralÄ±k', category: 'Arsa', features: ['Asfalt'], image_url: 'https://images.unsplash.com/photo-1590674899484-d5640e854abe?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'Depolama AlanÄ±', price: 12000, location: 'Ãœmraniye', district: 'Ãœmraniye, Ä°stanbul', rooms: '-', area: '500mÂ²', age: '-', type: 'KiralÄ±k', category: 'Arsa', features: ['GÃ¼venlik'], image_url: 'https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'AÃ§Ä±k Hava Etkinlik AlanÄ±', price: 15000, location: 'Beykoz', district: 'Beykoz, Ä°stanbul', rooms: '-', area: '1500mÂ²', age: '-', type: 'KiralÄ±k', category: 'Arsa', features: ['Elektrik', 'Su'], image_url: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=800&q=80' },
                            // KIRALIK - Ä°ÅŸyeri (3)
                            { user_id: this.user.id, title: 'Merkezi LÃ¼ks Ofis', price: 15000, location: 'ÅžiÅŸli', district: 'ÅžiÅŸli, Ä°stanbul', rooms: '2+1', area: '95mÂ²', age: '8y', type: 'KiralÄ±k', category: 'Ä°ÅŸyeri', features: ['Otopark'], image_url: 'https://images.unsplash.com/photo-1497366811353-6870744d04b2?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'AVM DÃ¼kkanÄ±', price: 35000, location: 'NiÅŸantaÅŸÄ±', district: 'NiÅŸantaÅŸÄ±, Ä°stanbul', rooms: '-', area: '75mÂ²', age: '10y', type: 'KiralÄ±k', category: 'Ä°ÅŸyeri', features: ['Vitrin', 'Yaya TrafiÄŸi'], image_url: 'https://images.unsplash.com/photo-1604719312566-8912e9227c6a?auto=format&fit=crop&w=800&q=80' },
                            { user_id: this.user.id, title: 'Restoran AlanÄ±', price: 28000, location: 'KarakÃ¶y', district: 'KarakÃ¶y, Ä°stanbul', rooms: '-', area: '200mÂ²', age: '12y', type: 'KiralÄ±k', category: 'Ä°ÅŸyeri', features: ['Mutfak', 'Teras'], image_url: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=800&q=80' }
                        ];
                        const { data: portfolioData, error: portfolioError } = await supabase.from('portfolios').insert(mockPortfolios).select();
                        if (portfolioError) console.error('SeedData: Portfolio insert error:', portfolioError);

                        // 4. Insert Matches (using inserted demand and portfolio IDs)
                        if (demandData && demandData.length > 0 && portfolioData && portfolioData.length > 0) {
                            const mockMatches = [
                                { demand_id: demandData[0].id, portfolio_id: portfolioData[0].id, score: 98, status: 'pending', is_favorite: false },
                                { demand_id: demandData[0].id, portfolio_id: portfolioData[1].id, score: 95, status: 'pending', is_favorite: true },
                                { demand_id: demandData[1].id, portfolio_id: portfolioData[2].id, score: 92, status: 'pending', is_favorite: false }
                            ];
                            const { data: matchData, error: matchError } = await supabase.from('matches').insert(mockMatches).select();
                            if (matchError) console.error('SeedData: Match insert error:', matchError);
                        }

                        alert('Veriler baÅŸarÄ±yla eklendi! Sayfa yenileniyor...');
                        window.location.reload();
                    },

                    handleImageUpload(event) {
                        const file = event.target.files[0];
                        if (!file) return;

                        // Dosya boyutu kontrolÃ¼ (max 2MB)
                        if (file.size > 2 * 1024 * 1024) {
                            alert('Dosya boyutu 2MB\'dan kÃ¼Ã§Ã¼k olmalÄ±dÄ±r.');
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.newListingImages = [e.target.result];
                        };
                        reader.readAsDataURL(file);
                    },

                    async saveNewPortfolio() {
                        if (this.isSavingPortfolio) return; // Double-submit guard
                        this.isSavingPortfolio = true;
                        try {
                            // Validation
                            if (!this.newPortfolio.title || !this.newPortfolio.category || !this.newPortfolio.price) {
                                alert('LÃ¼tfen zorunlu alanlarÄ± doldurun (BaÅŸlÄ±k, Kategori, Fiyat)');
                                return;
                            }

                            if (!this.user) {
                                alert('LÃ¼tfen giriÅŸ yapÄ±n');
                                return;
                            }

                            // Prepare data for Supabase
                            const portfolioData = {
                                user_id: this.user.id,
                                title: this.newPortfolio.title,
                                price: parseInt(this.newPortfolio.price),
                                type: this.newPortfolio.type,
                                category: this.newPortfolio.category,
                                rooms: this.newPortfolio.rooms || '-',
                                city: this.newPortfolio.city || null,
                                // Format: "Semt, Ä°lÃ§e, Åžehir" or "Ä°lÃ§e, Åžehir" or "Åžehir"
                                district: [
                                    this.newPortfolio.district,
                                    this.newPortfolio.location,
                                    this.newPortfolio.city || 'Ä°stanbul'
                                ].filter(Boolean).join(', '),
                                area: this.newPortfolio.area || null,
                                age: this.newPortfolio.age || null
                            };

                            // Only update image if a new one was uploaded
                            if (this.newListingImages.length > 0) {
                                portfolioData.image_url = this.newListingImages[0];
                            } else if (!this.editingPortfolioId) {
                                // For new portfolios, use default image if none uploaded
                                portfolioData.image_url = 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?auto=format&fit=crop&w=800&q=80';
                            }
                            // If editing and no new image, don't include image_url (keeps existing)

                            // Check if editing or adding
                            let data, error;

                            if (this.editingPortfolioId) {
                                // EDIT MODE: Update existing portfolio
                                const result = await supabase
                                    .from('portfolios')
                                    .update(portfolioData)
                                    .eq('id', this.editingPortfolioId)
                                    .select();

                                data = result.data;
                                error = result.error;
                            } else {
                                // ADD MODE: Insert new portfolio via quota-checked RPC
                                const payload = {
                                    title: portfolioData.title,
                                    price: String(portfolioData.price),
                                    type: portfolioData.type || 'SatÄ±lÄ±k',
                                    category: portfolioData.category,
                                    rooms: portfolioData.rooms || '-',
                                    city: portfolioData.city || '',
                                    district: portfolioData.district || '',
                                    area: portfolioData.area || '',
                                    age: portfolioData.age || '',
                                    image_url: portfolioData.image_url || ''
                                };
                                const result = await supabase.rpc('add_portfolio_with_quota', { portfolio_data: payload });
                                data = result.data ? [result.data] : null;
                                error = result.error;

                                // Quota exceeded - close form and show upgrade modal
                                if (error && error.message && error.message.includes('QUOTA_EXCEEDED')) {
                                    this.limitModalType = 'portfolio';
                                    this.showLimitModal = true;
                                    this.showAddModal = false; // Close the portfolio form
                                    this.isSavingPortfolio = false;
                                    return;
                                }

                                // Refresh subscription after insert
                                if (!error) await this.loadSubscription();
                            }

                            if (error) {
                                console.error('Error saving portfolio:', error);
                                alert('KayÄ±t sÄ±rasÄ±nda hata oluÅŸtu: ' + error.message);
                                return;
                            }


                            // Refresh data
                            await this.fetchData();

                            // Success message
                            alert(this.editingPortfolioId ? 'PortfÃ¶y gÃ¼ncellendi!' : 'PortfÃ¶y eklendi!');

                            // Close modal and reset form
                            this.showAddModal = false;
                            this.editingPortfolioId = null;
                            this.newPortfolio = {
                                title: '',
                                type: 'SatÄ±lÄ±k',
                                category: '',
                                price: '',
                                city: 'Ä°stanbul',
                                location: '',
                                district: '',
                                rooms: '',
                                area: '',
                                age: ''
                            };
                            this.newListingImages = [];
                        } catch (e) {
                            console.error('Error:', e);
                            alert('Bir hata oluÅŸtu: ' + e.message);
                        } finally {
                            this.isSavingPortfolio = false; // Always re-enable button
                        }
                    },

                    async handleAuth() {
                        this.authLoading = true;
                        this.authError = '';

                        try {
                            if (this.authMode === 'login') {
                                const { error } = await supabase.auth.signInWithPassword({
                                    email: this.authEmail,
                                    password: this.authPassword
                                });
                                if (error) throw error;
                            } else {
                                const { data, error } = await supabase.auth.signUp({
                                    email: this.authEmail,
                                    password: this.authPassword,
                                    options: {
                                        data: {
                                            name: this.authName
                                        }
                                    }
                                });
                                if (error) throw error;

                                // Create profile record in profiles table
                                if (data.user) {
                                    const { error: profileError } = await supabase
                                        .from('profiles')
                                        .insert({
                                            id: data.user.id,
                                            name: this.authName,
                                            email: this.authEmail
                                        });

                                    if (profileError) {
                                        console.error('Profile creation error:', profileError);
                                        // User created successfully but profile failed
                                        // Continue anyway, profile can be updated later
                                    }
                                }

                                alert('KayÄ±t baÅŸarÄ±lÄ±! LÃ¼tfen giriÅŸ yapÄ±n.');
                                this.authMode = 'login';
                            }
                        } catch (e) {
                            this.authError = e.message;
                        } finally {
                            this.authLoading = false;
                        }
                    },

                    async signOut() {
                        await supabase.auth.signOut();
                        this.user = null;
                        this.demands = [];
                        this.portfolios = [];
                        this.matches = [];
                    },

                    // DATA ARRAYS
                    conversations: [], // Load from Supabase only
                    demands: [], // Load from Supabase only
                    networkDemands: [], // Load from Supabase only
                    portfolios: [], // Load from Supabase only
                    networkPortfolios: [], // Load from Supabase only
                    // matches: computed property (see line ~2893)
                    network: [], // Load from Supabase only
                    networkActivities: [], // Network activities (connections, messages, etc.)

                    // ACTIONS
                    formatPrice(price) {
                        if (!price) return '0 TL';
                        return new Intl.NumberFormat('tr-TR').format(price) + ' TL';
                    },
                    formatFullPrice(price) {
                        if (!price) return '0 TL';
                        return new Intl.NumberFormat('tr-TR').format(price) + ' TL';
                    },
                    formatTime(timestamp) {
                        if (!timestamp) return 'Åžimdi';

                        const date = new Date(timestamp);
                        const now = new Date();
                        const diffMs = now - date;
                        const diffMins = Math.floor(diffMs / 60000);
                        const diffHours = Math.floor(diffMs / 3600000);
                        const diffDays = Math.floor(diffMs / 86400000);

                        if (diffMins < 1) return 'Åžimdi';
                        if (diffMins < 60) return diffMins + ' dk Ã¶nce';
                        if (diffHours < 24) return diffHours + ' sa Ã¶nce';
                        if (diffDays === 1) return 'DÃ¼n';
                        if (diffDays < 7) return diffDays + ' gÃ¼n Ã¶nce';

                        return date.toLocaleDateString('tr-TR');
                    },
                    showError(message) {
                        this.errorMessage = message;
                        setTimeout(() => {
                            this.errorMessage = '';
                        }, 5000); // Auto-hide after 5 seconds
                    },
                    showSuccess(message) {
                        this.successMessage = message;
                        setTimeout(() => {
                            this.successMessage = '';
                        }, 5000); // Auto-hide after 5 seconds
                    },
                    async deletePortfolio(id) {
                        if (!confirm('Bu portfÃ¶yÃ¼ silmek istediÄŸinize emin misiniz? This action cannot be undone.')) {
                            return;
                        }

                        try {

                            // First, check if portfolio exists and belongs to user
                            const { data: checkData, error: checkError } = await supabase
                                .from('portfolios')
                                .select('*')
                                .eq('id', id);


                            if (checkError) {
                                console.error('Check error:', checkError);
                                throw new Error('PortfÃ¶y kontrol edilemedi: ' + checkError.message);
                            }

                            if (!checkData || checkData.length === 0) {
                                throw new Error('PortfÃ¶y bulunamadÄ±. ID: ' + id);
                            }

                            // Now attempt delete
                            const { data, error } = await supabase
                                .from('portfolios')
                                .delete()
                                .eq('id', id)
                                .select();


                            if (error) throw error;

                            if (!data || data.length === 0) {
                                throw new Error('PortfÃ¶y silinemedi. Supabase RLS politikasÄ± silmeye izin vermiyor olabilir.');
                            }

                            // Update local state immediately
                            this.portfolios = this.portfolios.filter(p => p.id !== id);
                            alert('PortfÃ¶y baÅŸarÄ±yla silindi.');
                        } catch (e) {
                            console.error('Delete error:', e);
                            alert('Silme iÅŸlemi baÅŸarÄ±sÄ±z: ' + e.message);
                        }
                    },
                    editPortfolio(id) {
                        // Find the portfolio
                        const portfolio = this.portfolios.find(p => p.id === id);

                        if (!portfolio) {
                            alert('PortfÃ¶y bulunamadÄ±');
                            return;
                        }

                        // Set edit mode
                        this.editingPortfolioId = id;

                        // Populate form with existing data
                        this.newPortfolio = {
                            title: portfolio.title || '',
                            type: portfolio.type || 'SatÄ±lÄ±k',
                            category: portfolio.category || '',
                            price: portfolio.price ? portfolio.price.toString() : '',
                            city: portfolio.city || 'Ä°stanbul',
                            location: portfolio.location || '',
                            district: portfolio.district || '',
                            rooms: portfolio.rooms || '',
                            area: portfolio.area || '',
                            age: portfolio.age || ''
                        };

                        // Open modal
                        this.showAddModal = true;
                    },

                    // ====== DEMAND MANAGEMENT FUNCTIONS ======
                    async saveDemand() {
                        if (this.isSavingDemand) return; // Double-submit guard
                        this.isSavingDemand = true;
                        try {
                            // Validation
                            if (!this.newDemand.title || !this.newDemand.category || !this.newDemand.budget) {
                                alert('LÃ¼tfen zorunlu alanlarÄ± doldurun (BaÅŸlÄ±k, Kategori, BÃ¼tÃ§e)');
                                return;
                            }

                            if (!this.user) {
                                alert('LÃ¼tfen giriÅŸ yapÄ±n');
                                return;
                            }

                            // Prepare data for Supabase
                            const demandData = {
                                user_id: this.user.id,
                                title: this.newDemand.title,
                                type: this.newDemand.type,
                                category: this.newDemand.category,
                                budget: parseInt(this.newDemand.budget),
                                max_budget: this.newDemand.maxBudget ? parseInt(this.newDemand.maxBudget) : null,
                                city: this.newDemand.city || null,
                                location: this.newDemand.location || null,
                                district: this.newDemand.district,
                                district2: this.newDemand.district2 || null,
                                district3: this.newDemand.district3 || null,
                                rooms: this.newDemand.rooms || '-',
                                is_urgent: this.newDemand.isUrgent || false,
                                status: 'active',
                                match_count: 0
                            };

                            // Check if editing or adding
                            let data, error;

                            if (this.editingDemandId) {
                                // EDIT MODE: Update existing demand
                                const result = await supabase
                                    .from('demands')
                                    .update(demandData)
                                    .eq('id', this.editingDemandId)
                                    .select();

                                data = result.data;
                                error = result.error;
                            } else {
                                // ADD MODE: Insert new demand via quota-checked RPC
                                const payload = {
                                    title: demandData.title,
                                    type: demandData.type,
                                    category: demandData.category,
                                    budget: String(demandData.budget),
                                    max_budget: demandData.max_budget ? String(demandData.max_budget) : '',
                                    city: demandData.city || '',
                                    location: demandData.location || '',
                                    district: demandData.district || '',
                                    district2: demandData.district2 || '',
                                    district3: demandData.district3 || '',
                                    rooms: demandData.rooms || '-',
                                    is_urgent: String(demandData.is_urgent || false)
                                };
                                const result = await supabase.rpc('add_demand_with_quota', { demand_data: payload });
                                data = result.data ? [result.data] : null;
                                error = result.error;

                                // Quota exceeded - close form and show upgrade modal
                                if (error && error.message && error.message.includes('QUOTA_EXCEEDED')) {
                                    this.limitModalType = 'demand';
                                    this.showLimitModal = true;
                                    this.showAddDemandModal = false; // Close the demand form
                                    this.isSavingDemand = false;
                                    return;
                                }

                                // Refresh subscription after insert
                                if (!error) await this.loadSubscription();
                            }

                            if (error) {
                                console.error('Error saving demand:', error);
                                alert('KayÄ±t sÄ±rasÄ±nda hata oluÅŸtu: ' + error.message);
                                return;
                            }


                            // Refresh data
                            await this.fetchData();

                            // Success message
                            alert(this.editingDemandId ? 'Talep gÃ¼ncellendi!' : 'Talep eklendi!');

                            // Close modal and reset form
                            this.showAddDemandModal = false;
                            this.editingDemandId = null;
                            this.newDemand = {
                                title: '',
                                type: 'SatÄ±lÄ±k',
                                category: '',
                                budget: '',
                                maxBudget: '',
                                district: '',
                                rooms: '',
                                isUrgent: false
                            };
                        } catch (e) {
                            console.error('Error:', e);
                            alert('Bir hata oluÅŸtu: ' + e.message);
                        } finally {
                            this.isSavingDemand = false; // Always re-enable button
                        }
                    },

                    editDemand(id) {
                        // Find the demand
                        const demand = this.demands.find(d => d.id === id);

                        if (!demand) {
                            alert('Talep bulunamadÄ±');
                            return;
                        }

                        // Set edit mode
                        this.editingDemandId = id;

                        // Populate form with existing data
                        this.newDemand = {
                            title: demand.title || '',
                            type: demand.type || 'SatÄ±lÄ±k',
                            category: demand.category || '',
                            budget: demand.budget ? demand.budget.toString() : '',
                            maxBudget: demand.maxBudget ? demand.maxBudget.toString() : '',
                            city: demand.city || 'Ä°STANBUL',
                            location: demand.location || '',
                            district: demand.district || '',
                            district2: demand.district2 || '',
                            district3: demand.district3 || '',
                            rooms: demand.rooms || '',
                            isUrgent: demand.isUrgent || false
                        };

                        // Open modal
                        this.showAddDemandModal = true;
                    },

                    async deleteDemand(id) {
                        if (!confirm('Bu talebi silmek istediÄŸinize emin misiniz?')) {
                            return;
                        }

                        try {

                            const { data, error } = await supabase
                                .from('demands')
                                .delete()
                                .eq('id', id)
                                .select();

                            if (error) {
                                console.error('Supabase delete error:', error);
                                throw error;
                            }

                            if (!data || data.length === 0) {
                                throw new Error('Talep silinemedi. RLS politikasÄ± silmeye izin vermiyor olabilir.');
                            }

                            // Update local state immediately
                            this.demands = this.demands.filter(d => d.id !== id);
                            this.showError('Talep baÅŸarÄ±yla silindi.'); // Using showError for consistency (will show as error toast)
                        } catch (e) {
                            console.error('Delete demand error:', e);
                            this.showError('Silme iÅŸlemi baÅŸarÄ±sÄ±z: ' + e.message);
                        }
                    },

                    async approveMatch(id) {

                        if (!id) {
                            console.error('âŒ Match ID is undefined!');
                            alert('Hata: EÅŸleÅŸme ID bulunamadÄ±. SayfayÄ± yenileyin.');
                            return;
                        }

                        // Check if already confirming this action
                        if (this.confirmingMatchId === id && this.confirmingAction === 'approve') {
                            // User clicked "Evet" - proceed with approval
                            try {

                                const { data, error } = await supabase
                                    .from('matches')
                                    .update({ status: 'approved' })
                                    .eq('id', id)
                                    .select();

                                if (error) {
                                    console.error('âŒ Supabase error:', error);
                                    throw error;
                                }

                                if (!data || data.length === 0) {
                                    console.error('âŒ No data returned from update');
                                    throw new Error('EÅŸleÅŸme gÃ¼ncellenemedi.');
                                }


                                // Update local state with REACTIVE reassignment (Alpine.js requirement)
                                // Mutating objects in arrays doesn't trigger reactivity, we need new references

                                // Update matches array
                                this.matches = this.matches.map(m =>
                                    m.id === id ? { ...m, status: 'approved' } : m
                                );

                                // Update demandMatches array
                                if (this.demandMatches && this.demandMatches.length > 0) {
                                    this.demandMatches = this.demandMatches.map(m =>
                                        m.id === id ? { ...m, status: 'approved' } : m
                                    );
                                }

                                // Update portfolioMatches array
                                if (this.portfolioMatches && this.portfolioMatches.length > 0) {
                                    this.portfolioMatches = this.portfolioMatches.map(m =>
                                        m.id === id ? { ...m, status: 'approved' } : m
                                    );
                                }


                                // Reset confirmation state
                                this.confirmingMatchId = null;
                                this.confirmingAction = null;

                                this.showSuccess('EÅŸleÅŸme baÅŸarÄ±yla onaylandÄ±!');
                            } catch (e) {
                                console.error('âŒ Approve error:', e);
                                alert('Onaylama baÅŸarÄ±sÄ±z: ' + e.message);
                                // Reset confirmation state on error
                                this.confirmingMatchId = null;
                                this.confirmingAction = null;
                            }
                        } else {
                            // First click - show confirmation
                            this.confirmingMatchId = id;
                            this.confirmingAction = 'approve';
                        }
                    },
                    async rejectMatch(id) {

                        if (!id) {
                            console.error('âŒ Match ID is undefined!');
                            alert('Hata: EÅŸleÅŸme ID bulunamadÄ±. SayfayÄ± yenileyin.');
                            return;
                        }

                        // Check if already confirming this action
                        if (this.confirmingMatchId === id && this.confirmingAction === 'reject') {
                            // User clicked "Evet" - proceed with rejection
                            try {

                                const { data, error } = await supabase
                                    .from('matches')
                                    .update({ status: 'rejected' })
                                    .eq('id', id)
                                    .select();

                                if (error) {
                                    console.error('âŒ Supabase error:', error);
                                    throw error;
                                }

                                if (!data || data.length === 0) {
                                    console.error('âŒ No data returned from update');
                                    throw new Error('EÅŸleÅŸme gÃ¼ncellenemedi.');
                                }


                                // Update local state with REACTIVE reassignment (Alpine.js requirement)

                                // Update matches array
                                this.matches = this.matches.map(m =>
                                    m.id === id ? { ...m, status: 'rejected' } : m
                                );

                                // Update demandMatches array
                                if (this.demandMatches && this.demandMatches.length > 0) {
                                    this.demandMatches = this.demandMatches.map(m =>
                                        m.id === id ? { ...m, status: 'rejected' } : m
                                    );
                                }

                                // Update portfolioMatches array
                                if (this.portfolioMatches && this.portfolioMatches.length > 0) {
                                    this.portfolioMatches = this.portfolioMatches.map(m =>
                                        m.id === id ? { ...m, status: 'rejected' } : m
                                    );
                                }


                                // Reset confirmation state
                                this.confirmingMatchId = null;
                                this.confirmingAction = null;

                                this.showSuccess('EÅŸleÅŸme reddedildi.');
                            } catch (e) {
                                console.error('âŒ Reject error:', e);
                                alert('Reddetme baÅŸarÄ±sÄ±z: ' + e.message);
                                // Reset confirmation state on error
                                this.confirmingMatchId = null;
                                this.confirmingAction = null;
                            }
                        } else {
                            // First click - show confirmation
                            this.confirmingMatchId = id;
                            this.confirmingAction = 'reject';
                        }
                    },

                    toggleFavorite(id) {
                        const match = this.matches.find(m => m.id === id);
                        if (match) {
                            match.isFavorite = !match.isFavorite;
                        }
                    },
                    async sendMessage(brokerName, brokerId = null) {

                        try {
                            // 1. Find existing conversation
                            let conversation = this.conversations.find(c => c.userName === brokerName);

                            // 2. If no conversation exists, create in Supabase
                            if (!conversation) {
                                let brokerProfile = null;

                                // Fetch broker profile from Supabase if we have ID
                                if (brokerId) {
                                    const { data: profileData, error: profileError } = await supabase
                                        .from('profiles')
                                        .select('id, name, avatar_url, company, title')
                                        .eq('id', brokerId)
                                        .single();

                                    if (!profileError && profileData) {
                                        brokerProfile = profileData;
                                    }
                                }

                                // Fallback: try to find in network
                                if (!brokerProfile) {
                                    const broker = this.network.find(b => b.name === brokerName);
                                    if (broker) {
                                        brokerProfile = {
                                            id: broker.id,
                                            name: broker.name,
                                            avatar_url: broker.avatar,
                                            company: broker.company,
                                            title: broker.role
                                        };
                                    }
                                }

                                const { data, error } = await supabase
                                    .from('conversations')
                                    .insert({
                                        user_id: this.user.id,
                                        participant_name: brokerName,
                                        receiver_id: brokerProfile?.id || null,
                                        last_message: 'Yeni konuÅŸma',
                                        last_message_time: new Date().toISOString()
                                    })
                                    .select()
                                    .single();

                                if (error) throw error;

                                const newConv = {
                                    id: data.id,
                                    userName: brokerName,
                                    lastMessage: 'Yeni konuÅŸma',
                                    time: 'Åžimdi',
                                    unread: 0,
                                    userImage: brokerProfile?.avatar_url || null,
                                    receiverId: data.receiver_id
                                };

                                this.conversations.unshift(newConv);
                                conversation = newConv;

                            } else {
                            }

                            // 3. Set as active conversation
                            this.activeConversation = conversation;

                            // 4. Load messages for this conversation
                            await this.loadMessages(conversation.id);

                            // 5. Switch to messages tab
                            this.currentTab = 'messages';


                        } catch (error) {
                            console.error('Error creating conversation:', error);
                            alert('KonuÅŸma baÅŸlatÄ±lamadÄ±: ' + error.message);
                        }
                    },

                    async sendNewMessage() {
                        // Validation
                        if (!this.newMessageText.trim()) {
                            return;
                        }

                        if (!this.activeConversation) {
                            alert('LÃ¼tfen bir konuÅŸma seÃ§in');
                            return;
                        }

                        const convId = this.activeConversation.id;
                        const messageContent = this.newMessageText.trim();

                        try {
                            let convId = this.activeConversation.id;

                            // If no conversation ID, create conversation first
                            if (!convId) {
                                const { data: convData, error: convError } = await supabase
                                    .from('conversations')
                                    .insert({
                                        user_id: this.user.id,
                                        receiver_id: this.activeConversation.other_user_id,
                                        participant_name: this.activeConversation.userName,
                                        // Don't cache avatar - will be fetched from profiles
                                        last_message: messageContent,
                                        last_message_time: new Date().toISOString()
                                    })
                                    .select()
                                    .single();

                                if (convError) throw convError;

                                convId = convData.id;
                                this.activeConversation.id = convId;
                            }

                            // 1. Insert message to Supabase
                            const { data: messageData, error: messageError } = await supabase
                                .from('messages')
                                .insert({
                                    conversation_id: convId,
                                    sender_id: this.user.id,
                                    receiver_id: this.activeConversation.other_user_id || this.activeConversation.receiverId || null,
                                    content: messageContent,
                                    read: true
                                })
                                .select()
                                .single();

                            if (messageError) throw messageError;

                            // 2. Update conversation last_message
                            const { error: convError } = await supabase
                                .from('conversations')
                                .update({
                                    last_message: messageContent,
                                    last_message_time: new Date().toISOString(),
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', convId);

                            if (convError) throw convError;

                            // 3. Update local state
                            if (!this.messages[convId]) {
                                this.messages[convId] = [];
                            }

                            const newMessage = {
                                id: messageData.id,
                                sender: 'sent',
                                content: messageContent,
                                time: new Date().toLocaleTimeString('tr-TR', {
                                    hour: '2-digit',
                                    minute: '2-digit'
                                }),
                                read: true
                            };

                            this.messages[convId].push(newMessage);

                            // 4. Update conversation in list
                            const conversation = this.conversations.find(c => c.id === convId);
                            // 3. Update local conversation list
                            const convIndex = this.conversations.findIndex(c => c.id === convId);
                            if (convIndex >= 0) {
                                this.conversations[convIndex].lastMessage = messageContent;
                                this.conversations[convIndex].time = 'Åžimdi';
                            } else {
                                // Add new conversation to list
                                this.conversations.unshift({
                                    id: convId,
                                    userName: this.activeConversation.userName,
                                    lastMessage: messageContent,
                                    time: 'Åžimdi',
                                    unread: 0,
                                    userImage: this.activeConversation.userImage,
                                    receiverId: this.activeConversation.other_user_id
                                });
                            }

                            // 4. Clear input
                            this.newMessageText = '';

                            this.$nextTick(() => {
                                const chatArea = document.querySelector('.overflow-y-auto.flex-1.p-4');
                                if (chatArea) {
                                    chatArea.scrollTop = chatArea.scrollHeight;
                                }
                            });


                        } catch (error) {
                            console.error('Error sending message:', error);
                            alert('Mesaj gÃ¶nderilemedi: ' + error.message);
                        }
                    },
                    // ============================================================
                    // ðŸ§  MATCHING ALGORITHM START
                    // ============================================================

                    isMatching: false,
                    matchingProgress: 0,

                    // Save state flags (must be declared here for Alpine reactivity)
                    isSavingDemand: false,
                    isSavingPortfolio: false,

                    // Subscription state
                    subscription: { tier: 'free', demands_used: 0, portfolios_used: 0, demands_limit: 2, portfolios_limit: 2 },
                    showLimitModal: false,
                    limitModalType: 'demand', // 'demand' or 'portfolio'

                    // Helper: String normalization for district comparison
                    normalizeDistrict(district) {
                        if (!district) return '';
                        return district.trim().toLowerCase()
                            .replace(/Ä±/g, 'i')
                            .replace(/ÅŸ/g, 's')
                            .replace(/ÄŸ/g, 'g')
                            .replace(/Ã¼/g, 'u')
                            .replace(/Ã¶/g, 'o')
                            .replace(/Ã§/g, 'c');
                    },

                    // Helper: Parse room count (e.g. "3+1" -> 3)
                    parseRooms(roomsStr) {
                        if (!roomsStr) return 0;
                        const match = roomsStr.match(/(\d+)/);
                        return match ? parseInt(match[1]) : 0;
                    },

                    // Helper: Calculate Budget Score (40 points)
                    calculateBudgetScore(demand, portfolio) {
                        const price = Number(portfolio.price);
                        const budget = Number(demand.budget); // Min Budget (Target)
                        const maxBudget = demand.max_budget || demand.maxBudget ? Number(demand.max_budget || demand.maxBudget) : (budget * 1.2);

                        // ðŸ”´ 1. Strict Upper Limit: Max + 15% (Negotiation margin)
                        if (price > maxBudget * 1.15) return { points: 0, reason: null, eliminated: true };

                        // ðŸ”´ 2. Strict Lower Limit: Min * 85% (Segment protection)
                        if (price < budget * 0.85) return { points: 0, reason: null, eliminated: true };

                        // âœ… 3. Perfect Match (Within Range)
                        if (price >= budget && price <= maxBudget) {
                            return { points: 40, reason: 'BÃ¼tÃ§e tam uyumlu', eliminated: false };
                        }

                        // Tier 2: Opportunity Zone (0.85*Min - Min) -> 35 Points
                        if (price >= budget * 0.85 && price < budget) {
                            return { points: 35, reason: 'BÃ¼tÃ§e altÄ±nda (FÄ±rsat)', eliminated: false };
                        }

                        // Tier 3: Negotiation Zone (Max - 1.15*Max) -> 25 Points
                        if (price > maxBudget && price <= maxBudget * 1.15) {
                            return { points: 25, reason: 'BÃ¼tÃ§e limitinde (PazarlÄ±k payÄ±)', eliminated: false };
                        }

                        return { points: 0, reason: null, eliminated: true };

                    },

                    // Helper: Calculate Location Score (30 points) - STRICT MODE
                    calculateLocationScore(demand, portfolio) {
                        // === STEP 1: CITY CHECK (ELIMINATOR) ===
                        // Get city from demand
                        const dCity = this.normalizeDistrict(demand.city || '');
                        // Get city from portfolio â€” try dedicated field first, then parse from district string
                        let pCity = this.normalizeDistrict(portfolio.city || '');
                        if (!pCity && portfolio.district) {
                            // Portfolio district format: "Semt, Ä°lÃ§e, Åžehir" â€” city is the last part
                            const parts = portfolio.district.split(',').map(p => p.trim());
                            if (parts.length >= 2) pCity = this.normalizeDistrict(parts[parts.length - 1]);
                        }

                        // If both have city info and they don't match â†’ ELIMINATE
                        if (dCity && pCity && dCity !== pCity) {
                            return { points: 0, reason: 'Åžehir uyuÅŸmuyor', eliminated: true };
                        }
                        // If either city is missing, don't eliminate but no city points

                        // === STEP 2: Ä°LÃ‡E CHECK (ELIMINATOR) ===
                        // Get ilÃ§e from demand (stored in location field during form, but may also be parseable)
                        const dIlce = this.normalizeDistrict(demand.location || '');
                        // Get ilÃ§e from portfolio â€” parse from district string
                        let pIlce = '';
                        if (portfolio.district) {
                            const parts = portfolio.district.split(',').map(p => p.trim());
                            if (parts.length >= 3) pIlce = this.normalizeDistrict(parts[1]); // "Semt, Ä°lÃ§e, Åžehir"
                            else if (parts.length === 2) pIlce = this.normalizeDistrict(parts[0]); // "Ä°lÃ§e, Åžehir"
                        }

                        // If both have ilÃ§e and they don't match â†’ ELIMINATE
                        if (dIlce && pIlce && dIlce !== pIlce) {
                            return { points: 0, reason: 'Ä°lÃ§e uyuÅŸmuyor', eliminated: true };
                        }

                        // === STEP 3: SEMT CHECK (BONUS POINTS) ===
                        // Get semt from portfolio
                        let pSemt = '';
                        if (portfolio.district) {
                            const parts = portfolio.district.split(',').map(p => p.trim());
                            if (parts.length >= 3) pSemt = this.normalizeDistrict(parts[0]); // "Semt, Ä°lÃ§e, Åžehir"
                        }

                        // Collect up to 3 semt preferences from demand
                        const semtPrefs = [
                            this.normalizeDistrict(demand.district),
                            this.normalizeDistrict(demand.district2),
                            this.normalizeDistrict(demand.district3)
                        ].filter(d => d);

                        // Base points for city+ilÃ§e match
                        let points = 15;

                        // Semt bonus
                        if (pSemt && semtPrefs.length > 0) {
                            const semtMatch = semtPrefs.some(s =>
                                s === pSemt || pSemt.includes(s) || s.includes(pSemt)
                            );
                            if (semtMatch) {
                                points = 30; // Full location score
                            }
                        } else if (semtPrefs.length === 0) {
                            // Demand didn't specify semt preference â†’ give partial points
                            points = 20;
                        }

                        return { points: points, reason: 'Konum eÅŸleÅŸmesi', eliminated: false };
                    },

                    // Helper: Calculate Room Score (15 points)
                    calculateRoomScore(demand, portfolio) {
                        if (!demand.rooms || !portfolio.rooms) return { points: 10, reason: 'Oda bilgisi varsayÄ±lan' };

                        const dRooms = this.parseRooms(demand.rooms);
                        const pRooms = this.parseRooms(portfolio.rooms);

                        if (dRooms === pRooms) return { points: 15, reason: 'Oda sayÄ±sÄ± tam uyumlu' };
                        if (Math.abs(dRooms - pRooms) === 1) return { points: 10, reason: 'Oda sayÄ±sÄ± yakÄ±n' };

                        return { points: 0, reason: null };
                    },

                    // Helper: Calculate Freshness Score (15 points)
                    calculateFreshnessScore(portfolio) {
                        if (!portfolio.created_at) return { points: 0, reason: null };

                        const created = new Date(portfolio.created_at);
                        const now = new Date();
                        const daysDiff = Math.floor((now - created) / (1000 * 60 * 60 * 24));

                        if (daysDiff <= 7) return { points: 15, reason: 'Yeni ilan' };
                        if (daysDiff <= 30) return { points: 5, reason: 'Son 1 ay' };

                        return { points: 0, reason: null };
                    },

                    // MAIN FUNCTION: Generate Matches (Sorted by Score then Urgency)
                    async generateMatches() {
                        if (this.isMatching) return;
                        this.isMatching = true;
                        this.matchingProgress = 0;

                        try {
                            // 1. Fetch Data
                            const { data: { session } } = await supabase.auth.getSession();
                            if (!session?.user) return;

                            // My Data
                            const myDemands = this.demands || [];
                            const myPortfolios = this.portfolios || [];

                            // ALL System Data (excluding own)
                            const { data: allPortfolios } = await supabase
                                .from('portfolios')
                                .select('*')
                                .neq('user_id', session.user.id);

                            const { data: allDemands } = await supabase
                                .from('demands')
                                .select('*')
                                .neq('user_id', session.user.id);

                            const potentialPortfolios = allPortfolios || [];
                            const potentialDemands = allDemands || [];


                            let newMatchesCount = 0;

                            // Helper to process match
                            const processMatch = async (demand, portfolio) => {
                                // ðŸ›‘ Eliminator Criteria
                                const dType = (demand.type || '').trim().toLowerCase();
                                const pType = (portfolio.type || '').trim().toLowerCase();
                                if (dType !== pType) return null;

                                const dCat = (demand.category || '').trim().toLowerCase();
                                const pCat = (portfolio.category || '').trim().toLowerCase();
                                if (dCat !== pCat) return null;

                                // ðŸ§® Score Calculation
                                let score = 0;

                                const budgetS = this.calculateBudgetScore(demand, portfolio);
                                if (budgetS.eliminated) return null;
                                score += budgetS.points;

                                const locS = this.calculateLocationScore(demand, portfolio);
                                if (locS.eliminated) return null;
                                score += locS.points;

                                const roomS = this.calculateRoomScore(demand, portfolio);
                                score += roomS.points;

                                const freshS = this.calculateFreshnessScore(portfolio);
                                score += freshS.points;

                                if (score >= 50) {
                                    return {
                                        demand_id: demand.id,
                                        portfolio_id: portfolio.id,
                                        score: score,
                                        status: 'pending',
                                        created_at: new Date().toISOString()
                                    };
                                }
                                return null;
                            };

                            // LOOP 1: My Demands vs Network Portfolios
                            for (const demand of myDemands) {
                                for (const portfolio of potentialPortfolios) {
                                    const match = await processMatch(demand, portfolio);
                                    if (match) {
                                        // Check if an approved/rejected match already exists (don't overwrite)
                                        const { data: existing } = await supabase
                                            .from('matches')
                                            .select('id, status')
                                            .eq('demand_id', match.demand_id)
                                            .eq('portfolio_id', match.portfolio_id)
                                            .maybeSingle();

                                        if (existing && (existing.status === 'approved' || existing.status === 'rejected')) {
                                            continue;
                                        }

                                        if (!existing) {
                                            // upsert: DB UNIQUE constraint prevents any duplicate
                                            const { error } = await supabase
                                                .from('matches')
                                                .upsert(match, { onConflict: 'demand_id,portfolio_id', ignoreDuplicates: true });
                                            if (!error) newMatchesCount++;
                                        }
                                    }
                                }
                            }

                            // LOOP 2: My Portfolios vs Network Demands
                            for (const portfolio of myPortfolios) {
                                for (const demand of potentialDemands) {
                                    const match = await processMatch(demand, portfolio);
                                    if (match) {
                                        // Check if an approved/rejected match already exists (don't overwrite)
                                        const { data: existing } = await supabase
                                            .from('matches')
                                            .select('id, status')
                                            .eq('demand_id', match.demand_id)
                                            .eq('portfolio_id', match.portfolio_id)
                                            .maybeSingle();

                                        if (existing && (existing.status === 'approved' || existing.status === 'rejected')) {
                                            continue;
                                        }

                                        if (!existing) {
                                            // upsert: DB UNIQUE constraint prevents any duplicate
                                            const { error } = await supabase
                                                .from('matches')
                                                .upsert(match, { onConflict: 'demand_id,portfolio_id', ignoreDuplicates: true });
                                            if (!error) newMatchesCount++;
                                        }
                                    }
                                }
                            }

                            // Reload Data
                            await this.fetchData();

                            if (newMatchesCount > 0) {
                                // alert(`${ newMatchesCount } yeni eÅŸleÅŸme bulundu!`);
                            } else {
                            }

                        } catch (error) {
                            console.error('Match Algo Error:', error);
                            this.showError('EÅŸleÅŸtirme hatasÄ±: ' + error.message);
                        } finally {
                            this.isMatching = false;
                            this.matchingProgress = 0;
                        }
                    },

                    // CLEANUP FUNCTION: Remove Duplicate Matches
                    async cleanupDuplicateMatches() {
                        if (this.isMatching) {
                            alert('EÅŸleÅŸtirme devam ediyor, lÃ¼tfen bekleyin.');
                            return;
                        }

                        if (!confirm('MÃ¼kerrer eÅŸleÅŸmeleri temizlemek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz.')) {
                            return;
                        }

                        this.isMatching = true;

                        try {
                            // 1. Get ALL matches for this user's demands
                            const { data: userDemands } = await supabase
                                .from('demands')
                                .select('id')
                                .eq('user_id', this.user.id);

                            if (!userDemands || userDemands.length === 0) {
                                alert('Temizlenecek talep bulunamadÄ±.');
                                this.isMatching = false;
                                return;
                            }

                            const demandIds = userDemands.map(d => d.id);

                            const { data: allMatches } = await supabase
                                .from('matches')
                                .select('*')
                                .in('demand_id', demandIds)
                                .order('created_at', { ascending: false }); // Most recent first

                            if (!allMatches || allMatches.length === 0) {
                                alert('Temizlenecek eÅŸleÅŸme bulunamadÄ±.');
                                this.isMatching = false;
                                return;
                            }

                            // 2. Group by demand_id + portfolio_id to find duplicates
                            const seen = new Map();
                            const duplicatesToDelete = [];

                            for (const match of allMatches) {
                                const key = `${match.demand_id}_${match.portfolio_id}`;

                                if (seen.has(key)) {
                                    // This is a duplicate, mark for deletion
                                    duplicatesToDelete.push(match.id);
                                } else {
                                    // First occurrence, keep it
                                    seen.set(key, match.id);
                                }
                            }

                            // 3. Delete duplicates
                            if (duplicatesToDelete.length > 0) {
                                const { error } = await supabase
                                    .from('matches')
                                    .delete()
                                    .in('id', duplicatesToDelete);

                                if (error) throw error;

                                await this.fetchData();
                                alert(`âœ… ${duplicatesToDelete.length} mÃ¼kerrer eÅŸleÅŸme temizlendi!`);
                            } else {
                                alert('MÃ¼kerrer eÅŸleÅŸme bulunamadÄ±.');
                            }

                        } catch (error) {
                            console.error('Cleanup Error:', error);
                            this.showError('Temizleme hatasÄ±: ' + error.message);
                        } finally {
                            this.isMatching = false;
                        }
                    },
                    // ============================================================
                    // ðŸ§  MATCHING ALGORITHM END
                    // ============================================================

                    viewAll(section) {
                        alert(section + ' tÃ¼mÃ¼ gÃ¶rÃ¼ntÃ¼leniyor...');
                    },
                }
            }

            // Unregister Service Worker to fix caching issues
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function (registrations) {
                    for (let registration of registrations) {
                        registration.unregister();
                    }
                });
            }

            // NOW load Alpine.js AFTER app() is defined
            const alpineScript = document.createElement('script');
            alpineScript.src = 'https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js';
            alpineScript.defer = true;
            document.head.appendChild(alpineScript);
        }); // Close DOMContentLoaded event listener
    </script>
    <!-- ADD PORTFOLIO MODAL (Popup) -->
    <div x-show="showAddModal" x-cloak class="fixed inset-0 z-[9999] overflow-y-auto"
        x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">

        <!-- Dark Overlay -->
        <div class="fixed inset-0 bg-black/50 transition-opacity"
            @click="showAddModal = false; editingPortfolioId = null"></div>

        <!-- Modal Container -->
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-lg transform transition-all" @click.stop>

                <!-- Modal Header -->
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-900"
                        x-text="editingPortfolioId ? 'PortfÃ¶y DÃ¼zenle' : 'Yeni PortfÃ¶y Ekle'"></h2>
                    <button @click="showAddModal = false; editingPortfolioId = null"
                        class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Modal Body (Form) -->
                <div class="px-6 py-4 max-h-[70vh] overflow-y-auto">
                    <!-- Form Fields -->
                    <div class="space-y-4">
                        <!-- FotoÄŸraf YÃ¼kleme -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">PortfÃ¶y FotoÄŸrafÄ±</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-blue-500 transition-colors cursor-pointer relative"
                                @click="$refs.fileInput.click()">
                                <div class="space-y-1 text-center">
                                    <template x-if="!newListingImages.length">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none"
                                            viewBox="0 0 48 48" aria-hidden="true">
                                            <path
                                                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                    </template>
                                    <template x-if="newListingImages.length">
                                        <img :src="newListingImages[0]" class="mx-auto h-32 object-cover rounded-lg">
                                    </template>
                                    <div class="flex text-sm text-gray-600 justify-center">
                                        <label
                                            class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                            <span>FotoÄŸraf YÃ¼kle</span>
                                            <input x-ref="fileInput" type="file" class="sr-only" accept="image/*"
                                                @change="handleImageUpload">
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-500">PNG, JPG, GIF (max 2MB)</p>
                                </div>
                            </div>
                        </div>

                        <!-- BaÅŸlÄ±k -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">BaÅŸlÄ±k</label>
                            <input type="text" x-model="newPortfolio.title"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Ã–rn: Deniz ManzaralÄ± 3+1">
                        </div>

                        <!-- Tip & Kategori -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Tip</label>
                                <select x-model="newPortfolio.type"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="SatÄ±lÄ±k">SatÄ±lÄ±k</option>
                                    <option value="KiralÄ±k">KiralÄ±k</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Kategori</label>
                                <select x-model="newPortfolio.category"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">SeÃ§iniz</option>
                                    <option value="Villa">Villa</option>
                                    <option value="Daire">Daire</option>
                                    <option value="Arsa">Arsa</option>
                                    <option value="Ä°ÅŸyeri">Ä°ÅŸyeri</option>
                                </select>
                            </div>
                        </div>

                        <!-- Fiyat -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Fiyat (TL)</label>
                            <input type="number" x-model="newPortfolio.price"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Fiyat giriniz">
                        </div>

                        <!-- Åžehir, Ä°lÃ§e, Semt -->
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Åžehir</label>
                                <select x-model="newPortfolio.city"
                                    @change="newPortfolio.location = ''; newPortfolio.district = '';"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">SeÃ§iniz</option>
                                    <template x-for="city in cities" :key="city">
                                        <option :value="city" x-text="city"></option>
                                    </template>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Ä°lÃ§e</label>
                                <select x-model="newPortfolio.location" @change="newPortfolio.district = '';"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    :disabled="!newPortfolio.city">
                                    <option value="">SeÃ§iniz</option>
                                    <template x-for="district in portfolioDistricts" :key="district">
                                        <option :value="district" x-text="district"></option>
                                    </template>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Semt/Mahalle</label>
                                <select x-model="newPortfolio.district"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    :disabled="!newPortfolio.location">
                                    <option value="">SeÃ§iniz</option>
                                    <template x-for="hood in getNeighborhoods(newPortfolio.city, newPortfolio.location)"
                                        :key="hood">
                                        <option :value="hood" x-text="hood"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <!-- Oda, mÂ², YaÅŸ -->
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Oda</label>
                                <input type="text" x-model="newPortfolio.rooms"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="3+1">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">mÂ²</label>
                                <input type="text" x-model="newPortfolio.area"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="120">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">YaÅŸ</label>
                                <input type="text" x-model="newPortfolio.age"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="5">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="flex gap-3 px-6 py-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl">
                    <button @click="showAddModal = false; editingPortfolioId = null"
                        class="flex-1 px-6 py-2.5 border-2 border-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition-colors">
                        Ä°ptal
                    </button>
                    <button @click="saveNewPortfolio()" :disabled="isSavingPortfolio"
                        class="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                        <span x-text="isSavingPortfolio ? 'Kaydediliyor...' : 'Kaydet'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD/EDIT DEMAND MODAL -->
    <div x-show="showAddDemandModal" x-cloak class="fixed inset-0 z-[9999] overflow-y-auto"
        x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">

        <!-- Dark Overlay -->
        <div class="fixed inset-0 bg-black/50 transition-opacity"
            @click="showAddDemandModal = false; editingDemandId = null"></div>

        <!-- Modal Container -->
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-lg transform transition-all" @click.stop>

                <!-- Modal Header -->
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-900"
                        x-text="editingDemandId ? 'Talep DÃ¼zenle' : 'Yeni Talep Ekle'"></h2>
                    <button @click="showAddDemandModal = false; editingDemandId = null"
                        class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Modal Body (Form) -->
                <div class="px-6 py-4 max-h-[70vh] overflow-y-auto">
                    <div class="space-y-4">
                        <!-- Title -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">BaÅŸlÄ±k <span
                                    class="text-red-500">*</span></label>
                            <input type="text" x-model="newDemand.title"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                placeholder="Ã–rn: Bebek Sahil LÃ¼ks Daire">
                        </div>

                        <!-- Type & Category -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Tip <span
                                        class="text-red-500">*</span></label>
                                <select x-model="newDemand.type"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                    <option value="SatÄ±lÄ±k">SatÄ±lÄ±k</option>
                                    <option value="KiralÄ±k">KiralÄ±k</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Kategori <span
                                        class="text-red-500">*</span></label>
                                <select x-model="newDemand.category"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                    <option value="">SeÃ§iniz</option>
                                    <option value="Daire">Daire</option>
                                    <option value="Villa">Villa</option>
                                    <option value="Arsa">Arsa</option>
                                    <option value="Ä°ÅŸyeri">Ä°ÅŸyeri</option>
                                </select>
                            </div>
                        </div>

                        <!-- Budget Range -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Min BÃ¼tÃ§e (TL) <span
                                        class="text-red-500">*</span></label>
                                <input type="number" x-model="newDemand.budget"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                    placeholder="45000000">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Max BÃ¼tÃ§e (TL)</label>
                                <input type="number" x-model="newDemand.maxBudget"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                    placeholder="55000000">
                            </div>
                        </div>


                        <!-- Location Preferences: City > District > 3x Neighborhood -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Åžehir</label>
                                <select x-model="newDemand.city"
                                    @change="newDemand.location = ''; newDemand.district = ''; newDemand.district2 = ''; newDemand.district3 = '';"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                                    <option value="">SeÃ§iniz</option>
                                    <template x-for="city in cities" :key="city">
                                        <option :value="city" x-text="city"></option>
                                    </template>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Ä°lÃ§e</label>
                                <select x-model="newDemand.location"
                                    @change="newDemand.district = ''; newDemand.district2 = ''; newDemand.district3 = '';"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                    :disabled="!newDemand.city">
                                    <option value="">SeÃ§iniz</option>
                                    <template x-for="district in getDistricts(newDemand.city)" :key="district">
                                        <option :value="district" x-text="district"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Semt/Mahalle Tercihleri
                                (En
                                fazla 3)</label>
                            <div class="space-y-2">
                                <select x-model="newDemand.district"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                    :disabled="!newDemand.location">
                                    <option value="">1. Tercih SeÃ§iniz</option>
                                    <template x-for="hood in getNeighborhoods(newDemand.city, newDemand.location)"
                                        :key="hood">
                                        <option :value="hood" x-text="hood"></option>
                                    </template>
                                </select>
                                <select x-model="newDemand.district2"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                    :disabled="!newDemand.location">
                                    <option value="">2. Tercih (Opsiyonel)</option>
                                    <template x-for="hood in getNeighborhoods(newDemand.city, newDemand.location)"
                                        :key="hood">
                                        <option :value="hood" x-text="hood"></option>
                                    </template>
                                </select>
                                <select x-model="newDemand.district3"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                    :disabled="!newDemand.location">
                                    <option value="">3. Tercih (Opsiyonel)</option>
                                    <template x-for="hood in getNeighborhoods(newDemand.city, newDemand.location)"
                                        :key="hood">
                                        <option :value="hood" x-text="hood"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <!-- Rooms -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Oda</label>
                                    <input type="text" x-model="newDemand.rooms"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                        placeholder="3+1">
                                </div>
                            </div>

                            <!-- Urgent Toggle -->
                            <div class="flex items-center gap-2">
                                <input type="checkbox" x-model="newDemand.isUrgent" id="urgentToggle"
                                    class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="urgentToggle" class="text-sm font-semibold text-gray-700">Acil
                                    Talep</label>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="flex gap-3 px-6 py-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl">
                        <button @click="showAddDemandModal = false; editingDemandId = null"
                            class="flex-1 px-6 py-2.5 border-2 border-gray-200 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition-colors">
                            Ä°ptal
                        </button>
                        <button @click="saveDemand()" :disabled="isSavingDemand"
                            class="flex-1 px-6 py-2.5 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <span
                                x-text="isSavingDemand ? 'Kaydediliyor...' : (editingDemandId ? 'GÃ¼ncelle' : 'Kaydet')"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ===== QUOTA LIMIT EXCEEDED MODAL ===== -->
        <div x-show="showLimitModal" x-cloak
            class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
            @click.self="showLimitModal = false">
            <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm mx-4 text-center">
                <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                    ðŸ”’</div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">AylÄ±k Limitinize UlaÅŸtÄ±nÄ±z</h3>
                <p class="text-gray-500 text-sm mb-1">
                    <template x-if="limitModalType === 'demand'">
                        <span>Bu ay ekleyebileceÄŸiniz talep sayÄ±sÄ± (<span x-text="subscription.demands_limit"></span>)
                            doldu.</span>
                    </template>
                    <template x-if="limitModalType === 'portfolio'">
                        <span>Bu ay ekleyebileceÄŸiniz portfÃ¶y sayÄ±sÄ± (<span
                                x-text="subscription.portfolios_limit"></span>) doldu.</span>
                    </template>
                </p>
                <p class="text-gray-400 text-xs mb-6">Paketinizi yÃ¼kselterek daha fazla ilan ekleyebilirsiniz.</p>
                <div class="space-y-3 mb-6 text-left">
                    <div class="flex items-center justify-between bg-blue-50 rounded-xl p-3">
                        <div>
                            <div class="font-bold text-blue-700 text-sm">Pro</div>
                            <div class="text-xs text-blue-500">Ayda 10 talep + 10 portfÃ¶y</div>
                        </div>
                        <a href="mailto:destek@brokerlink.com?subject=Pro Paket"
                            class="bg-blue-600 text-white text-xs font-bold px-3 py-1.5 rounded-lg hover:bg-blue-700 transition-colors">
                            GeÃ§ â†’
                        </a>
                    </div>
                    <div class="flex items-center justify-between bg-amber-50 rounded-xl p-3">
                        <div>
                            <div class="font-bold text-amber-700 text-sm">Enterprise</div>
                            <div class="text-xs text-amber-500">Ayda 50 talep + 50 portfÃ¶y</div>
                        </div>
                        <a href="mailto:destek@brokerlink.com?subject=Enterprise Paket"
                            class="bg-amber-500 text-white text-xs font-bold px-3 py-1.5 rounded-lg hover:bg-amber-600 transition-colors">
                            Ä°letiÅŸim â†’
                        </a>
                    </div>
                </div>
                <button
                    @click="showLimitModal = false; (limitModalType === 'portfolio' ? showAddModal = false : showAddDemandModal = false)"
                    class="w-full py-2.5 border-2 border-gray-200 rounded-xl text-gray-600 font-semibold hover:bg-gray-50 transition-colors text-sm">
                    Kapat
                </button>
            </div>
        </div>
</body>

</html>