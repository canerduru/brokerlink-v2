<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evliyo Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            padding: 20px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            color: white;
        }

        .header p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 2px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .refresh-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .last-updated {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* LOGIN */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .login-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 40px;
            width: 360px;
            text-align: center;
        }

        .login-card .logo-big {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 20px;
        }

        .login-card h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .login-card p {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 28px;
        }

        .login-card input {
            width: 100%;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 12px 16px;
            color: #e2e8f0;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            margin-bottom: 12px;
            outline: none;
            transition: border-color 0.2s;
        }

        .login-card input:focus {
            border-color: #3b82f6;
        }

        .login-card button {
            width: 100%;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 13px;
            font-size: 15px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            margin-top: 4px;
            transition: opacity 0.2s;
        }

        .login-card button:hover {
            opacity: 0.9;
        }

        .login-error {
            color: #f87171;
            font-size: 13px;
            margin-top: 10px;
        }

        /* MAIN */
        .main {
            padding: 32px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* STAT CARDS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: #475569;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: 16px 16px 0 0;
        }

        .stat-card.blue::before {
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
        }

        .stat-card.green::before {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .stat-card.purple::before {
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
        }

        .stat-card.orange::before {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .stat-card.pink::before {
            background: linear-gradient(90deg, #ec4899, #f472b6);
        }

        .stat-card.cyan::before {
            background: linear-gradient(90deg, #06b6d4, #22d3ee);
        }

        .stat-icon {
            font-size: 28px;
            margin-bottom: 12px;
        }

        .stat-label {
            font-size: 12px;
            font-weight: 500;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 40px;
            font-weight: 800;
            color: white;
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-sub {
            font-size: 12px;
            color: #64748b;
        }

        /* LOADING SKELETON */
        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
            height: 40px;
            width: 80px;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* TABLES */
        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
        }

        .table-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            overflow: hidden;
        }

        .table-header {
            padding: 18px 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table-header h3 {
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-header .count {
            background: #334155;
            color: #94a3b8;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 20px;
        }

        .table-body {
            padding: 8px 0;
        }

        .table-row {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #1e293b;
            transition: background 0.15s;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .table-row:hover {
            background: #263548;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .row-info {
            flex: 1;
            min-width: 0;
        }

        .row-name {
            font-size: 13px;
            font-weight: 600;
            color: #e2e8f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .row-sub {
            font-size: 11px;
            color: #64748b;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .row-badge {
            font-size: 11px;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .badge-blue {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .badge-green {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }

        .badge-purple {
            background: rgba(139, 92, 246, 0.15);
            color: #a78bfa;
        }

        .badge-orange {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }

        .empty-state {
            padding: 32px;
            text-align: center;
            color: #475569;
            font-size: 13px;
        }

        /* AUTO REFRESH INDICATOR */
        .refresh-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #64748b;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        /* RESPONSIVE */
        @media (max-width: 640px) {
            .main {
                padding: 16px;
            }

            .header {
                padding: 16px;
            }

            .tables-grid {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 32px;
            }
        }
    </style>
</head>

<body>

    <!-- LOGIN OVERLAY -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-card">
            <img src="evliyo_logo.png" alt="Evliyo Logo"
                style="height: 60px; object-fit: contain; margin-bottom: 10px;">
            <h2>Admin Paneli</h2>
            <p>Y√∂netim paneline giri≈ü yapƒ±n</p>
            <input type="email" id="loginEmail" placeholder="E-posta" autocomplete="email">
            <input type="password" id="loginPassword" placeholder="≈ûifre" autocomplete="current-password">
            <button onclick="doLogin()">Giri≈ü Yap</button>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <img src="evliyo_logo.png" alt="Evliyo Logo" style="height: 40px; object-fit: contain;">
            <div style="margin-left: 10px;">
                <h1>Admin Paneli</h1>
                <p>Platform Y√∂netim Paneli</p>
            </div>
        </div>
        <div class="header-right">
            <div class="refresh-indicator">
                <div class="dot"></div>
                <span id="lastUpdated">Y√ºkleniyor...</span>
            </div>
            <button class="refresh-btn" onclick="loadAll()">
                ‚Üª Yenile
            </button>
            <button class="refresh-btn" onclick="doLogout()"
                style="background:rgba(239,68,68,0.2); border-color:rgba(239,68,68,0.3);">
                √áƒ±kƒ±≈ü
            </button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">

        <!-- STAT CARDS -->
        <div class="stats-grid">
            <div class="stat-card blue">
                <div class="stat-icon">üë•</div>
                <div class="stat-label">Toplam Broker</div>
                <div class="stat-value" id="statBrokers">
                    <div class="skeleton"></div>
                </div>
                <div class="stat-sub">Kayƒ±tlƒ± kullanƒ±cƒ±</div>
            </div>
            <div class="stat-card green">
                <div class="stat-icon">üè¢</div>
                <div class="stat-label">Toplam Portf√∂y</div>
                <div class="stat-value" id="statPortfolios">
                    <div class="skeleton"></div>
                </div>
                <div class="stat-sub">Aktif portf√∂y</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-icon">üìã</div>
                <div class="stat-label">Toplam Talep</div>
                <div class="stat-value" id="statDemands">
                    <div class="skeleton"></div>
                </div>
                <div class="stat-sub">Aktif talep</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-icon">ü§ù</div>
                <div class="stat-label">Baƒülantƒ±lar</div>
                <div class="stat-value" id="statConnections">
                    <div class="skeleton"></div>
                </div>
                <div class="stat-sub">Kabul edilmi≈ü</div>
            </div>
            <div class="stat-card pink">
                <div class="stat-icon">üîó</div>
                <div class="stat-label">E≈üle≈ümeler</div>
                <div class="stat-value" id="statMatches">
                    <div class="skeleton"></div>
                </div>
                <div class="stat-sub">Toplam e≈üle≈üme</div>
            </div>
            <div class="stat-card cyan">
                <div class="stat-icon">üí¨</div>
                <div class="stat-label">Mesajlar</div>
                <div class="stat-value" id="statMessages">
                    <div class="skeleton"></div>
                </div>
                <div class="stat-sub">Toplam mesaj</div>
            </div>
        </div>

        <!-- TABLES -->
        <div class="tables-grid">

            <!-- Tier √ñzeti -->
            <div class="table-card" style="margin-bottom:0;padding:16px 20px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                    <span style="font-size:14px;font-weight:700;color:#94a3b8;">üìä Paket Daƒüƒ±lƒ±mƒ±</span>
                </div>
                <div style="display:flex;gap:12px;flex-wrap:wrap;">
                    <div
                        style="flex:1;min-width:80px;background:rgba(148,163,184,0.12);border:1px solid rgba(148,163,184,0.2);border-radius:10px;padding:10px 14px;text-align:center;">
                        <div style="font-size:22px;font-weight:800;color:#e2e8f0;" id="tierFreeCount">‚Äî</div>
                        <div style="font-size:11px;color:#64748b;margin-top:2px;">√úcretsiz</div>
                    </div>
                    <div
                        style="flex:1;min-width:80px;background:rgba(37,99,235,0.12);border:1px solid rgba(37,99,235,0.25);border-radius:10px;padding:10px 14px;text-align:center;">
                        <div style="font-size:22px;font-weight:800;color:#60a5fa;" id="tierProCount">‚Äî</div>
                        <div style="font-size:11px;color:#64748b;margin-top:2px;">Pro</div>
                    </div>
                    <div
                        style="flex:1;min-width:80px;background:rgba(245,158,11,0.12);border:1px solid rgba(245,158,11,0.25);border-radius:10px;padding:10px 14px;text-align:center;">
                        <div style="font-size:22px;font-weight:800;color:#fbbf24;" id="tierEnterpriseCount">‚Äî</div>
                        <div style="font-size:11px;color:#64748b;margin-top:2px;">Enterprise</div>
                    </div>
                </div>
            </div>

            <!-- B√∂lge Daƒüƒ±lƒ±mƒ± (3 kart) -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">

                <!-- Broker B√∂lge Daƒüƒ±lƒ±mƒ± -->
                <div class="table-card" style="margin-bottom:0;padding:16px 20px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                        <span style="font-size:14px;font-weight:700;color:#94a3b8;">üìç Aktif Broker B√∂lgeleri</span>
                    </div>
                    <div id="brokerDistList" style="font-size:12px;color:#94a3b8;">Y√ºkleniyor...</div>
                </div>

                <!-- Portf√∂y ≈ûehir Daƒüƒ±lƒ±mƒ± -->
                <div class="table-card" style="margin-bottom:0;padding:16px 20px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                        <span style="font-size:14px;font-weight:700;color:#94a3b8;">üè¢ Portf√∂y ≈ûehirleri</span>
                    </div>
                    <div id="portfolioDistList" style="font-size:12px;color:#94a3b8;">Y√ºkleniyor...</div>
                </div>

                <!-- Talep ≈ûehir Daƒüƒ±lƒ±mƒ± -->
                <div class="table-card" style="margin-bottom:0;padding:16px 20px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                        <span style="font-size:14px;font-weight:700;color:#94a3b8;">üìã Talep ≈ûehirleri</span>
                    </div>
                    <div id="demandDistList" style="font-size:12px;color:#94a3b8;">Y√ºkleniyor...</div>
                </div>

            </div>

            <div class="table-card">
                <div class="table-header">
                    <h3>üë• T√ºm Brokerlar</h3>
                    <span class="count" id="brokersCount">‚Äî</span>
                </div>
                <div class="table-body" id="brokersList">
                    <div class="empty-state">Y√ºkleniyor...</div>
                </div>
                <div id="brokersLoadMore" style="padding:10px 0 0;text-align:center;display:none;">
                    <button onclick="loadMoreBrokers()"
                        style="font-size:12px;background:rgba(99,102,241,0.15);border:1px solid rgba(99,102,241,0.3);color:#818cf8;padding:6px 18px;border-radius:8px;cursor:pointer;">‚¨á
                        Daha Fazla G√∂ster</button>
                </div>
            </div>

            <!-- Son Portf√∂yler -->
            <div class="table-card">
                <div class="table-header">
                    <h3>üè¢ Son Eklenen Portf√∂yler</h3>
                    <span class="count" id="portfoliosCount">‚Äî</span>
                </div>
                <div class="table-body" id="portfoliosList">
                    <div class="empty-state">Y√ºkleniyor...</div>
                </div>
            </div>

            <!-- Son Talepler -->
            <div class="table-card">
                <div class="table-header">
                    <h3>üìã Son Eklenen Talepler</h3>
                    <span class="count" id="demandsCount">‚Äî</span>
                </div>
                <div class="table-body" id="demandsList">
                    <div class="empty-state">Y√ºkleniyor...</div>
                </div>
            </div>

            <!-- Son E≈üle≈ümeler -->
            <div class="table-card">
                <div class="table-header">
                    <h3>üîó Son E≈üle≈ümeler</h3>
                    <span class="count" id="matchesCount">‚Äî</span>
                </div>
                <div class="table-body" id="matchesList">
                    <div class="empty-state">Y√ºkleniyor...</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://redwdkfeypnpuyndvysl.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_-nD1cds8uhQ80CjphgIG1A__NrAP7v1';
        var supabase; // global scope
        let isLoggedIn = false;
        let autoRefreshTimer = null;

        // Security Helper
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        window.addEventListener('load', function () {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            checkAuth();
        });

        // ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                // Admin kontrol√º
                const { data: isAdmin } = await supabase.rpc('is_admin');
                if (isAdmin) {
                    showDashboard();
                } else {
                    await supabase.auth.signOut();
                    document.getElementById('loginError').textContent = 'Bu panele eri≈üim yetkiniz yok. Sadece adminler girebilir.';
                }
            }
        }

        function showDashboard() {
            isLoggedIn = true;
            document.getElementById('loginOverlay').style.display = 'none';
            loadAll();
            startAutoRefresh();
        }

        async function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errEl = document.getElementById('loginError');
            errEl.textContent = '';

            if (!email || !password) {
                errEl.textContent = 'E-posta ve ≈üifre gerekli.';
                return;
            }

            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                errEl.textContent = 'Giri≈ü ba≈üarƒ±sƒ±z: ' + error.message;
            } else {
                // Admin rol√º kontrol√º
                const { data: isAdmin } = await supabase.rpc('is_admin');
                if (isAdmin) {
                    showDashboard();
                } else {
                    await supabase.auth.signOut();
                    errEl.textContent = 'Bu panele eri≈üim yetkiniz yok. Sadece adminler girebilir.';
                }
            }
        }

        async function doLogout() {
            await supabase.auth.signOut();
            clearInterval(autoRefreshTimer);
            isLoggedIn = false;
            document.getElementById('loginOverlay').style.display = 'flex';
        }

        // Enter key for login
        document.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !isLoggedIn) {
                doLogin();
            }
        });

        // ‚îÄ‚îÄ‚îÄ DATA LOADING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function loadAll() {
            await Promise.all([
                loadStats(),
                loadBrokers(),
                loadPortfolios(),
                loadDemands(),
                loadMatches(),
                loadDistributions()
            ]);
            const now = new Date();
            document.getElementById('lastUpdated').textContent =
                'Son g√ºncelleme: ' + now.toLocaleTimeString('tr-TR');
        }

        async function loadStats() {
            const [brokers, portfolios, demands, connections, matches, messages] = await Promise.all([
                supabase.from('profiles').select('*', { count: 'exact', head: true }),
                supabase.from('portfolios').select('*', { count: 'exact', head: true }),
                supabase.from('demands').select('*', { count: 'exact', head: true }),
                supabase.from('network_connections').select('*', { count: 'exact', head: true }).eq('status', 'accepted'),
                supabase.from('matches').select('*', { count: 'exact', head: true }),
                supabase.from('messages').select('*', { count: 'exact', head: true }),
            ]);

            document.getElementById('statBrokers').textContent = brokers.count ?? '‚Äî';
            document.getElementById('statPortfolios').textContent = portfolios.count ?? '‚Äî';
            document.getElementById('statDemands').textContent = demands.count ?? '‚Äî';
            document.getElementById('statConnections').textContent = connections.count ?? '‚Äî';
            document.getElementById('statMatches').textContent = matches.count ?? '‚Äî';
            document.getElementById('statMessages').textContent = messages.count ?? '‚Äî';
        }

        // Broker pagination state
        let brokersPage = 0;
        const brokersPerPage = 15;
        let allBrokersLoaded = false;
        let cachedSubs = [];

        async function loadBrokers() {
            brokersPage = 0;
            allBrokersLoaded = false;
            document.getElementById('brokersList').innerHTML = '<div class="empty-state">Y√ºkleniyor...</div>';
            await fetchBrokersPage(true);
            await loadTierStats();
        }

        async function loadMoreBrokers() {
            brokersPage++;
            await fetchBrokersPage(false);
        }

        async function fetchBrokersPage(reset) {
            const from = brokersPage * brokersPerPage;
            const to = from + brokersPerPage - 1;

            const { data: profiles, count } = await supabase
                .from('profiles')
                .select('id, name, company, title, avatar_url, created_at', { count: 'exact' })
                .order('created_at', { ascending: false })
                .range(from, to);

            document.getElementById('brokersCount').textContent = count ?? 0;
            const el = document.getElementById('brokersList');
            const loadMoreEl = document.getElementById('brokersLoadMore');

            if (!profiles || profiles.length === 0) {
                if (reset) el.innerHTML = '<div class="empty-state">Hen√ºz broker yok</div>';
                loadMoreEl.style.display = 'none';
                return;
            }

            // Fetch subscriptions for this page
            const userIds = profiles.map(p => p.id);
            const { data: subs } = await supabase
                .from('user_subscriptions')
                .select('user_id, tier, demands_used, portfolios_used')
                .in('user_id', userIds);

            const data = profiles.map(p => {
                const sub = subs?.find(s => s.user_id === p.id) || { tier: 'free', demands_used: 0, portfolios_used: 0 };
                return { ...p, sub };
            });

            const tierLabels = { free: '√úcretsiz', pro: 'Pro', enterprise: 'Enterprise' };
            const tierColors = {
                free: 'background:#e5e7eb;color:#374151',
                pro: 'background:#2563eb;color:#fff',
                enterprise: 'background:#f59e0b;color:#fff'
            };

            const html = data.map(b => {
                const sub = b.sub;
                const tierLimit = sub.tier === 'free' ? 2 : sub.tier === 'pro' ? 10 : 50;
                return `
            <div class="table-row" style="flex-wrap:wrap;gap:6px;">
                <div class="avatar">
                    ${b.avatar_url
                        ? `<img src="${escapeHTML(b.avatar_url)}" alt="">`
                        : escapeHTML((b.name?.charAt(0) || '?').toUpperCase())
                    }
                </div>
                <div class="row-info">
                    <div class="row-name">${escapeHTML(b.name || 'ƒ∞simsiz')}</div>
                    <div class="row-sub">${escapeHTML(b.company || b.title || 'Broker')} &nbsp;¬∑&nbsp;
                        T:${sub.demands_used}/${tierLimit} &nbsp;P:${sub.portfolios_used}/${tierLimit}
                    </div>
                </div>
                <span style="font-size:11px;font-weight:700;padding:3px 8px;border-radius:6px;${tierColors[sub.tier] || tierColors.free}">
                    ${escapeHTML(tierLabels[sub.tier] || '√úcretsiz')}
                </span>
                <select onchange="updateTier('${b.id}', this.value)" style="font-size:11px;border:1px solid #334155;background:#1e293b;color:#e2e8f0;border-radius:6px;padding:2px 6px;cursor:pointer;">
                    <option value="" disabled selected>Tier Deƒüi≈ütir</option>
                    <option value="free">√úcretsiz</option>
                    <option value="pro">Pro</option>
                    <option value="enterprise">Enterprise</option>
                </select>
                <button onclick="resetQuota('${b.id}')" style="font-size:10px;background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.3);color:#f87171;padding:3px 8px;border-radius:6px;cursor:pointer;">Kotayƒ± Sƒ±fƒ±rla</button>
            </div>`;
            }).join('');

            if (reset) {
                el.innerHTML = html;
            } else {
                el.insertAdjacentHTML('beforeend', html);
            }

            // Show or hide Load More button (if we got less than requested, no more)
            if (profiles.length < brokersPerPage) {
                loadMoreEl.style.display = 'none';
            } else {
                loadMoreEl.style.display = 'block';
            }
        }

        async function loadTierStats() {
            const { data, error } = await supabase.rpc('admin_get_tier_stats');
            if (error || !data) return;
            document.getElementById('tierFreeCount').textContent = data.free ?? 0;
            document.getElementById('tierProCount').textContent = data.pro ?? 0;
            document.getElementById('tierEnterpriseCount').textContent = data.enterprise ?? 0;
        }

        function renderDistList(el, rows, labelFn, countKey) {
            if (!rows || rows.length === 0) {
                el.innerHTML = '<span style="color:#475569">Veri yok</span>';
                return;
            }
            const max = rows[0][countKey];
            el.innerHTML = rows.map(r => {
                const pct = Math.round((r[countKey] / max) * 100);
                return `<div style="margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
                        <span style="color:#cbd5e1;font-size:12px;">${escapeHTML(labelFn(r))}</span>
                        <span style="color:#60a5fa;font-weight:700;font-size:12px;">${r[countKey]}</span>
                    </div>
                    <div style="background:rgba(255,255,255,0.07);border-radius:4px;height:5px;">
                        <div style="background:linear-gradient(90deg,#3b82f6,#818cf8);border-radius:4px;height:5px;width:${pct}%;"></div>
                    </div>
                </div>`;
            }).join('');
        }

        async function loadDistributions() {
            const [brokerRes, porRes, demRes] = await Promise.all([
                supabase.rpc('admin_get_broker_distribution'),
                supabase.rpc('admin_get_portfolio_distribution'),
                supabase.rpc('admin_get_demand_distribution')
            ]);

            renderDistList(
                document.getElementById('brokerDistList'),
                brokerRes.data,
                r => `${r.city} / ${r.district}`,
                'broker_count'
            );
            renderDistList(
                document.getElementById('portfolioDistList'),
                porRes.data,
                r => r.city,
                'portfolio_count'
            );
            renderDistList(
                document.getElementById('demandDistList'),
                demRes.data,
                r => r.city,
                'demand_count'
            );
        }

        async function loadPortfolios() {
            const { data, count } = await supabase
                .from('portfolios')
                .select('id, title, city, district, category, type, price, created_at, profiles(name)', { count: 'exact' })
                .order('created_at', { ascending: false })
                .limit(10);

            document.getElementById('portfoliosCount').textContent = count ?? 0;
            const el = document.getElementById('portfoliosList');

            if (!data || data.length === 0) {
                el.innerHTML = '<div class="empty-state">Hen√ºz portf√∂y yok</div>';
                return;
            }

            el.innerHTML = data.map(p => `
            <div class="table-row">
                <div class="avatar" style="background: linear-gradient(135deg, #059669, #10b981); border-radius: 10px;">üè¢</div>
                <div class="row-info">
                    <div class="row-name">${escapeHTML(p.title || 'Ba≈ülƒ±ksƒ±z')}</div>
                    <div class="row-sub">${escapeHTML(p.profiles?.name || '‚Äî')} ¬∑ ${escapeHTML(p.district || '')} ${escapeHTML(p.city || '')}</div>
                </div>
                <span class="row-badge badge-green">${escapeHTML(p.type || '‚Äî')}</span>
            </div>
        `).join('');
        }

        async function loadDemands() {
            const { data, count } = await supabase
                .from('demands')
                .select('id, title, city, district, category, budget, max_budget, created_at, profiles(name)', { count: 'exact' })
                .order('created_at', { ascending: false })
                .limit(10);

            document.getElementById('demandsCount').textContent = count ?? 0;
            const el = document.getElementById('demandsList');

            if (!data || data.length === 0) {
                el.innerHTML = '<div class="empty-state">Hen√ºz talep yok</div>';
                return;
            }

            el.innerHTML = data.map(d => `
            <div class="table-row">
                <div class="avatar" style="background: linear-gradient(135deg, #7c3aed, #8b5cf6); border-radius: 10px;">üìã</div>
                <div class="row-info">
                    <div class="row-name">${escapeHTML(d.title || 'Ba≈ülƒ±ksƒ±z')}</div>
                    <div class="row-sub">${escapeHTML(d.profiles?.name || '‚Äî')} ¬∑ ${escapeHTML(d.district || '')} ${escapeHTML(d.city || '')}</div>
                </div>
                <span class="row-badge badge-purple">${formatBudget(d.budget)}</span>
            </div>
        `).join('');
        }

        async function loadMatches() {
            const { data, count } = await supabase
                .from('matches')
                .select('id, status, created_at, demands(title, profiles(name)), portfolios(title)', { count: 'exact' })
                .order('created_at', { ascending: false })
                .limit(10);

            document.getElementById('matchesCount').textContent = count ?? 0;
            const el = document.getElementById('matchesList');

            if (!data || data.length === 0) {
                el.innerHTML = '<div class="empty-state">Hen√ºz e≈üle≈üme yok</div>';
                return;
            }

            const statusMap = {
                pending: { label: 'Bekliyor', cls: 'badge-orange' },
                approved: { label: 'Onaylandƒ±', cls: 'badge-green' },
                rejected: { label: 'Reddedildi', cls: 'badge-blue' },
            };

            el.innerHTML = data.map(m => {
                const s = statusMap[m.status] || { label: m.status, cls: 'badge-blue' };
                return `
            <div class="table-row">
                <div class="avatar" style="background: linear-gradient(135deg, #0891b2, #06b6d4); border-radius: 10px;">üîó</div>
                <div class="row-info">
                    <div class="row-name">${escapeHTML(m.demands?.title || 'Talep')}</div>
                    <div class="row-sub">${escapeHTML(m.demands?.profiles?.name || '‚Äî')} ¬∑ ${escapeHTML(m.portfolios?.title || 'Portf√∂y')}</div>
                </div>
                <span class="row-badge ${s.cls}">${escapeHTML(s.label)}</span>
            </div>`;
            }).join('');
        }

        // ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function formatDate(dateStr) {
            if (!dateStr) return '‚Äî';
            const d = new Date(dateStr);
            return d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' });
        }

        function formatBudget(val) {
            if (!val) return '‚Äî';
            if (val >= 1000000) return (val / 1000000).toFixed(1) + 'M';
            if (val >= 1000) return (val / 1000).toFixed(0) + 'K';
            return val.toString();
        }

        async function updateTier(userId, newTier) {
            if (!newTier) return;
            const { error } = await supabase.rpc('admin_update_tier', { target_user_id: userId, new_tier: newTier });
            if (error) {
                alert('Tier g√ºncellenemedi: ' + error.message);
            } else {
                await loadBrokers();
            }
        }

        async function resetQuota(userId) {
            if (!confirm('Bu kullanƒ±cƒ±nƒ±n aylƒ±k kotasƒ±nƒ± sƒ±fƒ±rlamak istediƒüinizden emin misiniz?')) return;
            const { error } = await supabase.rpc('admin_reset_quota', { target_user_id: userId });
            if (error) {
                alert('Kota sƒ±fƒ±rlanamadƒ±: ' + error.message);
            } else {
                await loadBrokers();
                alert('Kota ba≈üarƒ±yla sƒ±fƒ±rlandƒ±!');
            }
        }

        function startAutoRefresh() {
            clearInterval(autoRefreshTimer);
            autoRefreshTimer = setInterval(loadAll, 30000); // 30 saniye
        }
    </script>
</body>

</html>